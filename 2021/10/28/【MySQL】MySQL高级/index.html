<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="MySQL 逻辑架构          Connectors：指的是不同语言中与SQL的交互。 Connection Pool：管理缓冲用户连接，线程处理等需要缓存的需求。MySQL数据库的连接层。 Management Serveices &amp; Utilities：系统管理和控制工具。备份、安全、复制、集群等等。。 SQL Interface：接">
<meta property="og:type" content="article">
<meta property="og:title" content="【MySQL】MySQL 高级">
<meta property="og:url" content="http://yuyun-zhao.github.io/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/index.html">
<meta property="og:site_name" content="yuyun zhao&#39;s blog">
<meta property="og:description" content="MySQL 逻辑架构          Connectors：指的是不同语言中与SQL的交互。 Connection Pool：管理缓冲用户连接，线程处理等需要缓存的需求。MySQL数据库的连接层。 Management Serveices &amp; Utilities：系统管理和控制工具。备份、安全、复制、集群等等。。 SQL Interface：接">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20210913132511709.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20180831173911997">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20200801165252510.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211106205418314.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20200801170442428.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1.jpg">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20180919131632347.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553905621992-1635924540829.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20210421122919994.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103162756082.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103162815546.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554385956215.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103163018500.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103163115103.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/2020080616050355.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20210421122919994.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1556455943670.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1555325632715.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1555326108697.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103165212348.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553993244446.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553993537874.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554079717375.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554080016778.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554095452022.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554118609489.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554118675264.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554125506938.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554128184632.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554128089851.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130333472.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130448709.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130532577.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130669360.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130856485.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1-1635929423937.jpg">
<meta property="article:published_time" content="2021-10-28T08:18:38.000Z">
<meta property="article:modified_time" content="2021-11-06T12:54:30.952Z">
<meta property="article:author" content="yuyun zhao">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yuyun-zhao.github.io/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20210913132511709.png"><title>【MySQL】MySQL 高级 | yuyun zhao's blog</title><link ref="canonical" href="http://yuyun-zhao.github.io/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">文章</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">yuyun zhao's blog</div><div class="header-banner-info__subtitle">no code no life</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">【MySQL】MySQL 高级</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-10-28</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-11-06</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">10.7k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">65分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20210913132511709.png" alt="image-20210913132511709" /></p>

        <h2 id="mysql-逻辑架构"   >
          <a href="#mysql-逻辑架构" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-逻辑架构"></a> MySQL 逻辑架构</h2>
      
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20180831173911997" alt="MySQL逻辑架构" /></p>
<ul>
<li><code>Connectors</code>：指的是不同语言中与SQL的交互。</li>
<li><code>Connection Pool</code>：管理缓冲用户连接，线程处理等需要缓存的需求。<strong>MySQL数据库的连接层</strong>。</li>
<li><code>Management Serveices &amp; Utilities</code>：系统管理和控制工具。备份、安全、复制、集群等等。。</li>
<li><code>SQL Interface</code>：接受用户的SQL命令，并且返回用户需要查询的结果。</li>
<li><code>Parser</code>：SQL语句解析器。</li>
<li><code>Optimizer</code>：查询优化器，SQL语句在查询之前会使用查询优化器对查询进行优化。<strong>就是优化客户端请求query</strong>，根据客户端请求的 query 语句，和数据库中的一些统计信息，在一系列算法的基础上进行分析，得出一个最优的策略，告诉后面的程序如何取得这个 query 语句的结果。<strong>For Example</strong>： <code>select uid,name from user where gender = 1;</code>这个<code>select</code>查询先根据<code>where</code>语句进行选取，而不是先将表全部查询出来以后再进行<code>gender</code>过滤；然后根据<code>uid</code>和<code>name</code>进行属性投影，而不是将属性全部取出以后再进行过滤。最后将这两个查询条件联接起来生成最终查询结果。</li>
<li><code>Caches &amp; Buffers</code>：查询缓存。</li>
<li><code>Pluggable Storage Engines</code>：<strong>可插拔的存储引擎接口。MySQL区别于其他数据库的最重要的特点就是其插件式的表存储引擎(注意：存储引擎是基于表的，而不是数据库)。</strong></li>
<li><code>File System</code>：数据落地到磁盘上，就是文件的存储。</li>
</ul>
<p>MySQL数据库和其他数据库相比，MySQL有点与众不同，主要体现在存储引擎的架构上，<strong>插件式的存储引擎架构将查询处理和其他的系统任务以及数据的存储提取相分离</strong>。这种架构可以根据业务的需求和实际需求选择合适的存储引擎。</p>
<span id="more"></span>
<blockquote>
<p>逻辑架构分层</p>
</blockquote>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20200801165252510.png" alt="MySQL逻辑架构" /></p>
<ul>
<li><strong>连接层</strong>：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于<code>tcp/ip</code>的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于<code>SSL</code>的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</li>
<li><strong>服务层</strong>：MySQL的核心服务功能层，该层是MySQL的核心，包括查询缓存，解析器，解析树，预处理器，查询优化器。主要进行查询解析、分析、查询缓存、内置函数、存储过程、触发器、视图等，select操作会先检查是否命中查询缓存，命中则直接返回缓存数据，否则解析查询并创建对应的解析树。</li>
<li><strong>引擎层</strong>：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。</li>
<li><strong>存储层</strong>：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</li>
</ul>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211106205418314.png" alt="image-20211106205418314" /></p>

        <h2 id="存储引擎"   >
          <a href="#存储引擎" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#存储引擎"></a> 存储引擎</h2>
      
<blockquote>
<p><strong>存储引擎是对一张表而言</strong>，而非对数据库而言，不同的表可以有不同的存储引擎（可以在 CREATE 语句中指定存储引擎类型）</p>
</blockquote>
<p>存储引擎即一张表在数据库中的存储方式。</p>
<div class="table-container"><table>
<thead>
<tr>
<th></th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>事务支持</td>
<td>不支持（最新版支持）</td>
<td>支持</td>
</tr>
<tr>
<td>数据行表锁</td>
<td>不支持行锁，只支持表锁</td>
<td>支持行锁</td>
</tr>
<tr>
<td>外键约束</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持</td>
<td>不支持（最新版支持）</td>
</tr>
<tr>
<td>表空间的大小</td>
<td>较小</td>
<td>较大，约为2倍</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引</td>
<td>不仅缓存索引，还要缓存真实数据</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
</tbody>
</table></div>
<ul>
<li><strong>MyISAM</strong>：<strong>可被转换为压缩、只读表来节省空间</strong>。节约空间，速度较快</li>
<li><strong>InnoDB</strong>：安全性高，支持<strong>事务</strong>的处理，多表多用户操作，在MySQL服务器<strong>崩溃后提供自动恢复</strong>，支持级联删除和更新</li>
<li><strong>MEMORY</strong>：查询速度<strong>最快</strong>，<strong>表数据和索引</strong>被存储在<strong>内存</strong>中，不支持事务，数据容易丢失。不能包含TEXT或BLOB字段</li>
</ul>
<blockquote>
<p>在物理空间存在的位置</p>
</blockquote>
<p>所有数据库文件都存在data目录下，一个文件夹就是一个数据库，本质还是文件的存储。MySQL引擎在物理文件上的区别：</p>
<ul>
<li>InnoDB：
<ul>
<li><code>*.frm</code>  表结构的定义文件</li>
<li><code>*.ibd</code> 数据和索引共同存储在一个文件中</li>
</ul>
</li>
<li>MyISAM：
<ul>
<li><code>*.frm</code>  表结构的定义文件</li>
<li><code>*.MYD</code> 数据文件（data）</li>
<li><code>*.MYI</code>  索引文件（index）</li>
</ul>
</li>
</ul>
<blockquote>
<p>其中，InnDB 采用聚集（聚数）索引（索引和真实数据存储在一起），MyISAM 采用非聚集（稀疏）索引（索引和真实数据分开存储），这才导致了二者在磁盘上存储文件类型的区别。</p>
</blockquote>
<p>三种存储引擎的适用条件：</p>
<ul>
<li>MyISAM：适用于大量的数据读而少量数据更新的混合操作（因为是加的表锁），另一种适用情形是使用压缩的只读表</li>
<li>InnoDB：适用于查询中包含较多的数据更新操作，其行级锁机制和多版本的支持为数据读取和更新的混合操作提供了良好的并发机制</li>
<li>MEMORY：适用于存储非永久需要的数据，或者是能够从基于磁盘的表中重新生成的数据</li>
</ul>
<p>存储引擎中索引的实现见<a href="https://yuyun-zhao.github.io/2021/10/27/%E3%80%90MySQL%E3%80%91MySQL%E7%B4%A2%E5%BC%95/">【MySQL】MySQL 索引</a>。</p>

        <h3 id="存储引擎的选择"   >
          <a href="#存储引擎的选择" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#存储引擎的选择"></a> 存储引擎的选择</h3>
      
<p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。以下是几种常用的存储引擎的使用环境。</p>
<ul>
<li>InnoDB：是 MySQL 默认存储引擎，用于事务处理应用程序，支持外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询意外，还包含很多的更新、删除操作，那么InnoDB存储引擎是比较合适的选择。InnoDB存储引擎除了有效的降低由于删除和更新导致的锁定， 还可以确保事务的完整提交和回滚，对于类似于计费系统或者财务系统等对数据准确性要求比较高的系统，InnoDB是最合适的选择。</li>
<li>MyISAM：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的。</li>
<li>MEMORY：将所有数据保存在RAM中，在需要快速定位记录和其他类似数据环境下，可以提供几块的访问。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，其次是要确保表的数据可以恢复，数据库异常终止后表中的数据是可以恢复的。MEMORY表通常用于更新不太频繁的小表，用以快速得到访问结果。</li>
<li>MERGE：用于将一系列等同的MyISAM表以逻辑方式组合在一起，并作为一个对象引用他们。MERGE表的优点在于可以突破对单个MyISAM表的大小限制，并且通过将不同的表分布在多个磁盘上，可以有效的改善MERGE表的访问效率。这对于存储诸如数据仓储等VLDB环境十分合适。</li>
</ul>

        <h3 id="innobd-相比-myisam-的优点"   >
          <a href="#innobd-相比-myisam-的优点" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#innobd-相比-myisam-的优点"></a> InnoBD 相比 MyISAM 的优点</h3>
      
<ul>
<li>支持事务</li>
<li>支持行锁，并发性较好，适合大量写请求的高并发场景</li>
<li>索引数据和实际数据是分开存储的，所以相同大小的页结构中存储的索引数量更多</li>
</ul>
<p>MyISAM 适合大量读操作，少量写操作，这种情况下性能较高。</p>

        <h3 id="存储引擎相关命令"   >
          <a href="#存储引擎相关命令" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#存储引擎相关命令"></a> 存储引擎相关命令</h3>
      
<p><code>show engines;</code> 命令查看MySQL 5.7 支持的存储引擎。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show engines;</span></span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20200801170442428.png" alt="存储引擎" /></p>
<p><code>show variables like 'default_storage_engine%';</code> 查看当前数据库正在使用的存储引擎。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show variables like <span class="string">&#x27;default_storage_engine%&#x27;</span>;</span></span><br><span class="line">+------------------------+--------+</span><br><span class="line">| Variable_name          | Value  |</span><br><span class="line">+------------------------+--------+</span><br><span class="line">| default_storage_engine | InnoDB |</span><br><span class="line">+------------------------+--------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></div></figure>
<!-- More -->

        <h2 id="mysql-性能优化"   >
          <a href="#mysql-性能优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-性能优化"></a> MySQL 性能优化</h2>
      
<p>MySQL 性能下降的原因：</p>
<ul>
<li>查询语句写的差</li>
<li>索引失效：索引建了，但是没有使用</li>
<li>联表查询太多（设计缺陷或者不得已的需求）</li>
<li>服务器调优以及各个参数的设置（缓冲、线程数等）</li>
</ul>
<p>下面介绍一些常用的优化手段。</p>

        <h3 id="索引优化"   >
          <a href="#索引优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#索引优化"></a> 索引优化</h3>
      
<p>关于 MySQL 索引优化的分析见文章<a href="https://yuyun-zhao.github.io/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E7%B4%A2%E5%BC%95/">【MySQL】MySQL 索引</a>。</p>

        <h3 id="应用优化使用连接池"   >
          <a href="#应用优化使用连接池" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#应用优化使用连接池"></a> 应用优化：使用连接池</h3>
      
<p>对于访问数据库来说，建立连接的代价是比较昂贵的，因为我们频繁的创建关闭连接，是比较耗费资源的，我们有必要建立 数据库连接池，以提高访问的性能。</p>
<p><strong>1、避免对数据进行重复检索</strong></p>
<p>在编写应用代码时，需要能够理清对数据库的访问逻辑。能够一次连接就获取到结果的，就不用两次连接，这样可以大大减少对数据库无用的重复请求。</p>
<p>比如 ，需要获取书籍的 id 和 name 字段， 则查询如下：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id , name <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></div></figure>
<p>之后，在业务逻辑中有需要获取到书籍状态信息， 则查询如下：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, status <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></div></figure>
<p>这样，就需要向数据库提交两次请求，数据库就要做两次查询操作。其实完全可以用一条SQL语句得到想要的结果。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, name, status <span class="keyword">from</span> tb_book;</span><br></pre></td></tr></table></div></figure>
<p><strong>2、增加 cache 层</strong></p>
<p>在应用中，我们可以在应用中增加<strong>缓存层</strong>来达到减轻数据库负担的目的。缓存层有很多种，也有很多实现方式，只要能达到降低数据库的负担又能满足应用需求就可以。</p>
<p>因此可以部分数据从数据库中抽取出来放到应用端以文本方式存储， 或者使用框架（Mybatis, Hibernate）提供的一级缓存/二级缓存，或者使用Redis数据库来缓存数据 。</p>

        <h3 id="应用优化负载均衡"   >
          <a href="#应用优化负载均衡" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#应用优化负载均衡"></a> 应用优化：负载均衡</h3>
      
<p>负载均衡是应用中使用非常普遍的一种优化方法，它的机制就是利用某种均衡算法，将固定的负载量分布到不同的服务器上， 以此来降低单台服务器的负载，达到优化的效果。</p>
<p><strong>1、利用 MySQL 复制分流查询</strong></p>
<p>通过MySQL的主从复制，实现读写分离，使增删改操作走主节点，查询操作走从节点，从而可以降低单台服务器的读写压力。</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1.jpg" alt="1" /></p>
<p><strong>2、采用分布式数据库架构</strong></p>
<p>分布式数据库架构适合大数据量、负载高的情况，它有良好的拓展性和高可用性。通过在多台服务器之间分布数据，可以实现在多台服务器之间的负载均衡，提高访问效率。</p>

        <h3 id="查询缓存优化"   >
          <a href="#查询缓存优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#查询缓存优化"></a> 查询缓存优化</h3>
      
<blockquote>
<p>高版本的 MySQL 取消了查询缓存的功能（因为会降低 MySQL 的性能），一般使用 Redis 等缓存中间件实现查询缓存。</p>
</blockquote>
<p>开启 MySQL 的查询缓存，当执行完全相同的 SQL 语句的时候，服务器就会直接从缓存中读取结果，当数据被修改，之前的缓存会失效，修改比较频繁的表不适合做查询缓存。</p>
<p>操作流程：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20180919131632347.png" alt="20180919131632347" /></p>
<ol>
<li>客户端发送一条查询给服务器；</li>
<li>服务器先会检查查询缓存，如果命中了缓存，则立即返回存储在缓存中的结果。否则进入下一阶段；</li>
<li>服务器端进行SQL解析、预处理，再由优化器生成对应的执行计划；</li>
<li>MySQL根据优化器生成的执行计划，调用存储引擎的API来执行查询；</li>
<li>将结果返回给客户端。</li>
</ol>

        <h3 id="内存管理及优化"   >
          <a href="#内存管理及优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内存管理及优化"></a> 内存管理及优化</h3>
      

        <h4 id="内存优化原则"   >
          <a href="#内存优化原则" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内存优化原则"></a> 内存优化原则</h4>
      
<ul>
<li>将尽量多的内存分配给MySQL做缓存，但要给操作系统和其他程序预留足够内存。</li>
<li>MyISAM 存储引擎的数据文件读取依赖于操作系统自身的IO缓存，因此，如果有MyISAM表，就要预留更多的内存给操作系统做IO缓存。</li>
<li>排序区、连接区等缓存是分配给每个数据库会话（session）专用的，其默认值的设置要根据最大连接数合理分配，如果设置太大，不但浪费资源，而且在并发连接较高时会导致物理内存耗尽。</li>
</ul>

        <h4 id="myisam-内存优化"   >
          <a href="#myisam-内存优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#myisam-内存优化"></a> MyISAM 内存优化</h4>
      
<p>MyISAM 存储引擎使用 key_buffer 缓存索引块，加速 MyISAM 索引的读写速度。对于 MyISAM 表的数据块，MySQL 没有特别的缓存机制，完全依赖于操作系统的IO缓存。</p>
<p><strong>key_buffer_size</strong></p>
<p>key_buffer_size决定MyISAM索引块缓存区的大小，直接影响到MyISAM表的存取效率。可以在MySQL参数文件中设置key_buffer_size的值，对于一般MyISAM数据库，建议至少将1/4可用内存分配给key_buffer_size。</p>
<p>在<code>/usr/my.cnf</code> 中做如下配置：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key_buffer_size&#x3D;512M</span><br></pre></td></tr></table></div></figure>
<p><strong>read_buffer_size</strong></p>
<p>如果需要经常顺序扫描 MyISAM 表，可以通过增大read_buffer_size的值来改善性能。但需要注意的是read_buffer_size是每个session独占的，如果默认值设置太大，就会造成内存浪费。</p>
<p><strong>read_rnd_buffer_size</strong></p>
<p>对于需要做排序的 MyISAM 表的查询，如带有order by子句的sql，适当增加 read_rnd_buffer_size 的值，可以改善此类的sql性能。但需要注意的是 read_rnd_buffer_size 是每个session独占的，如果默认值设置太大，就会造成内存浪费。</p>

        <h4 id="innodb-内存优化"   >
          <a href="#innodb-内存优化" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#innodb-内存优化"></a> InnoDB 内存优化</h4>
      
<p>Innodb用一块内存区做IO缓存池，该缓存池不仅用来缓存innodb的索引块，而且也用来缓存innodb的数据块。</p>
<p><strong>innodb_buffer_pool_size</strong></p>
<p>该变量决定了 innodb 存储引擎表数据和索引数据的最大缓存区大小。在保证操作系统及其他程序有足够内存可用的情况下，innodb_buffer_pool_size 的值越大，缓存命中率越高，访问InnoDB表需要的磁盘I/O 就越少，性能也就越高。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_buffer_pool_size&#x3D;512M</span><br></pre></td></tr></table></div></figure>
<p><strong>innodb_log_buffer_size</strong></p>
<p>决定了innodb重做日志缓存的大小，对于可能产生大量更新记录的大事务，增加innodb_log_buffer_size的大小，可以避免innodb在事务提交前就执行不必要的日志写入磁盘操作。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_log_buffer_size&#x3D;10M</span><br></pre></td></tr></table></div></figure>

        <h3 id="并发参数调整"   >
          <a href="#并发参数调整" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#并发参数调整"></a> 并发参数调整</h3>
      
<p>从实现上来说，MySQL Server 是多线程结构，包括后台线程和客户服务线程。多线程可以有效利用服务器资源，提高数据库的并发性能。在Mysql中，控制并发连接和线程的主要参数包括 max_connections、back_log、thread_cache_size、table_open_cahce。</p>
<p><strong>max_connections</strong></p>
<p>采用max_connections 控制允许连接到MySQL数据库的最大数量，默认值是 151。如果状态变量 connection_errors_max_connections 不为零，并且一直增长，则说明不断有连接请求因数据库连接数已达到允许最大值而失败，这是可以考虑增大 max_connections 的值。</p>
<p>MySQL 最大可支持的连接数，取决于很多因素，包括给定操作系统平台的线程库的质量、内存大小、每个连接的负荷、CPU的处理速度，期望的响应时间等。在Linux 平台下，性能好的服务器，支持 500-1000 个连接不是难事，需要根据服务器性能进行评估设定。</p>

        <h4 id="back_log"   >
          <a href="#back_log" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#back_log"></a> back_log</h4>
      
<p>back_log 参数控制MySQL监听TCP端口时设置的积压请求栈大小。如果MySql的连接数达到max_connections时，新来的请求将会被存在堆栈中，以等待某一连接释放资源，该堆栈的数量即back_log，如果等待连接的数量超过back_log，将不被授予连接资源，将会报错。5.6.6 版本之前默认值为 50 ， 之后的版本默认为 <code>50 + (max_connections / 5)</code>， 但最大不超过900。</p>
<p>如果需要数据库在较短的时间内处理大量连接请求， 可以考虑适当增大back_log 的值。</p>

        <h4 id="table_open_cache"   >
          <a href="#table_open_cache" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#table_open_cache"></a> table_open_cache</h4>
      
<p>该参数用来控制所有SQL语句执行线程可打开表缓存的数量， 而在执行SQL语句时，每一个SQL执行线程至少要打开 1 个表缓存。该参数的值应该根据设置的最大连接数 max_connections 以及每个连接执行关联查询中涉及的表的最大数量来设定 ：<code>max_connections x N</code></p>

        <h4 id="thread_cache_size"   >
          <a href="#thread_cache_size" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#thread_cache_size"></a> thread_cache_size</h4>
      
<p>为了加快连接数据库的速度，MySQL 会缓存一定数量的客户服务线程以备重用，通过参数 thread_cache_size 可控制 MySQL 缓存客户服务线程的数量。</p>

        <h4 id="innodb_lock_wait_timeout"   >
          <a href="#innodb_lock_wait_timeout" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#innodb_lock_wait_timeout"></a> innodb_lock_wait_timeout</h4>
      
<p>该参数是用来设置InnoDB 事务等待行锁的时间，默认值是50ms ， 可以根据需要进行动态设置。对于需要快速反馈的业务系统来说，可以将行锁的等待时间调小，以避免事务长时间挂起； 对于后台运行的批量处理程序来说， 可以将行锁的等待时间调大， 以避免发生大的回滚操作。</p>

        <h2 id="mysql-锁"   >
          <a href="#mysql-锁" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-锁"></a> MySQL 锁</h2>
      
<p>从对数据操作的粒度分：</p>
<ul>
<li>表锁：操作时，会锁定整个表。</li>
<li>行锁：操作时，会锁定当前操作行。</li>
</ul>
<p>从对数据操作的类型分：</p>
<ul>
<li>读锁（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li>
<li>写锁（排它锁）：当前操作没有完成之前，它会阻断其他写锁和读锁。</li>
</ul>
<p>相对其他数据库而言，MySQL的锁机制比较简单，其最显著的特点是不同的存储引擎支持不同的锁机制。下表中罗列出了各存储引擎对锁的支持情况：</p>
<div class="table-container"><table>
<thead>
<tr>
<th>存储引擎</th>
<th>表级锁</th>
<th>行级锁</th>
<th>页面锁</th>
</tr>
</thead>
<tbody>
<tr>
<td>MyISAM</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>InnoDB</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>MEMORY</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>BDB</td>
<td>支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
</tbody>
</table></div>
<p>MySQL这3种锁的特性可大致归纳如下 ：</p>
<div class="table-container"><table>
<thead>
<tr>
<th>锁类型</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>表级锁</td>
<td>偏向 MyISAM 存储引擎，开销小，加锁快；不会出现死锁；锁定粒度大，发生锁冲突的概率最高，并发度最低。</td>
</tr>
<tr>
<td>行级锁</td>
<td>偏向 InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</td>
</tr>
<tr>
<td>页面锁</td>
<td>开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般。</td>
</tr>
</tbody>
</table></div>
<p>从上述特点可见，很难笼统地说哪种锁更好，只能就具体应用的特点来说哪种锁更合适。仅从锁的角度来说：<strong>表级锁更适合于以查询为主</strong>，只有少量按索引条件更新数据的应用，如Web 应用；而<strong>行级锁则更适合于有大量按索引条件并发更新少量不同数据，同时又有并发查询的应用</strong>，如一些在线事务处理（OLTP）系统。</p>

        <h3 id="myisam-表锁"   >
          <a href="#myisam-表锁" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#myisam-表锁"></a> MyISAM 表锁</h3>
      
<p>MyISAM 存储引擎只支持表锁，这也是MySQL开始几个版本中唯一支持的锁类型。MyISAM：</p>
<ul>
<li>在执行<strong>查询</strong>语句（SELECT）前，会<strong>自动</strong>给涉及的所有表加<strong>读锁</strong></li>
<li>在执行<strong>更新</strong>操作（UPDATE、DELETE、INSERT 等）前，会自动给涉及的表加<strong>写锁</strong></li>
</ul>
<p>这个过程并不需要用户干预，自动在执行前加锁，在执行完毕后解锁。因此，用户一般不需要直接用 <code>LOCK TABLE</code> 命令给 MyISAM 表显式加锁。</p>
<p>显式加表锁语法：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">加读锁： lock <span class="keyword">table</span> table_name read;</span><br><span class="line"></span><br><span class="line">加写锁： lock <span class="keyword">table</span> table_name write；</span><br></pre></td></tr></table></div></figure>
<p>​	MyISAM 锁模式的相互兼容性如表中所示：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553905621992-1635924540829.png" alt="1553905621992" /></p>
<ul>
<li>对 MyISAM 表的<strong>读操作</strong>，不会阻塞其他用户对同一表的读请求，但<strong>会阻塞对同一表的写请求</strong>；</li>
<li>对 MyISAM 表的<strong>写操作</strong>，则<strong>会阻塞</strong>其他用户对同一表的<strong>读和写</strong>操作；</li>
</ul>
<p>简而言之，就是读锁会阻塞写，但是不会阻塞读。而写锁，则既会阻塞读，又会阻塞写。这点和 JUC 中的读写锁是一致的。</p>
<p>此外，MyISAM 的读写锁调度是写优先，这也是 MyISAM 不适合做写为主的表的存储引擎的原因。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成长期阻塞。</p>

        <h3 id="innodb-行锁"   >
          <a href="#innodb-行锁" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#innodb-行锁"></a> InnoDB 行锁</h3>
      
<blockquote>
<p><strong>使用行锁的前提是操作必须走索引</strong>，否则行锁就会变为表锁。</p>
</blockquote>
<p>行锁特点 ：偏向 InnoDB 存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。InnoDB 与 MyISAM 的最大不同有两点：一是支持事务；二是采用了行级锁。</p>
<p><strong>行锁的实现依赖于事务</strong>。必须在事务内加锁。</p>
<p>InnoDB  实现了以下两种类型的行锁。</p>
<ul>
<li><strong>共享锁</strong>（S）：又称为读锁，简称S锁，共享锁就是多个事务对于同一数据可以共享一把锁，都能访问到数据，但是只能读不能修改。</li>
<li><strong>排他锁</strong>（X）：又称为写锁，简称X锁，排他锁就是不能与其他锁并存，如一个事务获取了一个数据行的排他锁，其他事务就不能再获取该行的其他锁，包括共享锁和排他锁，但是获取排他锁的事务是可以对数据就行读取和修改。</li>
</ul>
<p>InnoDB 加锁时机：</p>
<ul>
<li>对于UPDATE、DELETE和INSERT语句，InnoDB会<strong>自动</strong>给涉及数据集加<strong>写锁</strong>；</li>
<li>对于普通SELECT语句，InnoDB <strong>不会加任何锁</strong>；</li>
<li>索引失效时<strong>行锁升级为表锁</strong></li>
</ul>
<p>自动加锁的机制：</p>
<ul>
<li>在开启事务后加上写锁</li>
<li><code>COMMIT</code> 或 <code>ROLL BACK</code> 后释放锁</li>
</ul>
<p><strong>注意</strong>：即使某一行加了锁，也不影响其他会话 SELECT 语句的查询，因为 SELECT 查询不加任何锁，可以无视其他会话加的写锁（不会阻塞）。只不过其读取不到另一个加了锁的会话修改的数据罢了（因为其加锁的会话还没提交，是无法独到它未提交的数据的）。</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20210421122919994.png" alt="image-20210421122752768" /></p>
<p>可以通过以下语句显式给记录集加共享锁或排他锁 。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">共享锁（S）：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> ... LOCK <span class="keyword">IN</span> SHARE MODE</span><br><span class="line"></span><br><span class="line">排他锁（X) ：<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">WHERE</span> ... <span class="keyword">FOR</span> UPDATE</span><br></pre></td></tr></table></div></figure>

        <h4 id="行锁基本演示"   >
          <a href="#行锁基本演示" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#行锁基本演示"></a> 行锁基本演示</h4>
      
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103162756082.png" alt="image-20211103162756082" /></p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103162815546.png" alt="image-20211103162815546" /></p>

        <h4 id="索引失效时行锁升级为表锁"   >
          <a href="#索引失效时行锁升级为表锁" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#索引失效时行锁升级为表锁"></a> 索引失效时行锁升级为表锁</h4>
      
<p>如果<strong>不通过索引条件检索数据</strong>，那么InnoDB将对表中的所有记录加锁，实际效果跟表锁一样。</p>
<p>查看当前表的索引 ： show  index  from test_innodb_lock ;</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554385956215.png" alt="1554385956215" /></p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103163018500.png" alt="image-20211103163018500" /></p>
<p>由于执行更新时，name字段本来为varchar类型， 我们是作为数组类型使用，存在类型转换，索引失效，最终行锁变为表锁 ，其他会话更新其他行数据仍然阻塞；</p>

        <h4 id="间隙锁危害"   >
          <a href="#间隙锁危害" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#间隙锁危害"></a> 间隙锁危害</h4>
      
<p>当我们使用范围条件，而不是使用相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据进行加锁； 对于键值在条件范围内但并不存在的记录，叫做 “间隙（GAP）” ， InnoDB也会对这个 “间隙” 加锁，这种锁机制就是所谓的<strong>间隙锁</strong>（Next-Key锁） 。</p>
<p><code>InnoDB</code>也会对这个&quot;间隙&quot;加锁，这种锁的机制就是所谓的&quot;间隙锁&quot;。</p>
<blockquote>
<p>间隙锁的危害</p>
</blockquote>
<p>因为执行过程中通过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值不存在。</p>
<p>间隙锁有一个比较致命的缺点，就是**当锁定一个范围的键值后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。**在某些场景下这可能会对性能造成很大的危害。</p>
<p>示例 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103163115103.png" alt="image-20211103163115103" /></p>

        <h4 id="如何锁定一行"   >
          <a href="#如何锁定一行" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#如何锁定一行"></a> 如何锁定一行</h4>
      
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/2020080616050355.png" alt="锁定一行" /></p>
<p><code>SELECT .....FOR UPDATE</code>在锁定某一行后，其他写操作会被阻塞，直到锁定的行被<code>COMMIT</code>。</p>
<p>InnoDB引擎默认的修改数据语句，update,delete,insert都会<strong>自动给涉及到的数据加上排他锁</strong>，<strong>select语句默认不会加任何锁类型</strong>，如果手动加排他锁可以使用<code>select ...for update</code>语句，手动加共享锁可以使用<code>select ... lock in share mode</code>语句。所以加过排他锁的数据行在其他事务种是不能修改数据的，也不能通过<code>for update</code>和<code>lock in share mode</code>锁的方式查询数据，但可以直接通过<code>select ...from...</code>查询数据，因为普通查询没有任何锁机制。</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/20210421122919994.png" alt="image-20210421122752768" /></p>

        <h4 id="innodb-行锁争用情况"   >
          <a href="#innodb-行锁争用情况" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#innodb-行锁争用情况"></a> InnoDB 行锁争用情况</h4>
      
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;innodb_row_lock%&#x27;</span>;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1556455943670.png" alt="1556455943670" /></p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>：当前正在等待锁定的数量。</li>
<li><code>Innodb_row_lock_time</code>：从系统启动到现在锁定总时间长度（重要）。</li>
<li><code>Innodb_row_lock_time_avg</code>：每次等待所花的平均时间（重要）。</li>
<li><code>Innodb_row_lock_time_max</code>：从系统启动到现在等待最长的一次所花的时间。</li>
<li><code>Innodb_row_lock_waits</code>：系统启动后到现在总共等待的次数（重要）。</li>
</ul>
<p>尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手制定优化策略。</p>

        <h4 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
      
<p>InnoDB存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面带来了性能损耗可能比表锁会更高一些，但是在整体并发处理能力方面要远远由于MyISAM的表锁的。当系统并发量较高的时候，InnoDB的整体性能和MyISAM相比就会有比较明显的优势。</p>
<p>但是，InnoDB的行级锁同样也有其脆弱的一面，当我们使用不当的时候，可能会让InnoDB的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</p>
<p>优化建议：</p>
<ul>
<li>尽可能让所有数据检索都能通过索引来完成，避免无索引行锁升级为表锁。</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能减少索引条件，及索引范围，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可使用低级别事务隔离（但是需要业务层面满足需求）</li>
</ul>

        <h2 id="mysql-常用工具"   >
          <a href="#mysql-常用工具" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-常用工具"></a> MySQL 常用工具</h2>
      

        <h3 id="mysql"   >
          <a href="#mysql" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql"></a> mysql</h3>
      
<p>该mysql不是指mysql服务，而是指mysql的<strong>客户端工具</strong>。语法 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql [options] [database]</span><br></pre></td></tr></table></div></figure>

        <h4 id="连接选项"   >
          <a href="#连接选项" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#连接选项"></a> 连接选项</h4>
      
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">参数 ： </span><br><span class="line">	-u, --user&#x3D;name			指定用户名</span><br><span class="line">	-p, --password[&#x3D;name]	指定密码</span><br><span class="line">	-h, --host&#x3D;name			指定服务器IP或域名</span><br><span class="line">	-P, --port&#x3D;#			指定连接端口</span><br><span class="line"></span><br><span class="line">示例 ：</span><br><span class="line">	mysql -h 127.0.0.1 -P 3306 -u root -p</span><br><span class="line">	</span><br><span class="line">	mysql -h127.0.0.1 -P3306 -uroot -p2143</span><br></pre></td></tr></table></div></figure>

        <h4 id="执行选项"   >
          <a href="#执行选项" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#执行选项"></a> 执行选项</h4>
      
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-e, --execute&#x3D;name		执行SQL语句并退出</span><br></pre></td></tr></table></div></figure>
<p>此选项可以在Mysql客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这种方式尤其方便。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line">	mysql -uroot -p2143 db01 -e &quot;select * from tb_book&quot;;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1555325632715.png" alt="1555325632715" /></p>

        <h3 id="mysqladmin"   >
          <a href="#mysqladmin" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysqladmin"></a> mysqladmin</h3>
      
<p>mysqladmin 是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。</p>
<p>可以通过 ： mysqladmin --help  指令查看帮助文档</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1555326108697.png" alt="1555326108697" /></p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">示例 ：</span><br><span class="line">	mysqladmin -uroot -p2143 create &#39;test01&#39;;  </span><br><span class="line">	mysqladmin -uroot -p2143 drop &#39;test01&#39;;</span><br><span class="line">	mysqladmin -uroot -p2143 version;</span><br></pre></td></tr></table></div></figure>

        <h3 id="mysqlbinlog"   >
          <a href="#mysqlbinlog" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysqlbinlog"></a> mysqlbinlog</h3>
      
<p>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到mysqlbinlog 日志管理工具。</p>
<p>语法 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [options]  log-files1 log-files2 ...</span><br><span class="line"></span><br><span class="line">选项：</span><br><span class="line">	-d, --database&#x3D;name : 指定数据库名称，只列出指定的数据库相关操作。</span><br><span class="line">	-o, --offset&#x3D;# : 忽略掉日志中的前n行命令。</span><br><span class="line">	-r,--result-file&#x3D;name : 将输出的文本格式日志输出到指定文件。</span><br><span class="line">	-s, --short-form : 显示简单格式， 省略掉一些信息。</span><br><span class="line">	--start-datatime&#x3D;date1  --stop-datetime&#x3D;date2 : 指定日期间隔内的所有日志。</span><br><span class="line">	--start-position&#x3D;pos1 --stop-position&#x3D;pos2 : 指定位置间隔内的所有日志。</span><br></pre></td></tr></table></div></figure>

        <h4 id="mysqldump"   >
          <a href="#mysqldump" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysqldump"></a> mysqldump</h4>
      
<p>mysqldump 客户端工具用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。</p>
<p>语法 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqldump [options] db_name [tables]</span><br><span class="line"></span><br><span class="line">mysqldump [options] --database&#x2F;-B db1 [db2 db3...]</span><br><span class="line"></span><br><span class="line">mysqldump [options] --all-databases&#x2F;-A</span><br></pre></td></tr></table></div></figure>

        <h4 id="连接选项-2"   >
          <a href="#连接选项-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#连接选项-2"></a> 连接选项</h4>
      
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">参数 ： </span><br><span class="line">	-u, --user&#x3D;name			指定用户名</span><br><span class="line">	-p, --password[&#x3D;name]	指定密码</span><br><span class="line">	-h, --host&#x3D;name			指定服务器IP或域名</span><br><span class="line">	-P, --port&#x3D;#			指定连接端口</span><br></pre></td></tr></table></div></figure>

        <h4 id="输出内容选项"   >
          <a href="#输出内容选项" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#输出内容选项"></a> 输出内容选项</h4>
      
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">参数：</span><br><span class="line">	--add-drop-database		在每个数据库创建语句前加上 Drop database 语句</span><br><span class="line">	--add-drop-table		在每个表创建语句前加上 Drop table 语句 , 默认开启 ; 不开启 (--skip-add-drop-table)</span><br><span class="line">	</span><br><span class="line">	-n, --no-create-db		不包含数据库的创建语句</span><br><span class="line">	-t, --no-create-info	不包含数据表的创建语句</span><br><span class="line">	-d --no-data			不包含数据</span><br><span class="line">	</span><br><span class="line">	-T, --tab&#x3D;name			自动生成两个文件：一个.sql文件，创建表结构的语句；</span><br><span class="line">	 						一个.txt文件，数据文件，相当于select into outfile  </span><br></pre></td></tr></table></div></figure>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">示例 ： </span><br><span class="line">	mysqldump -uroot -p2143 db01 tb_book --add-drop-database --add-drop-table &gt; a</span><br><span class="line">	</span><br><span class="line">	mysqldump -uroot -p2143 -T &#x2F;tmp test city</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/image-20211103165212348.png" alt="image-20211103165212348" /></p>

        <h4 id="mysqlimportsource"   >
          <a href="#mysqlimportsource" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysqlimportsource"></a> mysqlimport/source</h4>
      
<p>mysqlimport 是客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件。</p>
<p>语法：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport [options]  db_name  textfile1  [textfile2...]</span><br></pre></td></tr></table></div></figure>
<p>示例：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport -uroot -p2143 test &#x2F;tmp&#x2F;city.txt</span><br></pre></td></tr></table></div></figure>
<p>如果需要导入sql文件，可以使用mysql中的source 指令 :</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &#x2F;root&#x2F;tb_book.sql</span><br></pre></td></tr></table></div></figure>

        <h4 id="mysqlshow"   >
          <a href="#mysqlshow" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysqlshow"></a> mysqlshow</h4>
      
<p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。</p>
<p>语法：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlshow [options] [db_name [table_name [col_name]]]</span><br></pre></td></tr></table></div></figure>
<p>参数：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--count		显示数据库及表的统计信息（数据库，表 均可以不指定）</span><br><span class="line"></span><br><span class="line">-i			显示指定数据库或者指定表的状态信息</span><br></pre></td></tr></table></div></figure>
<p>示例：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询每个数据库的表的数量及表中记录的数量</span></span><br><span class="line">mysqlshow -uroot -p2143 --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中每个表中的字段书，及行数</span></span><br><span class="line">mysqlshow -uroot -p2143 <span class="built_in">test</span> --count</span><br><span class="line"></span><br><span class="line"><span class="comment">#查询test库中book表的详细情况</span></span><br><span class="line">mysqlshow -uroot -p2143 <span class="built_in">test</span> book --count</span><br></pre></td></tr></table></div></figure>

        <h2 id="mysql-日志"   >
          <a href="#mysql-日志" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-日志"></a> MySQL 日志</h2>
      
<p>在任何一种数据库中，都会有各种各样的日志，记录着数据库工作的方方面面，以帮助数据库管理员追踪数据库曾经发生过的各种事件。MySQL 也不例外，在 MySQL 中，有 4 种不同的日志，分别是错误日志、二进制日志（BINLOG 日志）、查询日志和慢查询日志，这些日志记录着数据库在不同方面的踪迹。</p>

        <h3 id="错误日志"   >
          <a href="#错误日志" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#错误日志"></a> 错误日志</h3>
      
<p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，可以首先查看此日志。</p>
<p>该日志是默认开启的 ， 默认存放目录为 mysql 的数据目录（var/lib/mysql）, 默认的日志文件名为  hostname.err（hostname是主机名）。</p>
<p>查看日志位置指令 ：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;log_error%&#x27;</span>;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553993244446.png" alt="1553993244446" /></p>
<p>查看日志内容 ：</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/lib/mysql/xaxh-server.err</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1553993537874.png" alt="1553993537874" /></p>

        <h3 id="二进制日志"   >
          <a href="#二进制日志" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#二进制日志"></a> 二进制日志</h3>
      

        <h4 id="概述"   >
          <a href="#概述" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#概述"></a> 概述</h4>
      
<p>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但是不包括数据查询语句。此日志对于灾难时的数据恢复起着极其重要的作用，MySQL的主从复制， 就是通过该binlog实现的。</p>
<p>二进制日志，默认情况下是没有开启的，需要到MySQL的配置文件中开启，并配置MySQL日志的格式。</p>
<p>配置文件位置：<code>/usr/my.cnf</code></p>
<p>日志存放位置：配置时，给定了文件名但是没有指定路径，日志默认写入MySQL的数据目录。</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002</span><br><span class="line">log_bin&#x3D;mysqlbin</span><br><span class="line"></span><br><span class="line"># 配置二进制日志的格式</span><br><span class="line">binlog_format&#x3D;STATEMENT</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

        <h4 id="日志格式"   >
          <a href="#日志格式" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#日志格式"></a> 日志格式</h4>
      
<p><strong>STATEMENT</strong></p>
<p>该日志格式在日志文件中记录的都是SQL语句（statement），每一条对数据进行修改的SQL都会记录在日志文件中，通过MySQL提供的mysqlbinlog工具，可以清晰的查看到每条语句的文本。主从复制的时候，从库（slave）会将日志解析为原文本，并在从库重新执行一次。</p>
<p><strong>ROW</strong></p>
<p>该日志格式在日志文件中记录的是每一行的数据变更，而不是记录SQL语句。比如，执行SQL语句 ： <code>update tb_book set status='1'</code> , 如果是STATEMENT 日志格式，在日志中会记录一行SQL文件； 如果是ROW，由于是对全表进行更新，也就是每一行记录都会发生变更，ROW 格式的日志中会记录每一行的数据变更。</p>
<p><strong>MIXED</strong></p>
<p>这是目前MySQL默认的日志格式，即混合了STATEMENT 和 ROW两种格式。默认情况下采用STATEMENT，但是在一些特殊情况下采用ROW来进行记录。MIXED 格式能尽量利用两种模式的优点，而避开他们的缺点。</p>

        <h4 id="日志读取"   >
          <a href="#日志读取" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#日志读取"></a> 日志读取</h4>
      
<p>由于日志以二进制方式存储，不能直接读取，需要用mysqlbinlog工具来查看，语法如下 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog log-file；</span><br></pre></td></tr></table></div></figure>
<p><strong>查看STATEMENT格式日志</strong></p>
<p>执行插入语句 ：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="string">&#x27;Lucene&#x27;</span>,<span class="string">&#x27;2088-05-01&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br></pre></td></tr></table></div></figure>
<p>查看日志文件 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554079717375.png" alt="1554079717375" /></p>
<ul>
<li>mysqlbin.index：该文件是日志索引文件 ， 记录日志的文件名；</li>
<li>mysqlbing.000001：日志文件</li>
</ul>
<p>查看日志内容 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog mysqlbing.000001；</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554080016778.png" alt="1554080016778" /></p>
<p><strong>查看 ROW 格式日志</strong></p>
<p>配置 :</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 配置开启binlog日志， 日志的文件前缀为 mysqlbin -----&gt; 生成的文件名如 : mysqlbin.000001,mysqlbin.000002</span><br><span class="line">log_bin&#x3D;mysqlbin</span><br><span class="line"></span><br><span class="line"># 配置二进制日志的格式</span><br><span class="line">binlog_format&#x3D;ROW</span><br></pre></td></tr></table></div></figure>
<p>插入数据 :</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_book <span class="keyword">values</span>(<span class="keyword">null</span>,<span class="string">&#x27;SpringCloud实战&#x27;</span>,<span class="string">&#x27;2088-05-05&#x27;</span>,<span class="string">&#x27;0&#x27;</span>);</span><br></pre></td></tr></table></div></figure>
<p>如果日志格式是 ROW , 直接查看数据 , 是查看不懂的 ; 可以在mysqlbinlog 后面加上参数 -vv</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog <span class="operator">-</span>vv mysqlbin<span class="number">.000002</span> </span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554095452022.png" alt="1554095452022" /></p>

        <h3 id="日志删除"   >
          <a href="#日志删除" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#日志删除"></a> 日志删除</h3>
      
<p>对于比较繁忙的系统，由于每天生成日志量大 ，这些日志如果长时间不清楚，将会占用大量的磁盘空间。下面我们将会讲解几种删除日志的常见方法 ：</p>
<p><strong>方式一</strong></p>
<p>通过 Reset Master 指令删除全部 binlog 日志，删除之后，日志编号，将从 xxxx.000001重新开始 。</p>
<p>查询之前 ，先查询下日志文件 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554118609489.png" alt="1554118609489" /></p>
<p>执行删除日志指令：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Reset Master</span><br></pre></td></tr></table></div></figure>
<p>执行之后， 查看日志文件 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554118675264.png" alt="1554118675264" /></p>
<p><strong>方式二</strong></p>
<p>执行指令 <code>purge master logs to 'mysqlbin.******'</code> ，该命令将删除  <code>******</code> 编号之前的所有日志。</p>
<p><strong>方式三</strong></p>
<p>执行指令 <code>purge master logs before 'yyyy-mm-dd hh24:mi:ss'</code> ，该命令将删除日志为 <code>&quot;yyyy-mm-dd hh24:mi:ss&quot;</code> 之前产生的所有日志 。</p>
<p><strong>方式四</strong></p>
<p>设置参数 <code>--expire_logs_days=#</code> ，此参数的含义是设置日志的过期天数， 过了指定的天数后日志将会被自动删除，这样将有利于减少DBA 管理日志的工作量。</p>
<p>配置如下 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554125506938.png" alt="1554125506938" /></p>

        <h3 id="查询日志"   >
          <a href="#查询日志" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#查询日志"></a> 查询日志</h3>
      
<p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。</p>
<p>默认情况下， 查询日志是未开启的。如果需要开启查询日志，可以设置以下配置 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 该选项用来开启查询日志 ， 可选值 ： 0 或者 1 ； 0 代表关闭， 1 代表开启 </span><br><span class="line">general_log&#x3D;1</span><br><span class="line"></span><br><span class="line"># 设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name.log </span><br><span class="line">general_log_file&#x3D;file_name</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>在配置文件 <code>/usr/my.cnf</code> 中配置如下内容 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554128184632.png" alt="1554128184632" /></p>
<p>配置完毕之后，在数据库执行以下操作 ：</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_book;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_book <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">update tb_book <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;lucene入门指南&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_book <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">8</span>;</span><br></pre></td></tr></table></div></figure>
<p>执行完毕之后， 再次来查询日志文件 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554128089851.png" alt="1554128089851" /></p>

        <h3 id="慢查询日志"   >
          <a href="#慢查询日志" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#慢查询日志"></a> 慢查询日志</h3>
      
<p>慢查询日志记录了所有执行时间超过参数 <code>long_query_time</code> 设置值并且扫描记录数不小于 <code>min_examined_row_limit</code> 的所有的SQL语句的日志。<code>long_query_time</code> 默认为 10 秒，最小为 0， 精度可以到微秒。</p>

        <h4 id="文件位置和格式"   >
          <a href="#文件位置和格式" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#文件位置和格式"></a> 文件位置和格式</h4>
      
<p>慢查询日志默认是关闭的 。可以通过两个参数来控制慢查询日志 ：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 该参数用来控制慢查询日志是否开启， 可取值： 1 和 0 ， 1 代表开启， 0 代表关闭</span><br><span class="line">slow_query_log&#x3D;1 </span><br><span class="line"></span><br><span class="line"># 该参数用来指定慢查询日志的文件名</span><br><span class="line">slow_query_log_file&#x3D;slow_query.log</span><br><span class="line"></span><br><span class="line"># 该选项用来配置查询的时间限制， 超过这个时间将认为值慢查询， 将需要进行日志记录， 默认10s</span><br><span class="line">long_query_time&#x3D;10</span><br></pre></td></tr></table></div></figure>

        <h4 id="日志的读取"   >
          <a href="#日志的读取" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#日志的读取"></a> 日志的读取</h4>
      
<p>和错误日志、查询日志一样，慢查询日志记录的格式也是纯文本，可以被直接读取。</p>
<p>1） 查询 <code>long_query_time</code> 的值。</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130333472.png" alt="1554130333472" /></p>
<p>2） 执行查询操作</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, title,price,num ,status <span class="keyword">from</span> tb_item <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130448709.png" alt="1554130448709" /></p>
<p>由于该语句执行时间很短，为0s ， 所以不会记录在慢查询日志中。</p>
<figure class="highlight sql"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb_item <span class="keyword">where</span> title <span class="keyword">like</span> <span class="string">&#x27;%阿尔卡特 (OT-927) 炭黑 联通3G手机 双卡双待165454%&#x27;</span> ;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130532577.png" alt="1554130532577" /></p>
<p>该SQL语句 ， 执行时长为 26.77s ，超过10s ， 所以会记录在慢查询日志文件中。</p>
<p>3） 查看慢查询日志文件</p>
<p>直接通过cat 指令查询该日志文件 ：</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130669360.png" alt="1554130669360" /></p>
<p>如果慢查询日志内容很多， 直接查看文件，比较麻烦， 这个时候可以借助于mysql自带的 mysqldumpslow 工具， 来对慢查询日志进行分类汇总。</p>
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1554130856485.png" alt="1554130856485" /></p>

        <h2 id="mysql-主从复制"   >
          <a href="#mysql-主从复制" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#mysql-主从复制"></a> MySQL 主从复制</h2>
      

        <h3 id="概述-2"   >
          <a href="#概述-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#概述-2"></a> 概述</h3>
      
<p>主从复制是指将主数据库的 DDL 和 DML 操作（不包含 SELECT 语句）通过<strong>二进制日志</strong>传到从库服务器中，然后在从库上对这些日志<strong>重新执行</strong>（也叫重做），从而使得从库和主库的数据保持同步。</p>
<p>MySQL支持一台主库同时向多台从库进行复制， 从库同时也可以作为其他从服务器的主库，实现链状复制。</p>
<p>主从复制特点（与Redis相似）：</p>
<ul>
<li>主库负责写操作，从库负责读操作，实现读写分离。</li>
<li>主库的数据一旦变更，从库立即更新。</li>
</ul>

        <h3 id="主从复制原理"   >
          <a href="#主从复制原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主从复制原理"></a> 主从复制原理</h3>
      
<p><img src="/images/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/1-1635929423937.jpg" alt="1554423698190" /></p>
<p>整个过程分成三步：</p>
<ul>
<li>Master 主库在事务提交时，会把数据变更（不包含 SELECT 语句）作为时间 Events 记录在二进制日志文件 Binlog 中。</li>
<li>主库推送<strong>二进制日志文件</strong> Binlog 中的日志事件到从库的<strong>中继日志</strong> Relay Log。</li>
<li>Slave<strong>重做</strong>中继日志中的事件，将改变反映它自己的数据。</li>
</ul>

        <h3 id="主从复制基本原则"   >
          <a href="#主从复制基本原则" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主从复制基本原则"></a> 主从复制基本原则</h3>
      
<ul>
<li>每个Slave只有一个Master。</li>
<li>每个Slave只能有一个唯一的服务器ID。</li>
<li>每个Master可以有多个Salve。</li>
</ul>

        <h4 id="复制优势"   >
          <a href="#复制优势" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#复制优势"></a> 复制优势</h4>
      
<p>MySQL 复制的有点主要包含以下三个方面：</p>
<ul>
<li>主库出现问题，可以快速<strong>切换到从库</strong>提供服务。</li>
<li>可以在从库上执行查询操作，从主库中更新，实现<strong>读写分离</strong>，降低主库的访问压力。</li>
<li>可以<strong>在从库中执行备份</strong>，以避免备份期间影响主库的服务。</li>
</ul>

        <h3 id="一主一从配置案例"   >
          <a href="#一主一从配置案例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#一主一从配置案例"></a> 一主一从配置案例</h3>
      
<p>1、基本要求：Master和Slave的MySQL服务器版本一致且后台以服务运行。</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建mysql-slave1实例</span></span><br><span class="line">docker run -p 3307:3306 --name mysql-slave1 \</span><br><span class="line">-v /root/mysql-slave1/log:/var/log/mysql \</span><br><span class="line">-v /root/mysql-slave1/data:/var/lib/mysql \</span><br><span class="line">-v /root/mysql-slave1/conf:/etc/mysql \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=333 \</span><br><span class="line">-d mysql:5.7</span><br></pre></td></tr></table></div></figure>
<p>2、主从配置都是配在[mysqld]节点下，都是小写</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Master配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=1 # 必须</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin # 必须</span><br><span class="line">read-only=0</span><br><span class="line">binlog-ignore-db=mysql</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Slave配置</span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id=2 # 必须</span><br><span class="line">log-bin=/var/lib/mysql/mysql-bin</span><br></pre></td></tr></table></div></figure>
<p>3、Master配置</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;从机IP地址&#x27;</span> IDENTIFIED BY <span class="string">&#x27;password&#x27;</span>;</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;zhangsan&#x27;</span>@<span class="string">&#x27;172.18.0.3&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span></span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、刷新命令</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> FLUSH PRIVILEGES;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、记录下File和Position</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次配从机的时候都要SHOW MASTER STATUS;查看最新的File和Position</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW MASTER STATUS;</span></span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| mysql-bin.000001 |      602 |              | mysql            |                   |</span><br><span class="line">+------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></div></figure>
<p>4、Slave从机配置</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;172.18.0.4&#x27;,</span><br><span class="line">MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.File的编号&#x27;,</span><br><span class="line">MASTER_LOG_POS=Position的最新值;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、使用用户名密码登录进Master</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.18.0.4&#x27;</span>,</span></span><br><span class="line">    -&gt; MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">    -&gt; MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_POS=602;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、开启Slave从机的复制</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3、查看Slave状态</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Slave_IO_Running 和 Slave_SQL_Running 必须同时为Yes 说明主从复制配置成功！</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event # Slave待命状态</span><br><span class="line">                  Master_Host: 172.18.0.4</span><br><span class="line">                  Master_User: zhangsan</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 602</span><br><span class="line">               Relay_Log_File: b030ad25d5fe-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes  </span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 602</span><br><span class="line">              Relay_Log_Space: 534</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></div></figure>
<p>5、测试主从复制</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Master创建数据库</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> create database test_replication;</span></span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Slave查询数据库</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show databases;</span></span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test_replication   |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></div></figure>
<p>6、停止主从复制功能</p>
<figure class="highlight shell"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1、停止Slave</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> STOP SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2、重新配置主从</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> MASTER_LOG_FILE 和 MASTER_LOG_POS一定要根据最新的数据来配</span></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;172.18.0.4&#x27;</span>,</span></span><br><span class="line">    -&gt; MASTER_USER=&#x27;zhangsan&#x27;,</span><br><span class="line">    -&gt; MASTER_PASSWORD=&#x27;123456&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_FILE=&#x27;mysql-bin.000001&#x27;,</span><br><span class="line">    -&gt; MASTER_LOG_POS=797;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.01 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> START SLAVE;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SHOW SLAVE STATUS\G</span></span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.18.0.4</span><br><span class="line">                  Master_User: zhangsan</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 797</span><br><span class="line">               Relay_Log_File: b030ad25d5fe-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 320</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 797</span><br><span class="line">              Relay_Log_Space: 534</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: bd047557-b20c-11ea-9961-0242ac120002</span><br><span class="line">             Master_Info_File: /var/lib/mysql/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: </span><br><span class="line">            Executed_Gtid_Set: </span><br><span class="line">                Auto_Position: 0</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://yuyun-zhao.github.io">yuyun zhao</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://yuyun-zhao.github.io/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/">http://yuyun-zhao.github.io/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E9%AB%98%E7%BA%A7/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/MySQL/">MySQL</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/10/28/%E3%80%90MySQL%E3%80%91MySQL%E7%B4%A2%E5%BC%95/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">【MySQL】MySQL 索引</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/10/21/%E3%80%90JUC%E3%80%91i%E5%8A%A0%E5%8A%A0%E6%93%8D%E4%BD%9C%E8%AF%A6%E8%A7%A3/"><span class="paginator-prev__text">【JUC】i++ 源码详解</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="toc-text">
           MySQL 逻辑架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="toc-text">
           存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-text">
           存储引擎的选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innobd-%E7%9B%B8%E6%AF%94-myisam-%E7%9A%84%E4%BC%98%E7%82%B9"><span class="toc-text">
           InnoBD 相比 MyISAM 的优点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-text">
           存储引擎相关命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-text">
           MySQL 性能优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96"><span class="toc-text">
           索引优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E4%BD%BF%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-text">
           应用优化：使用连接池</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%BC%98%E5%8C%96%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">
           应用优化：负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-text">
           查询缓存优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%8F%8A%E4%BC%98%E5%8C%96"><span class="toc-text">
           内存管理及优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96%E5%8E%9F%E5%88%99"><span class="toc-text">
           内存优化原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#myisam-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-text">
           MyISAM 内存优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#innodb-%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-text">
           InnoDB 内存优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E5%8F%82%E6%95%B0%E8%B0%83%E6%95%B4"><span class="toc-text">
           并发参数调整</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#back_log"><span class="toc-text">
           back_log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table_open_cache"><span class="toc-text">
           table_open_cache</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#thread_cache_size"><span class="toc-text">
           thread_cache_size</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#innodb_lock_wait_timeout"><span class="toc-text">
           innodb_lock_wait_timeout</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E9%94%81"><span class="toc-text">
           MySQL 锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#myisam-%E8%A1%A8%E9%94%81"><span class="toc-text">
           MyISAM 表锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb-%E8%A1%8C%E9%94%81"><span class="toc-text">
           InnoDB 行锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%8C%E9%94%81%E5%9F%BA%E6%9C%AC%E6%BC%94%E7%A4%BA"><span class="toc-text">
           行锁基本演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%97%B6%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81"><span class="toc-text">
           索引失效时行锁升级为表锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%B4%E9%9A%99%E9%94%81%E5%8D%B1%E5%AE%B3"><span class="toc-text">
           间隙锁危害</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%94%81%E5%AE%9A%E4%B8%80%E8%A1%8C"><span class="toc-text">
           如何锁定一行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#innodb-%E8%A1%8C%E9%94%81%E4%BA%89%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-text">
           InnoDB 行锁争用情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">
           总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="toc-text">
           MySQL 常用工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql"><span class="toc-text">
           mysql</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9"><span class="toc-text">
           连接选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%80%89%E9%A1%B9"><span class="toc-text">
           执行选项</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysqladmin"><span class="toc-text">
           mysqladmin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysqlbinlog"><span class="toc-text">
           mysqlbinlog</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mysqldump"><span class="toc-text">
           mysqldump</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9-2"><span class="toc-text">
           连接选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%86%85%E5%AE%B9%E9%80%89%E9%A1%B9"><span class="toc-text">
           输出内容选项</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysqlimportsource"><span class="toc-text">
           mysqlimport&#x2F;source</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mysqlshow"><span class="toc-text">
           mysqlshow</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E6%97%A5%E5%BF%97"><span class="toc-text">
           MySQL 日志</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-text">
           错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="toc-text">
           二进制日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">
           概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F"><span class="toc-text">
           日志格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%AF%BB%E5%8F%96"><span class="toc-text">
           日志读取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%88%A0%E9%99%A4"><span class="toc-text">
           日志删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">
           查询日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">
           慢查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%92%8C%E6%A0%BC%E5%BC%8F"><span class="toc-text">
           文件位置和格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%9A%84%E8%AF%BB%E5%8F%96"><span class="toc-text">
           日志的读取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-text">
           MySQL 主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="toc-text">
           概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-text">
           主从复制原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="toc-text">
           主从复制基本原则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E4%BC%98%E5%8A%BF"><span class="toc-text">
           复制优势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E9%85%8D%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="toc-text">
           一主一从配置案例</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/author.png" alt="avatar"></div><p class="sidebar-ov-author__text">no code no life</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/YUYUN-ZHAO" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="zyy18749810683" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="1024462136" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:im.yuyunzhao@gmail.com" target="_blank" rel="noopener" data-popover="social.Gmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gmail</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">148</div><div class="sidebar-ov-state-item__name">文章</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">40</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>yuyun zhao</span><span class="footer__devider">|</span><span>沪ICP备2022000458号</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>