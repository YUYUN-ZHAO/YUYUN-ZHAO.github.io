<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="简介         https:&#x2F;&#x2F;blog.csdn.net&#x2F;u011863024&#x2F;article&#x2F;details&#x2F;115721328  The Elastic Stack，包括 Elasticsearch、 Kibana、 Beats 和 Logstash（也称为 ELK Stack）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进">
<meta property="og:type" content="article">
<meta property="og:title" content="【ElasticSearch】ElasticSearch">
<meta property="og:url" content="http://yuyun-zhao.github.io/2021/12/11/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/index.html">
<meta property="og:site_name" content="yuyun zhao&#39;s blog">
<meta property="og:description" content="简介         https:&#x2F;&#x2F;blog.csdn.net&#x2F;u011863024&#x2F;article&#x2F;details&#x2F;115721328  The Elastic Stack，包括 Elasticsearch、 Kibana、 Beats 和 Logstash（也称为 ELK Stack）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20211214223034124.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201124224044.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20220104162038740.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201124234946.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203002017.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203150628.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203150652.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20220110185226858.png">
<meta property="article:published_time" content="2021-12-11T04:34:55.000Z">
<meta property="article:modified_time" content="2022-01-14T01:43:50.409Z">
<meta property="article:author" content="yuyun zhao">
<meta property="article:tag" content="ElasticSearch">
<meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yuyun-zhao.github.io/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20211214223034124.png"><title>【ElasticSearch】ElasticSearch | yuyun zhao's blog</title><link ref="canonical" href="http://yuyun-zhao.github.io/2021/12/11/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">文章</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">yuyun zhao's blog</div><div class="header-banner-info__subtitle">no code no life</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">【ElasticSearch】ElasticSearch</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-12-11</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-01-14</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">13.6k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">105分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20211214223034124.png" alt="image-20211214223034124" style="zoom: 25%;" />

        <h2 id="简介"   >
          <a href="#简介" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
      
<blockquote>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/u011863024/article/details/115721328" >https://blog.csdn.net/u011863024/article/details/115721328</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>The Elastic Stack，包括 Elasticsearch、 Kibana、 Beats 和 Logstash（也称为 ELK Stack）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。</p>
<p>Elaticsearch，简称为 ES， 是一个<strong>开源的高扩展的分布式全文搜索引擎</strong>， 是整个 ElasticStack 技术栈的核心，是一个可以用于<strong>检索</strong>、<strong>存储</strong>和<strong>分析</strong>的引擎。它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理 PB 级别的数据。</p>

        <h3 id="全文搜索引擎"   >
          <a href="#全文搜索引擎" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#全文搜索引擎"></a> 全文搜索引擎</h3>
      
<p>Google，百度类的网站搜索，它们都是根据网页中的关键字生成索引，我们在搜索的时候输入关键字，它们会将该关键字即索引匹配到的所有网页返回；还有常见的项目中应用日志的搜索等等。对于这些非结构化的数据文本，关系型数据库搜索不是能很好的支持。</p>
<p>一般传统数据库，全文检索都实现的很鸡肋，因为一般也没人用数据库存文本字段。进行全文检索需要扫描整个表，如果数据量大的话即使对 SQL 的语法优化，也收效甚微。建立了索引，但是维护起来也很麻烦，对于 insert 和 update 操作都会重新构建索引。</p>
<p>基于以上原因可以分析得出，在一些生产环境中，使用常规的搜索方式，性能是非常差的：</p>
<ul>
<li>搜索的数据对象是大量的非结构化的文本数据</li>
<li>文件记录量达到数十万或数百万个甚至更多。</li>
<li>支持大量基于交互式文本的查询</li>
<li>需求非常灵活的全文搜索查询</li>
<li>对高度相关的搜索结果的有特殊需求，但是没有可用的关系数据库可以满足</li>
<li>对不同记录类型、非文本数据操作或安全事务处理的需求相对较少的情况。为了解决结构化数据搜索和非结构化数据搜索性能问题，我们就需要专业，健壮，强大的全文搜索引擎</li>
</ul>
<p>这里说到的<strong>全文搜索引擎</strong>指的是目前广泛应用的主流搜索引擎。它的工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程（倒排索引）。</p>

        <h3 id="elk"   >
          <a href="#elk" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#elk"></a> ELK</h3>
      
<p>ELK 是 Elasticsearch、Logstash、 Kibana 三大开源框架首字母大写简称。市面上也被称为 Elastic Stack。</p>
<ul>
<li>其中 Elasticsearch 是一个基于 Lucene、分布式、通过 Restful 方式进行交互的<strong>近实时搜索平台框架</strong>。像百度、谷歌这种大数据全文搜索引擎的场景都可以使用 Elasticsearch 作为底层支持框架，可见 Elasticsearch 提供的搜索能力确实强大，市面上很多时候我们简称 Elasticsearch 为ES。</li>
<li>Logstash 是 ELK 的<strong>中央数据流引擎</strong>，用于从不同目标（文件/数据存储/MQ）收集的不同格式数据，经过过滤后支持输出到不同目的地（文件/MQ/redis/elasticsearch/kafka等）。</li>
<li>Kibana 可以将 ElasticSearch 的数据通过友好的页面展示出来，提供实时分析的功能。</li>
</ul>
<p>市面上很多开发只要提到 ELK 能够一致说出它是一个日志分析架构技术栈总称，但实际上 ELK 不仅仅适用于日志分析，它还可以支持其它任何数据分析和收集的场景，日志分析和收集只是更具有代表性，并非唯一性。</p>
<p>收集清洗数据（Logstash） ==&gt; 搜索、存储（ElasticSearch） ==&gt; 展示（Kibana）</p>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201124224044.png" alt="img" /></p>

        <h3 id="elasticsearch-应用案例"   >
          <a href="#elasticsearch-应用案例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#elasticsearch-应用案例"></a> Elasticsearch 应用案例</h3>
      
<ul>
<li>GitHub：2013 年初，抛弃了 Solr，采取 Elasticsearch 来做 PB 级的搜索。 “GitHub 使用Elasticsearch 搜索 20TB 的数据，包括 13 亿文件和 1300 亿行代码”。</li>
<li>维基百科：启动以 Elasticsearch 为基础的核心搜索架构</li>
<li>百度：目前广泛使用 Elasticsearch 作为文本数据分析，采集百度所有服务器上的各类指标数据及用户自定义数据，通过对各种数据进行多维分析展示，辅助定位分析实例异常或业务层面异常。目前覆盖百度内部 20 多个业务线（包括云分析、网盟、预测、文库、直达号、钱包、 风控等），单集群最大 100 台机器， 200 个 ES 节点，每天导入 30TB+数据。</li>
<li>新浪：使用 Elasticsearch 分析处理 32 亿条实时日志。</li>
<li>阿里：使用 Elasticsearch 构建日志采集和分析体系。</li>
<li>Stack Overflow：解决 Bug 问题的网站，全英文，编程人员交流的网站。</li>
</ul>

        <h3 id="lucene"   >
          <a href="#lucene" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#lucene"></a> Lucene</h3>
      
<ul>
<li>是 <strong>apache软件基金会</strong> 4 jakarta 项目组的一个子项目</li>
<li>是一个开放源代码的<strong>全文检索引擎工具包</strong></li>
<li><strong>不是一个完整的全文检索引擎，而是一个全文检索引擎的架构</strong>，提供了完整的查询引擎和索引引擎，部分<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%96%87%E6%9C%AC%E5%88%86%E6%9E%90/11046544" >文本分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>引擎（英文与德文两种西方语言）</li>
<li>当前以及最近几年最受欢迎的<strong>免费 Java 信息检索程序库</strong>。</li>
</ul>
<p>Lucene 和 ElasticSearch 的关系：<strong>ElasticSearch 基于 Lucene 做了封装和增强</strong>。ES 使用 Java 开发并使用 Lucene 作为其核心来实现所有索引和搜索的功能，但是它的<strong>目的</strong>是通过简单的 <strong>RESTful API</strong> 来隐藏 Lucene 的复杂性，从而让全文搜索变得简单。</p>

        <h3 id="solr-简介"   >
          <a href="#solr-简介" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#solr-简介"></a> Solr 简介</h3>
      
<ul>
<li>Solr 是 Apache 下的一个顶级开源项目，采用 Java 开发，它是<strong>基于Lucene的全文搜索服务器</strong>。Solr 提供了比 Lucene 更为<strong>丰富的查询语言</strong>，同时实现了<strong>可配置</strong>、<strong>可扩展</strong>，并<strong>对索引、搜索性能进行了优化</strong></li>
<li>Solr 可以<strong>独立运行</strong>，运行在 letty，Tomcat 等这些 Selrvlet 容器中，Solr 索引的实现方法很简单，用 POST 方法向 Solr 服务器发送一个描述 Field 及其内容的 XML 文档，Solr根据 XML 文档<strong>添加、删除、更新</strong>索引。Solr 搜索只需要发送HTTP GET请求，然后对 Solr 返回 XML、JSON 等格式的查询结果进行解析，组织页面布局</li>
<li>Solr 不提供构建 UI 的功能，<strong>Solr提供了一个管理界面，通过管理界面可以查询 Solr 的配置和运行情况</strong></li>
<li>Solr 是基于 Lucene 开发企业级搜索服务器，实际上就是封装了lucene.</li>
<li>Solr 是一个独立的企业级搜索应用服务器，它<strong>对外提供类似于 Web-service 的 API 接口</strong>。用户可以通过 HTTP 请求，向搜索引擎服务器提交指定格式的文件，生成索引。也可以通过提出查找请求，并得到返回结果</li>
</ul>

        <h3 id="es-和-solr"   >
          <a href="#es-和-solr" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#es-和-solr"></a> ES 和 Solr</h3>
      
<blockquote>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.kuangstudy.com/bbs/1354069127022583809" >https://www.kuangstudy.com/bbs/1354069127022583809</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<ul>
<li>ElasticSearch 是一个<strong>实时分布式搜索和分析引擎</strong>，它让你以前所未有的速度处理大数据成为可能。</li>
<li>它用于<mark><strong>全文搜索、结构化搜索、分析</strong></mark>以及将这三者混合使用：
<ul>
<li>维基百科使用 ElasticSearch 提供<strong>全文搜索</strong>并<strong>高亮关键字</strong>，以及输入<strong>实时搜索</strong>（search-asyou-type）和<strong>搜索纠错</strong>（did-you-mean）等搜索建议功能。</li>
<li>英国卫报使用 ElasticSearch 结合用户日志和社交网络数据提供给他们的编辑以实时的反馈，以便及时了解公众对新发表的文章的回应。</li>
<li>StackOverflow 结合全文搜索与地理位置查询，以及 more-like-this 功能来找到相关的问题和答案。</li>
<li>Github 使用 ElasticSearch 检索 1300 亿行的代码。</li>
</ul>
</li>
<li>ElasticSearch 是一个基于 Apache Lucene 的开源搜索引擎。无论在开源还是专有领域，Lucene可被认为是迄今为止最先进、性能最好的、功能最全的搜索引擎库。但是，<strong>Lucene 只是一个库</strong>。 想要使用它，你必须使用 Java 来作为开发语言并将其直接集成到你的应用中。更糟糕的是，Lucene非常复杂，你需要深入了解检索的相关知识来理解它是如何工作的。</li>
<li>ElasticSearch 也使用 Java 开发并使用 Lucene 作为其核心来实现所有引和搜索的功能，但是它的<strong>目的</strong>是通过简单的 <strong>RESTful API</strong> 来隐藏 Lucene 的复杂性，从而让全文搜索变得简单。</li>
</ul>
<p>ElasticSearch 与 Solr 比较：</p>
<ul>
<li>当单纯的对已有数据进行搜索时，Solr 更快</li>
<li>当实时建立索引时，Solr 会产生 io 阻塞，查询性能较差，ElasticSearch 具有明显的优势</li>
<li>随着数据量的增加，Solr 的搜索效率会变得更低，而 ElasticSearch 却没有明显的变化</li>
</ul>

        <h4 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#总结"></a> 总结</h4>
      
<ul>
<li>Solr 利用 Zookeeper 进行分布式管理，而 ElasticSearch 自身带有分布式协调管理功能</li>
<li>Solr 支持更多格式的数据,比如JSON/XML/CSV，而 Elasticsearch 仅支持 JSON 文件格式</li>
<li>Solr 官方提供的功能更多,而Elasticsearch本身更注重于核心功能，高级功能多有第三方插件提供，例如图形化界面需要 kibana 友好支撑</li>
<li><strong>Solr 查询快，但更新索引时慢（即插入删除慢）</strong> ，用于电商等查询多的应用。**ES 建立索引快（实时性查询快），用于 facebook，新浪等搜索。</li>
<li>Solr是传统搜索应用的有力解决方案，但 Elasticsearch 更适用于新兴的实时搜索应用。</li>
<li>Solr 比较成熟，有一个更大，更成熟的用户、开发和贡献者社区，而Elasticsearch相对开发维护者较少，更新太快，学习使用成本较高。</li>
</ul>
<span id="more"></span>

        <h2 id="环境搭建"   >
          <a href="#环境搭建" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#环境搭建"></a> 环境搭建</h2>
      
<p>在 Docker 下快速安装 ElasticSearch 7.4.2：</p>
<ol>
<li>下载镜像文件</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker pull elasticsearch:7.4.2</span><br><span class="line"></span><br><span class="line">$ docker pull kibana:7.4.2</span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>配置</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /mydata/elasticsearch/config  <span class="comment"># 存放配置文件</span></span><br><span class="line">$ mkdir -p /mydata/elasticsearch/data    <span class="comment"># 存放数据</span></span><br><span class="line">$ mkdir -p /mydata/elasticsearch/plugins <span class="comment"># 存放插件</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;http.host: 0.0.0.0&quot;</span> &gt;/mydata/elasticsearch/config/elasticsearch.yml <span class="comment"># 允许任何机器访问</span></span><br><span class="line">$ chmod -R 777 /mydata/elasticsearch/ <span class="comment">## 设置elasticsearch文件可读写权限，否则将无法启动</span></span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>启动（9300 端口为 Elasticsearch 集群间组件的通信端口， 9200 端口为浏览器访问的 HTTP 请求端口）</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e  <span class="string">&quot;discovery.type=single-node&quot;</span> \</span><br><span class="line">-e ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx512m&quot;</span> \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line">-v  /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line">-d elasticsearch:7.4.2 </span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>设置开启启动</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker update elasticsearch --restart=always</span><br></pre></td></tr></table></div></figure>
<ol start="5">
<li>启动 Kibana</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name kibana -e ELASTICSEARCH_HOSTS=http://yuyunzhao.cn:9200 -p 5601:5601 -d kibana:7.4.2</span><br><span class="line"><span class="comment"># http://xxx:9200 改成自己 Elasticsearch 的地址</span></span><br></pre></td></tr></table></div></figure>
<p>在浏览器访问 5601 端口即可进入到界面</p>

        <h2 id="核心概念"   >
          <a href="#核心概念" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#核心概念"></a> 核心概念</h2>
      
<p>Elasticsearch 是<strong>面向文档型数据库</strong>，一条数据在这里就是一个文档。将 Elasticsearch 里存储文档数据和关系型数据库 MySQL 存储数据的概念进行一个类比：</p>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20220104162038740.png" alt="image-20220104162038740" /></p>
<p>ES 里的 Index 可以看做一个库，而 Types 相当于表， Documents 则相当于表的行。这里 Types 的概念已经被逐渐弱化， Elasticsearch 6.X 中，一个 index 下已经只能包含一个type， Elasticsearch 7.X 的一些版本中，Type 的概念已经被删除了。</p>

        <h3 id="物理设计"   >
          <a href="#物理设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#物理设计"></a> 物理设计</h3>
      
<p>ElasticSearch 在后台把<strong>每个索引划分成多个分片</strong>，每分分片可以在集群中的不同服务器间迁移。一个人就是一个集群，即<strong>启动的 ElasticSearch 服务，默认就是一个集群，且默认集群名为ElasticSearch</strong>。</p>

        <h3 id="逻辑设计"   >
          <a href="#逻辑设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#逻辑设计"></a> 逻辑设计</h3>
      
<p>一个索引类型中，包含多个文档，比如说文档1，文档2。当我们索引一篇文档时，可以通过这样的顺序找到它：索引 =&gt; 类型 =&gt; 文档ID ，通过这个组合我们就能索引到某个具体的文档。 注意：ID不必是整数，实际上它是个字符串。</p>
<blockquote>
<p>文档（“行”）</p>
</blockquote>
<p>之前说 ElasticSearch 是面向文档的，那么就意味着<strong>索引和搜索数据的最小单位是文档</strong>，ElasticSearch中，文档有几个重要属性:</p>
<ul>
<li>自我包含，一篇文档同时包含字段和对应的值，也就是同时包含<code>key:value</code></li>
<li>可以是层次型的，一个文档中包含自文档，复杂的逻辑实体就是这么来的</li>
<li>灵活的结构，文档不依赖预先定义的模式，我们知道关系型数据库中，要提前定义字段才能使用，在 ElasticSearch 中，对于字段是非常灵活的，有时候，我们可以忽略该字段，或者动态的添加一个新的字段。</li>
</ul>
<p>尽管我们可以随意新增或者忽略某个字段，但是，每个字段的类型非常重要，比如一个年龄字段类型，可以是字符串也可以是整型。因为 ElasticSearch 会保存字段和类型之间的映射及其他的设置。这种映射具体到每个映射的每种类型，这也是为什么在 ElasticSearch 中，类型有时候也称为映射类型。</p>
<blockquote>
<p>类型（“表”）</p>
</blockquote>
<p>类型是文档的逻辑容器，就像关系型数据库一样，表格是行的容器。类型中对于字段的定义称为映射，比如 name 映射为字符串类型。我们说文档是无模式的，它们不需要拥有映射中所定义的所有字段，比如新增一个字段，那么 ElasticSearch 是怎么做的呢？</p>
<p>ElasticSearch 会自动将新字段加入映射，但是这个字段的不确定它是什么类型，ElasticSearch 就开始猜，如果这个值是18，那么 EasticSearch 会认为它是整型。但是 ElasticSearch 也可能猜不对，所以最安全的方式就是提前定义好所需要的映射，这点跟关系型数据库殊途同归了，先定义好字段，然后再使用。</p>
<blockquote>
<p>索引（“库”）</p>
</blockquote>
<p>索引是映射类型的容器， ElasticSearch 中的索引是一个非常大的文档集合。 索引存储了映射类型的字段和其他设置。然后它们被存储到了各个分片上了。</p>

        <h3 id="分片"   >
          <a href="#分片" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#分片"></a> 分片</h3>
      
<p>一个集群至少有一个节点，而一个节点就是一个 ElasticSearch 进程，节点可以有多个索引默认的，如果你创建索引，那么索引将会有个 5 个分片（primary shard，又称主分片）构成的，每一个主分片会有一个副本（replica shard，又称复制分片）</p>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201124234946.png" alt="img" /></p>
<p>上图是一个有3个节点的集群，可以看到主分片和对应的复制分片都不会在同一个节点内，这样有利于某个节点挂掉了，数据也不至于失。实际上，<strong>一个分片是一个Lucene索引（<mark>一个ElasticSearch索引包含多个Lucene索引</mark>）</strong> ，<strong>一个包含倒排索引的文件目录，倒排索引的结构使得elasticsearch在不扫描全部文档的情况下，就能告诉你哪些文档包含特定的关键字</strong>。不过，等等，倒排索引是什么鬼?</p>

        <h3 id="倒排索引"   >
          <a href="#倒排索引" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#倒排索引"></a> 倒排索引</h3>
      
<p>正排索引（传统）：</p>
<div class="table-container"><table>
<thead>
<tr>
<th>id</th>
<th>content</th>
</tr>
</thead>
<tbody>
<tr>
<td>1001</td>
<td>my name is zhang san</td>
</tr>
<tr>
<td>1002</td>
<td>my name is li si</td>
</tr>
</tbody>
</table></div>
<p>倒排索引（将一条语句按照关键字进行分词拆分，保存每个关键字的 id）：</p>
<div class="table-container"><table>
<thead>
<tr>
<th>keyword</th>
<th>id</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>1001, 1002</td>
</tr>
<tr>
<td>zhang</td>
<td>1001</td>
</tr>
</tbody>
</table></div>
<p>更多高级原理见博客：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/u011863024/article/details/115721328" >https://blog.csdn.net/u011863024/article/details/115721328</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h2 id="基础增删改查"   >
          <a href="#基础增删改查" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#基础增删改查"></a> 基础增删改查</h2>
      
<p>对比关系型数据库，创建索引就等同于创建数据库。四种类型的 RESTful 请求概览：</p>
<div class="table-container"><table>
<thead>
<tr>
<th style="text-align:center">method</th>
<th style="text-align:center">URL</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PUT（创建，修改）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/文档id</td>
<td style="text-align:center">创建文档（指定文档id）</td>
</tr>
<tr>
<td style="text-align:center">POST（创建）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称</td>
<td style="text-align:center">创建文档（随机文档id）</td>
</tr>
<tr>
<td style="text-align:center">POST（修改）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/文档id</td>
<td style="text-align:center">修改文档</td>
</tr>
<tr>
<td style="text-align:center">POST（修改）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/文档id/<strong>_update</strong></td>
<td style="text-align:center">修改文档（会进行数据对比）</td>
</tr>
<tr>
<td style="text-align:center">DELETE（删除）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/文档id</td>
<td style="text-align:center">删除文档</td>
</tr>
<tr>
<td style="text-align:center">GET（查询）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/文档id</td>
<td style="text-align:center">通过文档ID查询</td>
</tr>
<tr>
<td style="text-align:center">GET（查询）</td>
<td style="text-align:center">localhost:9200/索引名称/类型名称/<strong>_search</strong></td>
<td style="text-align:center">条件查询</td>
</tr>
</tbody>
</table></div>

        <h3 id="创建文档"   >
          <a href="#创建文档" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#创建文档"></a> 创建文档</h3>
      
<p>创建文档有两种方式：</p>
<ul>
<li><strong>PUT 请求</strong>：<strong>幂等性</strong>操作。必须指定文档 id（必须明确知道要操作的对象）；如果该文档不存在，就创建该文档；如果文档已经存在，就直接<strong>整个替换文档内容</strong>（此时为修改请求）。</li>
<li><strong>POST 请求</strong>：<strong>非幂等性</strong>操作。可以不指定文档 id（也可以指定）；如果不指定 id，则新增数据时服务<strong>器自动为该文档创建</strong>一个 id；如果指定 id，则以该 id 创建文档（如果文档已存在，则 POST 修改请求会修改目标对象的<strong>部分内容</strong>）</li>
</ul>
<hr />
<p><strong>PUT 和 POST 幂等性的讨论</strong>：</p>
<ul>
<li>PUT：幂等性操作。因为想发出 PUT 请求时必须指定文档 id（必须明确要操作的对象），那么无论发出多少次请求，始终都是在操作该对象，对其内容进行修改，并不会导致创建重复的该对象。</li>
<li>POST：非幂等性操作。因为 POST 请求可以不指定文档 id，这样在发出多次相同的 POST 请求时，如果不指定 id，服务器会创建多个重复的对象（内容相同，但 id 都是服务器随机生成的）</li>
</ul>
<hr />
<blockquote>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/news/39873" >https://cloud.tencent.com/developer/news/39873</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>总结：使用 PUT 时，必须明确知道要操作的对象，如果对象不存在，创建对象；如果对象存在，则<strong>全部替换</strong>目标对象。同样 POST 既可以创建对象，也可以修改对象。但用 POST 创建对象时，之前并不知道要操作的对象，由 HTTP 服务器为新创建的对象生成一个唯一的 URI；使用 POST 修改已存在的对象时，一般<strong>只是修改目标对象的部分内容</strong>。</p>

        <h3 id="查询文档"   >
          <a href="#查询文档" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#查询文档"></a> 查询文档</h3>
      
<p>查询数据通常用 GET 请求，同时可以选择是否指定文档 id：</p>
<ul>
<li>如果指定文档 id，类似于 MySQL 中以指定主键 id 的方式（主键查询）来查询数据，只会查出指定 id 的文档数据。</li>
<li>如果不指定文档 id，则需要在 URL 里添加 <code>_search</code> 字段，表明进行<strong>条件查询</strong>（类似于 MySQL 里的 <code>WHERE</code>）， 同时需要在请求体里添加条件查询的条件。</li>
</ul>
<p>示例：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:9200/custom/external/1" >http://localhost:9200/custom/external/1</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;customer&quot;</span>, <span class="comment">// 在哪个索引</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;external&quot;</span>,  <span class="comment">// 在哪个类型</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,           <span class="comment">// 文档 id</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,        <span class="comment">// 版本号，代表该文档被修改了几次</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">0</span>,         <span class="comment">// 并发控制字段，每次更新就会+1，用来做乐观锁</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span>,   <span class="comment">//同上，主分片重新分配，如重启，就会变化</span></span><br><span class="line">    <span class="attr">&quot;found&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span> <span class="comment">// 真正的内容</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="修改文档"   >
          <a href="#修改文档" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#修改文档"></a> 修改文档</h3>
      
<p>修改文档有两种方式：</p>
<ul>
<li><strong>PUT 请求</strong>：<strong>全量更新</strong>。必须指定所有字段的值，否则漏写的字段将被覆盖为默认值。并且每次修改后，<code>_version</code> 字段的值都会加一。</li>
<li><strong>POST 请求</strong>：<strong>局部更新</strong>。漏写的字段不会被覆盖。只会更新 POST 请求体里携带的字段，没有指定的字段的值不会被改变。如果 URL 里指定了 <code>_update</code>，则此时的 POST 请求会先进行一次检查，判断原数据的值是否和要更新的值相等：
<ul>
<li>如果相等，则不执行修改操作，<code>_version</code> 字段的值不会增加</li>
<li>如果不相等，才会执行修改操作，<code>_version</code> 字段的值加一</li>
</ul>
</li>
</ul>
<blockquote>
<p>不论是 PUT 请求还是 POST 请求，只要 URL 里不指定 <code>_update</code>，就不会执行重复校验。只有 POST 请求中指定了 <code>_update</code>，才会进行重复校验</p>
</blockquote>

        <h3 id="删除文档"   >
          <a href="#删除文档" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#删除文档"></a> 删除文档</h3>
      
<p>删除文档只能使用 DELETE 请求，并明确指定文档 id。</p>

        <h3 id="bulk-批量操作"   >
          <a href="#bulk-批量操作" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#bulk-批量操作"></a> bulk 批量操作</h3>
      
<p>在请求中添加 <code>_bulk</code> 关键字可以进行批量操作：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST customer&#x2F;external&#x2F;_bulk</span><br><span class="line"># 两行是一条文档</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br><span class="line"># 两行是一条文档</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;John Doe&quot;&#125;</span><br></pre></td></tr></table></div></figure>
<p>语法格式</p>
<figure class="highlight"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 两行是一条文档</span><br><span class="line">&#123;action:&#123;metadata&#125;&#125;</span><br><span class="line">&#123;requeestBody&#125;</span><br><span class="line"># 两行是一条文档</span><br><span class="line">&#123;action:&#123;metadata&#125;&#125;</span><br><span class="line">&#123;requesetbod &#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li><code>index</code> 是新建索引，会覆盖文档；</li>
<li><code>create</code> 是新建文档，不会覆盖文档</li>
</ul>
<p>复杂实例：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;<span class="attr">&quot;delete&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;website&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;blog&quot;</span>,<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;create&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;website&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;blog&quot;</span>,<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;my first blog post&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;index&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;website&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;blog&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;my second blog post&quot;</span>&#125;</span><br><span class="line">&#123;<span class="attr">&quot;update&quot;</span>:&#123;<span class="attr">&quot;_index&quot;</span>:<span class="string">&quot;website&quot;</span>,<span class="attr">&quot;_type&quot;</span>:<span class="string">&quot;blog&quot;</span>,<span class="attr">&quot;_id&quot;</span>:<span class="string">&quot;123&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="attr">&quot;doc&quot;</span>:&#123;<span class="attr">&quot;title&quot;</span>:<span class="string">&quot;my updated blog post&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></div></figure>
<p>bulk API 以此按顺序执行所有的action (动作)。如果某个单个的动作因任何原因而失败，它将继续处理它后面剩余的动作。当 bulkAPI 返回时，它将提供每个动作的状态（与发送的顺序相同），可以借此检查一个指定的动作是否失败了。</p>

        <h3 id="_cat"   >
          <a href="#_cat" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#_cat"></a> _cat</h3>
      
<p>在请求中添加 <code>_cat</code> 字段，可以用于查看 ES 服务器中的一些信息，例如：</p>
<ul>
<li><code>GET /_cat/nodes</code>：查看所有节点</li>
<li><code>GET /_cat/health</code>：查看 es 健康状况</li>
<li><code>GET /_cat/master</code>：查看主节点</li>
<li><code>GET /_cat/incices</code>：查看所有索引 show databases</li>
</ul>
<p>其他表头：</p>
<div class="table-container"><table>
<thead>
<tr>
<th>表头</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>health</td>
<td>当前服务器健康状态： green(集群完整) yellow(单点正常、集群不完整) red(单点不正常)</td>
</tr>
<tr>
<td>status</td>
<td>索引打开、关闭状态</td>
</tr>
<tr>
<td>index</td>
<td>索引名</td>
</tr>
<tr>
<td>uuid</td>
<td>索引统一编号</td>
</tr>
<tr>
<td>pri</td>
<td>主分片数量</td>
</tr>
<tr>
<td>rep</td>
<td>副本数量</td>
</tr>
<tr>
<td>docs.count</td>
<td>可用文档数量</td>
</tr>
<tr>
<td>docs.deleted</td>
<td>文档删除状态（逻辑删除）</td>
</tr>
<tr>
<td>store.size</td>
<td>主分片和副分片整体占空间大小</td>
</tr>
<tr>
<td>pri.store.size</td>
<td>主分片占空间大小</td>
</tr>
</tbody>
</table></div>

        <h2 id="复杂查询"   >
          <a href="#复杂查询" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#复杂查询"></a> 复杂查询</h2>
      
<p>前面介绍到，在请求的 URL 中添加 <code>_search</code> 字段，表明进行<strong>条件查询</strong>（类似于 MySQL 里的 <code>WHERE</code>）， 同时需要在请求体里添加条件查询的条件。</p>
<p>常用参数：</p>
<ul>
<li><code>query</code>：类似于 <code>where</code>，在其内添加各种匹配规则以实现条件查询</li>
<li><code>_source</code>：过滤字段</li>
<li><code>sort</code>：排序</li>
<li><code>form</code>、<code>size</code> 分页</li>
</ul>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203002017.png" alt="img" /></p>

        <h3 id="匹配"   >
          <a href="#匹配" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#匹配"></a> 匹配</h3>
      
<p>匹配查询分为以下几种：</p>
<ul>
<li><code>match</code>：针对 <strong>text 文本类型</strong>的文档
<ul>
<li>如果字段类型是<strong>数字</strong>类型，则会<strong>精确匹配</strong>，只匹配出等于该值的文档</li>
<li>如果字段类型是<strong>字符串</strong>类型，则会<strong>模糊匹配</strong>，先使用分词器解析分析文档，然后进行查询。分词器会将该字符串拆分成多个单词，从而匹配出包含这些单词中的任何一个的文档，并再按照评分 <code>score</code> （包含这些单词的比例）对匹配到的文档进行排序</li>
<li>如果某个字段上加了 <code>keyword</code>（例如 <code>name.keyword</code>），就代表该字段查询时不进行分词，要精确匹配</li>
</ul>
</li>
<li><code>match_all</code>：查询所有，不做条件匹配</li>
<li><code>match_phrase</code>：将需要匹配的值当成一个整体单词（<strong>不分词</strong>）进行检索</li>
<li><code>multi_match</code>：同时设置多个条件，需要同时满足这些条件才算匹配</li>
<li><code>term</code>：针对<strong>非文本类型</strong>的文档（例如 number/date/keyword），<strong>精确匹配</strong>具体数值，不进行分词，接通过<strong>倒排索引</strong>指定词条查询。</li>
<li><code>terms</code>：针对对<strong>非文本类型</strong>的文档，可以制定多个值，表示精确匹配这些值中的任意一个（或逻辑）</li>
</ul>
<hr />
<p><code>text</code> 和 <code>keyword</code> 的区别：</p>
<ul>
<li><code>text</code>：
<ul>
<li><strong>支持分词</strong>，<strong>全文检索</strong>、支持模糊、精确查询，不支持聚合、排序操作;</li>
<li>text 类型的最大支持的字符长度无限制，适合大字段存储；</li>
</ul>
</li>
<li><code>keyword</code>：
<ul>
<li><strong>不进行分词</strong>，<strong>直接索引</strong>、支持模糊、支持精确匹配，支持聚合、排序操作。</li>
<li><code>keyword</code>类型的最大支持的长度为——32766个UTF-8类型的字符,可以通过设置<code>ignore_above</code> 指定自持字符长度，超过给定长度后的数据将不被索引，<strong>无法通过term精确匹配检索返回结果</strong>。</li>
</ul>
</li>
</ul>
<hr />

        <h3 id="复合查询"   >
          <a href="#复合查询" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#复合查询"></a> 复合查询</h3>
      
<blockquote>
<p>复合语句可以合并任何其他嵌套语句，包括复合语句，了解这一点是很重要的，这就意味着，复合语句之间可以互相嵌套，可以表达式非常复杂的逻辑</p>
</blockquote>
<p><strong>多条件查询</strong>（<code>bool</code>），其都需要写在 <code>query</code> 字段内，都属于条件查询：</p>
<ul>
<li><code>must</code>：必须达到 <code>must</code>列举的所有条件</li>
<li><code>should</code>：应该达到 <code>should</code>列举的条件，<strong>如果达到会增加相关文档的评分</strong>，并<strong>不会改变查询的结果</strong>，如果 query 中只有 should 且只有一种匹配规则，那么 should 的条件就会被作为默认匹配条件而去改变查询结果。should 是<strong>加分项</strong>，<strong>不满足也能查出来。只是如果满足会加分</strong></li>
<li><code>must_not</code>：必须不是指定的情况。<code>must_not</code> <strong>不会额外贡献得分</strong>，但是其是一个 filter，不满足直接不显示</li>
<li><code>filter</code>：条件过滤。效果和 <code>must</code> 类似，也能检索出目标记录，但是不会记录相关性得分，不满足 <code>filter</code> 的直接过滤，满足的留下。且<strong>满足的也不会额外增加相关性得分</strong>。<code>filter</code> 因为不涉及计算评分，因此查询效率更高</li>
</ul>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203150628.png" alt="img" /></p>
<blockquote>
<p>上图中的相当于 and 不正确</p>
</blockquote>

        <h3 id="高亮查询"   >
          <a href="#高亮查询" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#高亮查询"></a> 高亮查询</h3>
      
<p>可以添加高亮查询参数，使得匹配到的分词添加一段高亮标签 <code>&lt;em&gt;xxxx&lt;/em&gt;</code>：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 高亮查询</span></span><br><span class="line">GET blog/user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;流&quot;</span> </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;  <span class="comment">// 设置需要高亮的字段，该例中将返回 &lt;em&gt;流&lt;/em&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>自定义前缀和后缀：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET blog/user/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;流&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;p class=&#x27;key&#x27; style=&#x27;color:red&#x27;&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/p&gt;&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/20201203150652.png" alt="img" /></p>

        <h3 id="聚合查询"   >
          <a href="#聚合查询" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#聚合查询"></a> 聚合查询</h3>
      
<p>聚合查询（aggregations）允许使用者对 ES 文档进行<strong>统计分析</strong>，类似于关系型数据库中的 <code>group by</code>，当然还有很多其他的聚合，例如取最大值 <code>max</code>、平均值 <code>avg</code> 等等。使用格式：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;mill&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>:&#123;                     <span class="comment">// 聚合操作</span></span><br><span class="line">        <span class="attr">&quot;price_group&quot;</span>:&#123;          <span class="comment">// 名称，随意起名</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>:&#123;            <span class="comment">// 聚合类型</span></span><br><span class="line">                <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;price&quot;</span>  <span class="comment">// 聚合字段</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>示例一：搜索 address 中包含 mill 的所有人的年龄分布以及平均年龄</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;address&quot;</span>: <span class="string">&quot;mill&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ageAgg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;ageAvg&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;balanceAvg&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>:<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>示例二：按照年龄聚合，并且请求这些年龄段的这些人的平均薪资</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ageAgg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;ageAvg&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>示例三：查出所有年龄分布，并且这些年龄段中M的平均薪资和 F 的平均薪资以及这个年龄段的总体平均薪资</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;match_all&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ageAgg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">100</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;genderAgg&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;gender.keyword&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;balanceAvg&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;balance&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>其中：</p>
<ul>
<li><code>terms</code> 用于数据统计（统计某个字段的数据分布情况）</li>
<li><code>avg</code> 计算平均值</li>
</ul>

        <h3 id="nested"   >
          <a href="#nested" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#nested"></a> nested</h3>
      
<p>nested 用于定义<strong>嵌入式对象</strong>。</p>
<p>文档的内部对象需要定义为 <code>nested</code> 类型。这是因为，ES 内部的 Lucene 会将普通类型的对象进行扁平化处理。如果 Lucene 对文档进行了扁平化，则各个不同文档间的内部对象数据就会被存储在一起，就不符合实际存储情况了。例如，某个文档拥有一个内部数据 <code>comments</code>，其又有多个字段（<code>name</code>/<code>comment</code>/<code>age</code>等），那么被扁平化后的文档数据：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;title&quot;</span>:                    [ invest, money ],</span><br><span class="line">  <span class="attr">&quot;body&quot;</span>:                     [ as, investing, money, please, soon, start ],</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>:                     [ invest, money ],</span><br><span class="line">  <span class="attr">&quot;published_on&quot;</span>:             [ <span class="number">18</span> Oct <span class="number">2017</span> ]</span><br><span class="line">  <span class="string">&quot;comments.name&quot;</span>:            [ smith, john, william ],</span><br><span class="line">  <span class="attr">&quot;comments.comment&quot;</span>:         [ after, article, good, i, investing, nice, post, reading, started, this, very ],</span><br><span class="line">  <span class="attr">&quot;comments.age&quot;</span>:             [ <span class="number">33</span>, <span class="number">34</span>, <span class="number">38</span> ],</span><br><span class="line">  <span class="attr">&quot;comments.rating&quot;</span>:          [ <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span> ],</span><br><span class="line">  <span class="attr">&quot;comments.commented_on&quot;</span>:    [ <span class="number">20</span> Nov <span class="number">2017</span>, <span class="number">25</span> Nov <span class="number">2017</span>, <span class="number">30</span> Nov <span class="number">2017</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>显然多个文档的 <code>comments</code>信息被混在一起了，就不符合实际存储情况了。</p>
<blockquote>
<p>更多详细介绍见：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://elastic.blog.csdn.net/article/details/82950393" >https://elastic.blog.csdn.net/article/details/82950393</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>因此，当一个对象中又嵌套包含另一个对象时，需要将该对象类型设置为 <code>nested</code>。这样 ES 内部的 Lucene 就不会将这个对象进行扁平化处理。</p>
<p>使用 <code>nested</code> 的示例：将内部对象 <code>attrs</code> 设置为 <code>nested</code> 类型：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;attrs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;nested&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;attrId&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;long&quot;</span>&#125;,</span><br><span class="line">                    <span class="attr">&quot;attrName&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;doc_values&quot;</span>: <span class="literal">false</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;attrValue&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span> &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="类型映射"   >
          <a href="#类型映射" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#类型映射"></a> 类型映射</h2>
      
<p>Mapping（映射） 是用来定义一个文档（document）以及他所包含的属性（field）是如何存储索引的，比如使用 mapping 来定义的：</p>
<ul>
<li>哪些字符串属性应该被看做全文本属性（full text fields）</li>
<li>那些属性包含数字，日期或者地理位置</li>
<li>文档中的所有属性是能被索引（_all 配置）</li>
<li>日期的格式</li>
<li>自定义映射规则来执行动态添加属性</li>
</ul>
<p>查看某个索引的所有类型信息：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET indexName&#x2F;_mapping</span><br></pre></td></tr></table></div></figure>
<p>如果在创建索引时不显式指定每个字段的类型，则 ES 会根据字段的值自动推测该字段的类型。</p>

        <h3 id="创建映射"   >
          <a href="#创建映射" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#创建映射"></a> 创建映射</h3>
      
<ol>
<li>创建索引，指定映射（不设置值）：</li>
</ol>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;age&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span>&#125;,</span><br><span class="line">            <span class="attr">&quot;email&quot;</span>: &#123;<span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>如果想在一个已存在的索引上添加新的字段映射：</li>
</ol>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my_index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;employeeid&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;index&quot;</span>:<span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>示例：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;skuId&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;spuId&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;skuTitle&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;skuPrice&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;skuImg&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;saleCount&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;hasStock&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;boolean&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;hotScore&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;brandId&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;catelogId&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;brandName&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span>,      <span class="comment">// 这个字段只能被查出来，不可用来被检索，不会建立倒排索引</span></span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span>: <span class="literal">false</span>  <span class="comment">// 这个字段不能用来聚合。冗余存储的字段都这么设置，节省资源</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;brandImg&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span>: <span class="literal">false</span>  <span class="comment">// 这些字段仅用来展示，不做索引。冗余存储</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;catalogName&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;index&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">&quot;doc_values&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;attrs&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;nested&quot;</span>,     <span class="comment">// 设置为嵌入式字段，不会被扁平化处理</span></span><br><span class="line">                <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;attrId&quot;</span>:&#123;</span><br><span class="line">                        <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;long&quot;</span></span><br><span class="line">                    &#125;,  </span><br><span class="line">                    <span class="attr">&quot;attrName&quot;</span>:&#123;</span><br><span class="line">                        <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;index&quot;</span>:<span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">&quot;doc_values&quot;</span>:<span class="literal">false</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;attrValue&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>其中，一旦为 字段设置了 <code>&quot;doc_values&quot;: false</code>，则其就不能用来进行聚合了。如果想要对该字段进行聚合，就不能设置为 false。</p>

        <h3 id="不同索引间的数据迁移"   >
          <a href="#不同索引间的数据迁移" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#不同索引间的数据迁移"></a> 不同索引间的数据迁移</h3>
      
<p>如果想将某个索引内的数据迁移到另一个索引内，则可以使用如下方法：</p>
<ol>
<li>先创建新索引 <code>new_twitter</code> 的正确映射</li>
<li>然后进行迁移：</li>
</ol>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex // [固定写法]</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;twitter&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;new_twitter&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>如果想将旧索引的 <code>type</code>下的数据进行迁移，则方法为：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;twitter&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;tweet&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;dest&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>:<span class="string">&quot;twweets&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>更多细节参考：</p>
<ul>
<li>官网：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html" >https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-types.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li>参数映射规则：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-params.html#mapping-params" >https://www.elastic.co/guide/en/elasticsearch/reference/7.10/mapping-params.html#mapping-params</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>

        <h2 id="java-high-level-rest-client"   >
          <a href="#java-high-level-rest-client" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#java-high-level-rest-client"></a> Java High Level REST Client</h2>
      
<p>Java 中的 ES 客户端有多种选择，具体见官方文档： <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html" >https://www.elastic.co/guide/en/elasticsearch/client/index.html</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>本章将介绍 Java REST Client 的配置和使用。与 Spring Data 的整合配置与使用见博客：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/u011863024/article/details/115721328" >https://blog.csdn.net/u011863024/article/details/115721328</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h3 id="配置"   >
          <a href="#配置" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3>
      
<ol>
<li>导入依赖：</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>配置类：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallElasticSearchConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用的设置项</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.Builder builder = RequestOptions.DEFAULT.toBuilder();</span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * 向容器中注入ES的客户端</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">esRestClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestClientBuilder builder = RestClient.builder(</span><br><span class="line">            <span class="keyword">new</span> HttpHost(<span class="string">&quot;localhost&quot;</span>, <span class="number">9200</span>, <span class="string">&quot;http&quot;</span>));</span><br><span class="line">        RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(builder);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>注入 <code>RestHighLevelClient</code>：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> RestHighLevelClient restHighLevelClient;</span><br></pre></td></tr></table></div></figure>

        <h3 id="操作索引"   >
          <a href="#操作索引" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#操作索引"></a> 操作索引</h3>
      
<ol>
<li>创建索引</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试索引的创建， Request PUT liuyou_index</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreateIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    CreateIndexRequest request = <span class="keyword">new</span> CreateIndexRequest(<span class="string">&quot;liuyou_index&quot;</span>);</span><br><span class="line">    CreateIndexResponse response = restHighLevelClient.indices().create(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.isAcknowledged()); <span class="comment">// 查看是否创建成功</span></span><br><span class="line">    System.out.println(response);                  <span class="comment">// 查看返回对象</span></span><br><span class="line">    restHighLevelClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>获取索引：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试获取索引，并判断其是否存在</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testIndexIsExists</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    GetIndexRequest request = <span class="keyword">new</span> GetIndexRequest(<span class="string">&quot;index&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> exists = restHighLevelClient.indices().exists(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists);  <span class="comment">// 索引是否存在</span></span><br><span class="line">    restHighLevelClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>删除索引：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试索引删除</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DeleteIndexRequest request = <span class="keyword">new</span> DeleteIndexRequest(<span class="string">&quot;liuyou_index&quot;</span>);</span><br><span class="line">    AcknowledgedResponse response = restHighLevelClient.indices().delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.isAcknowledged());<span class="comment">// 是否删除成功</span></span><br><span class="line">    restHighLevelClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="操作文档"   >
          <a href="#操作文档" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#操作文档"></a> 操作文档</h3>
      
<ol>
<li>添加文档：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试添加文档(先创建一个User实体类，添加fastjson依赖)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAddDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建一个User对象</span></span><br><span class="line">    User liuyou = <span class="keyword">new</span> User(<span class="string">&quot;liuyou&quot;</span>, <span class="number">18</span>);</span><br><span class="line">    <span class="comment">// 创建请求</span></span><br><span class="line">    IndexRequest request = <span class="keyword">new</span> IndexRequest(<span class="string">&quot;liuyou_index&quot;</span>);</span><br><span class="line">    <span class="comment">// 制定规则 PUT /liuyou_index/_doc/1</span></span><br><span class="line">    request.id(<span class="string">&quot;1&quot;</span>);<span class="comment">// 设置文档ID</span></span><br><span class="line">    request.timeout(TimeValue.timeValueMillis(<span class="number">1000</span>));<span class="comment">// request.timeout(&quot;1s&quot;)</span></span><br><span class="line">    <span class="comment">// 将我们的数据放入请求中</span></span><br><span class="line">    request.source(JSON.toJSONString(liuyou), XContentType.JSON);</span><br><span class="line">    <span class="comment">// 客户端发送请求，获取响应的结果</span></span><br><span class="line">    IndexResponse response = restHighLevelClient.index(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.status());<span class="comment">// 获取建立索引的状态信息 CREATED</span></span><br><span class="line">    System.out.println(response);<span class="comment">// 查看返回内容 IndexResponse[index=liuyou_index,type=_doc,id=1,version=1,result=created,seqNo=0,primaryTerm=1,shards=&#123;&quot;total&quot;:2,&quot;successful&quot;:1,&quot;failed&quot;:0&#125;]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="2">
<li>获取文档信息：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试获得文档信息</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">&quot;liuyou_index&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    GetResponse response = restHighLevelClient.get(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.getSourceAsString());  <span class="comment">// 打印文档内容</span></span><br><span class="line">    System.out.println(request);  <span class="comment">// 返回的全部内容和命令是一样的</span></span><br><span class="line">    restHighLevelClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>获取文档并判断其是否存在：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取文档，判断是否存在 get /liuyou_index/_doc/1</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDocumentIsExists</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    GetRequest request = <span class="keyword">new</span> GetRequest(<span class="string">&quot;liuyou_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 不获取返回的 _source的上下文了</span></span><br><span class="line">    request.fetchSourceContext(<span class="keyword">new</span> FetchSourceContext(<span class="keyword">false</span>));</span><br><span class="line">    request.storedFields(<span class="string">&quot;_none_&quot;</span>);</span><br><span class="line">    <span class="keyword">boolean</span> exists = restHighLevelClient.exists(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(exists);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>更新文档：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试更新文档内容</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    UpdateRequest request = <span class="keyword">new</span> UpdateRequest(<span class="string">&quot;liuyou_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    User user = <span class="keyword">new</span> User(<span class="string">&quot;lmk&quot;</span>,<span class="number">11</span>);</span><br><span class="line">    request.doc(JSON.toJSONString(user),XContentType.JSON);</span><br><span class="line">    UpdateResponse response = restHighLevelClient.update(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.status()); <span class="comment">// OK</span></span><br><span class="line">    restHighLevelClient.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="5">
<li>删除文档：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试删除文档</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteDocument</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DeleteRequest request = <span class="keyword">new</span> DeleteRequest(<span class="string">&quot;liuyou_index&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    request.timeout(<span class="string">&quot;1s&quot;</span>);</span><br><span class="line">    DeleteResponse response = restHighLevelClient.delete(request, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(response.status());<span class="comment">// OK</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="6">
<li>查询文档：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询</span></span><br><span class="line"><span class="comment">// SearchRequest 搜索请求</span></span><br><span class="line"><span class="comment">// SearchSourceBuilder 条件构造</span></span><br><span class="line"><span class="comment">// HighlightBuilder 高亮</span></span><br><span class="line"><span class="comment">// TermQueryBuilder 精确查询</span></span><br><span class="line"><span class="comment">// MatchAllQueryBuilder</span></span><br><span class="line"><span class="comment">// xxxQueryBuilder ...</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 1.创建查询请求对象</span></span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 2.构建搜索条件</span></span><br><span class="line">    SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// (1)查询条件 使用QueryBuilders工具类创建</span></span><br><span class="line">    <span class="comment">// 精确查询</span></span><br><span class="line">    TermQueryBuilder termQueryBuilder = QueryBuilders.termQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;liuyou&quot;</span>);</span><br><span class="line">    <span class="comment">//  // 匹配查询</span></span><br><span class="line">    <span class="comment">//    MatchAllQueryBuilder matchAllQueryBuilder = QueryBuilders.matchAllQuery();</span></span><br><span class="line">    <span class="comment">// (2) 其他&lt;可有可无&gt;：（可以参考 SearchSourceBuilder 的字段部分）</span></span><br><span class="line">    <span class="comment">// 设置高亮</span></span><br><span class="line">    searchSourceBuilder.highlighter(<span class="keyword">new</span> HighlightBuilder());</span><br><span class="line">    <span class="comment">//  // 分页</span></span><br><span class="line">    <span class="comment">//    searchSourceBuilder.from();</span></span><br><span class="line">    <span class="comment">//    searchSourceBuilder.size();</span></span><br><span class="line">    searchSourceBuilder.timeout(<span class="keyword">new</span> TimeValue(<span class="number">60</span>, TimeUnit.SECONDS));</span><br><span class="line">    <span class="comment">// (3)条件投入</span></span><br><span class="line">    searchSourceBuilder.query(termQueryBuilder);</span><br><span class="line">    <span class="comment">// 3.添加条件到请求</span></span><br><span class="line">    searchRequest.source(searchSourceBuilder);</span><br><span class="line">    <span class="comment">// 4.客户端查询请求</span></span><br><span class="line">    SearchResponse search = restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="comment">// 5.查看返回结果</span></span><br><span class="line">    SearchHits hits = search.getHits();</span><br><span class="line">    System.out.println(JSON.toJSONString(hits));</span><br><span class="line">    System.out.println(<span class="string">&quot;=======================&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (SearchHit documentFields : hits.getHits()) &#123;</span><br><span class="line">        System.out.println(documentFields.getSourceAsMap());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</span><br><span class="line">    <span class="comment">// 1. 指定索引</span></span><br><span class="line">    searchRequest.indices(<span class="string">&quot;bank&quot;</span>);</span><br><span class="line">    <span class="comment">// 2. 指定DSL，检索条件</span></span><br><span class="line">    SearchSourceBuilder sourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">    <span class="comment">// 2.1 条件查询</span></span><br><span class="line">    sourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;mill&quot;</span>));</span><br><span class="line">    <span class="comment">// 2.2 按照年龄值分布进行聚合</span></span><br><span class="line">    TermsAggregationBuilder ageAgg = AggregationBuilders.terms(<span class="string">&quot;ageAgg&quot;</span>).field(<span class="string">&quot;age&quot;</span>).size(<span class="number">10</span>);</span><br><span class="line">    sourceBuilder.aggregation(ageAgg);</span><br><span class="line">    <span class="comment">// 2.3 按照平均薪资进行聚合</span></span><br><span class="line">    AvgAggregationBuilder balanceAvg = AggregationBuilders.avg(<span class="string">&quot;balanceAvg&quot;</span>).field(<span class="string">&quot;balance&quot;</span>);</span><br><span class="line">    sourceBuilder.aggregation(balanceAvg);</span><br><span class="line">    <span class="comment">// 为查询请求设置建造器</span></span><br><span class="line">    searchRequest.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;检索条件：&quot;</span> + sourceBuilder.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 执行检索</span></span><br><span class="line">    SearchResponse searchResponse = client.search(searchRequest, MallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">    System.out.println(searchResponse.toString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 拿到命中得结果</span></span><br><span class="line">    SearchHits hits = searchResponse.getHits();</span><br><span class="line">    <span class="comment">// 5.搜索请求的匹配</span></span><br><span class="line">    SearchHit[] searchHits = hits.getHits();</span><br><span class="line">    <span class="comment">// 6. 进行遍历</span></span><br><span class="line">    <span class="keyword">for</span> (SearchHit hit : searchHits) &#123;</span><br><span class="line">        <span class="comment">// 7. 拿到完整结果字符串</span></span><br><span class="line">        String sourceAsString = hit.getSourceAsString();</span><br><span class="line">        <span class="comment">// 8. 转换成实体类</span></span><br><span class="line">        Account accout = JSON.parseObject(sourceAsString, Account.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;account:&quot;</span> + accout );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9. 拿到聚合</span></span><br><span class="line">    Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10. 通过先前名字拿到对应聚合</span></span><br><span class="line">    Terms ageAgg1 = aggregations.get(<span class="string">&quot;ageAgg&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (Terms.Bucket bucket : ageAgg1.getBuckets()) &#123;</span><br><span class="line">        <span class="comment">// 11、拿到结果</span></span><br><span class="line">        String keyAsString = bucket.getKeyAsString();</span><br><span class="line">        System.out.println(<span class="string">&quot;年龄:&quot;</span> + keyAsString);</span><br><span class="line">        <span class="keyword">long</span> docCount = bucket.getDocCount();</span><br><span class="line">        System.out.println(<span class="string">&quot;个数：&quot;</span> + docCount);</span><br><span class="line">    &#125;</span><br><span class="line">    Avg balanceAvg1 = aggregations.get(<span class="string">&quot;balanceAvg&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;平均薪资：&quot;</span> + balanceAvg1.getValue());</span><br><span class="line">    System.out.println(searchResponse.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ol start="7">
<li>批量保存文档：</li>
</ol>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    BulkRequest bulkRequest = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    bulkRequest.timeout(<span class="string">&quot;10s&quot;</span>);</span><br><span class="line">    ArrayList&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-1&quot;</span>,<span class="number">1</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-2&quot;</span>,<span class="number">2</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-3&quot;</span>,<span class="number">3</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-4&quot;</span>,<span class="number">4</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-5&quot;</span>,<span class="number">5</span>));</span><br><span class="line">    users.add(<span class="keyword">new</span> User(<span class="string">&quot;liuyou-6&quot;</span>,<span class="number">6</span>));</span><br><span class="line">    <span class="comment">// 批量请求处理</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; users.size(); i++) &#123;</span><br><span class="line">        bulkRequest.add(</span><br><span class="line">            <span class="comment">// 这里是数据信息</span></span><br><span class="line">            <span class="keyword">new</span> IndexRequest(<span class="string">&quot;bulk&quot;</span>)</span><br><span class="line">            .id(<span class="string">&quot;&quot;</span>+(i + <span class="number">1</span>)) <span class="comment">// 没有设置id 会自定生成一个随机id</span></span><br><span class="line">            .source(JSON.toJSONString(users.get(i)),XContentType.JSON)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);</span><br><span class="line">    System.out.println(bulk.status());<span class="comment">// ok</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>真实案例：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBulk</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    BulkRequest bulkRequest = <span class="keyword">new</span> BulkRequest();</span><br><span class="line">    <span class="keyword">for</span> (SkuEsModel skuEsModel : skuEsModelList) &#123;</span><br><span class="line">        <span class="comment">//构造保存请求</span></span><br><span class="line">        IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(EsConstant.PRODUCT_INDEX);</span><br><span class="line">        indexRequest.id(skuEsModel.getSkuId().toString());</span><br><span class="line">        String jsonString = JSON.toJSONString(skuEsModel);</span><br><span class="line">        indexRequest.source(jsonString, XContentType.JSON);</span><br><span class="line">        bulkRequest.add(indexRequest);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. 批量保存</span></span><br><span class="line">    BulkResponse bulk = restHighLevelClient.bulk(bulkRequest, MallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="分词"   >
          <a href="#分词" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#分词"></a> 分词</h2>
      
<blockquote>
<p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/u011863024/article/details/115721328" >https://blog.csdn.net/u011863024/article/details/115721328</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p>一个 tokenizer（分词器）接收一个字符流，将之分割为独立的 <strong>tokens</strong>（词元，通常是独立的单词），然后输出 token 流。例如，<code>witespace tokenizer</code> 遇到的空白字符时分割文本，它会将文本 “Quick brown fox” 分割为 【Quick brown fox】。</p>
<p>该分词器还负责记录各个 term（词条）的顺序或 position 位置（用于 phrase 短语和 word proximity 词近邻查询），以及 term（词条）所代表的原始 word 的 start 和end 的 character offsets （字符偏移量），用于高亮显示搜索的内容。</p>
<p>Elasticsearch 提供了很多内置的分词器，也可以按照其他开源的分词器（例如 ik 分词器）。例如标准分词器：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET http://localhost:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;Text to analyze&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>结果中每个元素代表一个单独的词条：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;text&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>, </span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span>: <span class="number">4</span>, </span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;to&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span>: <span class="number">5</span>, </span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span>: <span class="number">7</span>, </span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">2</span></span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;analyze&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;start_offset&quot;</span>: <span class="number">8</span>, </span><br><span class="line">            <span class="attr">&quot;end_offset&quot;</span>: <span class="number">15</span>, </span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;position&quot;</span>: <span class="number">3</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li><code>token</code> 是实际存储到索引中的词条</li>
<li><code>start_offset</code> 和 <code>end_offset</code> 指明字符在原始字符串中的位置</li>
<li><code>position</code> 指明词条在原始文本中出现的位置</li>
</ul>

        <h3 id="安装-ik-分词器"   >
          <a href="#安装-ik-分词器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#安装-ik-分词器"></a> 安装 ik 分词器</h3>
      
<p>ik 分词器是一款优秀的汉语分词器。安装方法：从 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases" >https://github.com/medcl/elasticsearch-analysis-ik/releases</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 下载 ik 分词器并拷贝解压到 ES 的插件目录 <code>/mydata/elasticsearch/plugins</code> 下即可。</p>

        <h3 id="自定义词库"   >
          <a href="#自定义词库" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自定义词库"></a> 自定义词库</h3>
      
<ol>
<li>修改 <code>/mydata/elasticsearch/plugins/ik/config</code> 目录下的 <code>IKAnalyzer.cfg.xml</code> 文件，在其内写上远程字典地址：</li>
</ol>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">properties</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;remote_ext_dict&quot;</span>&gt;</span>http://yuyunzhao.cn/es/fenci.txt<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>其中，远程字典文件 <code>/es/fenci.txt</code> 创建在了 nginx 的 <code>/mydata/nginx/html</code> 目录下，这样才可以被其他服务器访问到。</p>
<ol start="2">
<li>在词典中添加自定义的分词：</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">乔碧萝</span><br></pre></td></tr></table></div></figure>
<ol start="3">
<li>添加了分词后记得重新启动 elasticsearch 服务：</li>
</ol>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker restart elasticsearch</span><br></pre></td></tr></table></div></figure>
<ol start="4">
<li>这样在检索时就可以指定分词器为 ik 分词器：</li>
</ol>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>, <span class="comment">// 还有 ik_smart 等分词器</span></span><br><span class="line">    <span class="attr">&quot;text&quot;</span>: [<span class="string">&quot;乔碧萝殿下&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="实战案例"   >
          <a href="#实战案例" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#实战案例"></a> 实战案例</h2>
      
<p>本章将介绍<a href="https://yuyun-zhao.github.io/2021/12/20/%E3%80%90Project%E3%80%91%E4%BA%91%E5%95%86%E5%9F%8E/">云商城项目</a>中检索服务的 DSL 语句与业务代码。</p>
<p>检索服务负责根据前端传来的关键词等参数对商品进行检索。首先介绍前端页面中用户可以用来进行检索的条件：</p>
<p><img src="/images/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/image-20220110185226858.png" alt="image-20220110185226858" /></p>

        <h3 id="数据模型设计"   >
          <a href="#数据模型设计" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#数据模型设计"></a> 数据模型设计</h3>
      
<p>我们需要根据这些条件构造出搜索条件实体类 <code>SearchParam</code>，该对象中的每个属性都对应了前端传来的查询参数：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装页面所有可能传递过来的查询条件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yuyun.zhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2022-01-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchParam</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面传递过来的全文匹配关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long catalog3Id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * sort=saleCout_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=skuPrice_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=hotScore_asc/desc</span></span><br><span class="line"><span class="comment">     * 排序条件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sort;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否显示有货。hasStock(是否有货) skuPrice区间，brandId、catalog3Id、attrs</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer hasStock = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格区间查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String skuPrice;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照品牌进行查询，可以多选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; brandId;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照属性进行筛选</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; attrs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>同时我们还需要为检索结果设计一个 VO 类 <code>SearchResult</code> ，该类负责保存检索到的所有商品信息 <code>SkuEsModel</code>（具体定义见<a href="#%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6">商品上架</a>），并且保存查询结果所涉及到的品牌、商品分类以及商品属性等信息。这些信息将返回给前端进行展示，这样前端就可以根据用户的检索条件显示出符合该条件的所有产品以及其所涉及到的品牌、商品分类以及商品属性等信息。</p>
<p>查询结果实体类 <code>SearchResult</code>：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询结果返回</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yuyun.zhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Create</span> 2022-01-07</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchResult</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询到所有商品的商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuEsModel&gt; products;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以下是分页信息</span></span><br><span class="line"><span class="comment">     * 当前页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总共记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPages;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询到的结果，所有设计的品牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrandVo&gt; brands;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询结果，所有涉及到的分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CatalogVo&gt; catalogs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询到的结果，所有涉及到的所有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrVo&gt; attrs;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; pageNavs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================== 以上是要返回给页面的所有信息 ==================</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BrandVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long brandId;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String brandName;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌图片</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String brandImg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CatalogVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 分类id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long catalogId;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 品牌名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String CatalogName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AttrVo</span> </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性id</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性名字</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 属性值</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; attrValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="检索-dsl-语句"   >
          <a href="#检索-dsl-语句" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#检索-dsl-语句"></a> 检索 DSL 语句</h3>
      
<p>构建出 DSL 语句，要包含以下几个部分：</p>
<figure class="highlight"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET product/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123; </span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: [...],     <span class="comment">// 必须满足的条件 </span></span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: [...]    <span class="comment">// 过滤条件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: [...],             <span class="comment">// 排序条件</span></span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,                 <span class="comment">// 起始页</span></span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">1</span>,                 <span class="comment">// 分页大小   </span></span><br><span class="line">    &quot;hightlight&quot;: &#123;...&#125;,       // 高亮显示查询的keyword</span><br><span class="line">    &quot;aggs&quot;: &#123;&#125;                 // 聚合查询</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>DSL 语句示例：</p>
<figure class="highlight json"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">GET product/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;skuTitle&quot;</span>: <span class="string">&quot;华为&quot;</span>  <span class="comment">// 按照关键字查询</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;catalogId&quot;</span>: <span class="string">&quot;225&quot;</span> <span class="comment">// 根据分类id过滤</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;brandId&quot;</span>: [       <span class="comment">// 根据品牌id过滤</span></span><br><span class="line">                            <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;5&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;9&quot;</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;nested&quot;</span>: &#123;           <span class="comment">// 嵌套查询：根据属性id以及属性值进行过滤</span></span><br><span class="line">                        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;attrs&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                                <span class="attr">&quot;must&quot;</span>: [</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">                                            <span class="attr">&quot;attrs.attrId&quot;</span>: &#123;</span><br><span class="line">                                                <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                                            <span class="attr">&quot;attrs.attrValue&quot;</span>: [</span><br><span class="line">                                                <span class="string">&quot;2019&quot;</span></span><br><span class="line">                                            ]</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                ]</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;term&quot;</span>: &#123;          <span class="comment">// 是否有库存</span></span><br><span class="line">                        <span class="attr">&quot;hasStock&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;false&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;range&quot;</span>: &#123;         <span class="comment">// 价格区间</span></span><br><span class="line">                        <span class="attr">&quot;skuPrice&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;gte&quot;</span>: <span class="number">0</span>,</span><br><span class="line">                            <span class="attr">&quot;lte&quot;</span>: <span class="number">7000</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;sort&quot;</span>: [  <span class="comment">// 排序</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;skuPrice&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;order&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;from&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>:<span class="number">4</span>,</span><br><span class="line">    <span class="attr">&quot;highlight&quot;</span>: &#123;   <span class="comment">// 对搜索条件进行高亮</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: &#123;<span class="attr">&quot;skuTitle&quot;</span>: &#123;&#125;&#125;, </span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;b style=color:red&gt;&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/b&gt;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;brand_agg&quot;</span>: &#123;  <span class="comment">// 品牌进行聚合</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandId&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;brand_name_agg&quot;</span>: &#123;  <span class="comment">// 品牌名字</span></span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandName&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;brand_img_agg&quot;</span>: &#123;  <span class="comment">// 品牌图片</span></span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;brandImg&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;catalog_agg&quot;</span>: &#123; <span class="comment">// 分类</span></span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;catalogId&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;catalog_name_agg&quot;</span>: &#123; <span class="comment">// 分类名字</span></span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;catalogName&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;attr_agg&quot;</span>:&#123;</span><br><span class="line">            <span class="attr">&quot;nested&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;attrs&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;    <span class="comment">// 属性聚合</span></span><br><span class="line">                <span class="attr">&quot;attr_id_agg&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrId&quot;</span>,</span><br><span class="line">                        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;attr_name_agg&quot;</span>: &#123; <span class="comment">// 属性名字</span></span><br><span class="line">                            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrName&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="attr">&quot;attr_value_agg&quot;</span>:&#123; <span class="comment">// 属性的值</span></span><br><span class="line">                            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;attrs.attrValue&quot;</span>,</span><br><span class="line">                                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="业务代码"   >
          <a href="#业务代码" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#业务代码"></a> 业务代码</h3>
      
<p>整体逻辑：</p>
<ul>
<li>前端发送用户选择的检索条件</li>
<li>Spring MVC 将前端发来的请求中的查询参数自动封装到 <code>SearchParam</code> 对象中</li>
<li>Service 层负责根据 <code>SearchParam</code> 去 ES 中检索出符合的商品数据 <code>SkuEsModel</code>，并将其涉及到的品牌、商品分类以及商品属性等信息封装到 <code>SearchResult</code> 中</li>
<li>Spring MVC 将 <code>SearchResult</code> 放到请求域中转发给检索页 <code>search.html</code>，其进行数据渲染</li>
</ul>
<p>Controller 层代码：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Spring MVC 会将前端发来的请求中的查询参数自动封装到 SearchParam 对象中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchParam</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(value = &#123;&quot;/search.html&quot;,&quot;/&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getSearchPage</span><span class="params">(SearchParam searchParam, Model model, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取前端传来的完整查询条件</span></span><br><span class="line">    searchParam.set_queryString(request.getQueryString());</span><br><span class="line">    SearchResult result = mallSearchService.getSearchResult(searchParam);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;search&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>Service 层代码：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yuyun zhao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/1/9 17:41</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MallSearchSeviceImpl</span> <span class="keyword">implements</span> <span class="title">MallSearchService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SearchResult <span class="title">getSearchResult</span><span class="params">(SearchParam searchParam)</span> </span>&#123;</span><br><span class="line">        SearchResult searchResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 1. 准备检索请求</span></span><br><span class="line">        SearchRequest request = buildSearchRequest(searchParam);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 执行检索请求</span></span><br><span class="line">            SearchResponse searchResponse = restHighLevelClient.search(request, MallElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">            <span class="comment">// 3. 分析响应数据，将结果封装成 searchResult</span></span><br><span class="line">            searchResult = buildSearchResult(searchParam, searchResponse);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> searchResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SearchResult <span class="title">buildSearchResult</span><span class="params">(SearchParam searchParam, SearchResponse searchResponse)</span> </span>&#123;</span><br><span class="line">        SearchResult result = <span class="keyword">new</span> SearchResult();</span><br><span class="line">        SearchHits hits = searchResponse.getHits();</span><br><span class="line">        <span class="comment">//1. 封装查询到的商品信息</span></span><br><span class="line">        <span class="keyword">if</span> (hits.getHits() != <span class="keyword">null</span> &amp;&amp; hits.getHits().length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            List&lt;SkuEsModel&gt; skuEsModels = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : hits) &#123;</span><br><span class="line">                String sourceAsString = hit.getSourceAsString();</span><br><span class="line">                SkuEsModel skuEsModel = JSON.parseObject(sourceAsString, SkuEsModel.class);</span><br><span class="line">                <span class="comment">//设置高亮属性</span></span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">                    HighlightField skuTitle = hit.getHighlightFields().get(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">                    String highLight = skuTitle.getFragments()[<span class="number">0</span>].string();</span><br><span class="line">                    skuEsModel.setSkuTitle(highLight);</span><br><span class="line">                &#125;</span><br><span class="line">                skuEsModels.add(skuEsModel);</span><br><span class="line">            &#125;</span><br><span class="line">            result.setProduct(skuEsModels);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 封装分页信息</span></span><br><span class="line">        <span class="comment">//2.1 当前页码</span></span><br><span class="line">        result.setPageNum(searchParam.getPageNum());</span><br><span class="line">        <span class="comment">//2.2 总记录数</span></span><br><span class="line">        <span class="keyword">long</span> total = hits.getTotalHits().value;</span><br><span class="line">        result.setTotal(total);</span><br><span class="line">        <span class="comment">//2.3 总页码</span></span><br><span class="line">        Integer totalPages = (<span class="keyword">int</span>) total % EsConstant.PRODUCT_PAGESIZE == <span class="number">0</span> ?</span><br><span class="line">            (<span class="keyword">int</span>) total / EsConstant.PRODUCT_PAGESIZE : (<span class="keyword">int</span>) total / EsConstant.PRODUCT_PAGESIZE + <span class="number">1</span>;</span><br><span class="line">        result.setTotalPages(totalPages);</span><br><span class="line">        List&lt;Integer&gt; pageNavs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= totalPages; i++) &#123;</span><br><span class="line">            pageNavs.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        result.setPageNavs(pageNavs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 查询结果涉及到的品牌</span></span><br><span class="line">        List&lt;SearchResult.BrandVo&gt; brandVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Aggregations aggregations = searchResponse.getAggregations();</span><br><span class="line">        <span class="comment">//ParsedLongTerms用于接收terms聚合的结果，并且可以把key转化为Long类型的数据</span></span><br><span class="line">        ParsedLongTerms brandAgg = aggregations.get(<span class="string">&quot;brandAgg&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : brandAgg.getBuckets()) &#123;</span><br><span class="line">            <span class="comment">//3.1 得到品牌id</span></span><br><span class="line">            Long brandId = bucket.getKeyAsNumber().longValue();</span><br><span class="line"></span><br><span class="line">            Aggregations subBrandAggs = bucket.getAggregations();</span><br><span class="line">            <span class="comment">//3.2 得到品牌图片</span></span><br><span class="line">            ParsedStringTerms brandImgAgg = subBrandAggs.get(<span class="string">&quot;brandImgAgg&quot;</span>);</span><br><span class="line">            String brandImg = brandImgAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">            <span class="comment">//3.3 得到品牌名字</span></span><br><span class="line">            Terms brandNameAgg = subBrandAggs.get(<span class="string">&quot;brandNameAgg&quot;</span>);</span><br><span class="line">            String brandName = brandNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">            SearchResult.BrandVo brandVo = <span class="keyword">new</span> SearchResult.BrandVo(brandId, brandName, brandImg);</span><br><span class="line">            brandVos.add(brandVo);</span><br><span class="line">        &#125;</span><br><span class="line">        result.setBrands(brandVos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 查询涉及到的所有分类</span></span><br><span class="line">        List&lt;SearchResult.CatalogVo&gt; catalogVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        ParsedLongTerms catalogAgg = aggregations.get(<span class="string">&quot;catalogAgg&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : catalogAgg.getBuckets()) &#123;</span><br><span class="line">            <span class="comment">//4.1 获取分类id</span></span><br><span class="line">            Long catalogId = bucket.getKeyAsNumber().longValue();</span><br><span class="line">            Aggregations subcatalogAggs = bucket.getAggregations();</span><br><span class="line">            <span class="comment">//4.2 获取分类名</span></span><br><span class="line">            ParsedStringTerms catalogNameAgg = subcatalogAggs.get(<span class="string">&quot;catalogNameAgg&quot;</span>);</span><br><span class="line">            String catalogName = catalogNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">            SearchResult.CatalogVo catalogVo = <span class="keyword">new</span> SearchResult.CatalogVo(catalogId, catalogName);</span><br><span class="line">            catalogVos.add(catalogVo);</span><br><span class="line">        &#125;</span><br><span class="line">        result.setCatalogs(catalogVos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5 查询涉及到的所有属性</span></span><br><span class="line">        List&lt;SearchResult.AttrVo&gt; attrVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//ParsedNested用于接收内置属性的聚合</span></span><br><span class="line">        ParsedNested parsedNested = aggregations.get(<span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">        ParsedLongTerms attrIdAgg = parsedNested.getAggregations().get(<span class="string">&quot;attrIdAgg&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : attrIdAgg.getBuckets()) &#123;</span><br><span class="line">            <span class="comment">//5.1 查询属性id</span></span><br><span class="line">            Long attrId = bucket.getKeyAsNumber().longValue();</span><br><span class="line"></span><br><span class="line">            Aggregations subAttrAgg = bucket.getAggregations();</span><br><span class="line">            <span class="comment">//5.2 查询属性名</span></span><br><span class="line">            ParsedStringTerms attrNameAgg = subAttrAgg.get(<span class="string">&quot;attrNameAgg&quot;</span>);</span><br><span class="line">            String attrName = attrNameAgg.getBuckets().get(<span class="number">0</span>).getKeyAsString();</span><br><span class="line">            <span class="comment">//5.3 查询属性值</span></span><br><span class="line">            ParsedStringTerms attrValueAgg = subAttrAgg.get(<span class="string">&quot;attrValueAgg&quot;</span>);</span><br><span class="line">            List&lt;String&gt; attrValues = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Terms.Bucket attrValueAggBucket : attrValueAgg.getBuckets()) &#123;</span><br><span class="line">                String attrValue = attrValueAggBucket.getKeyAsString();</span><br><span class="line">                attrValues.add(attrValue);</span><br><span class="line">                List&lt;SearchResult.NavVo&gt; navVos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            SearchResult.AttrVo attrVo = <span class="keyword">new</span> SearchResult.AttrVo(attrId, attrName, attrValues);</span><br><span class="line">            attrVos.add(attrVo);</span><br><span class="line">        &#125;</span><br><span class="line">        result.setAttrs(attrVos);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 构建面包屑导航</span></span><br><span class="line">        List&lt;String&gt; attrs = searchParam.getAttrs();</span><br><span class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span> &amp;&amp; attrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            List&lt;SearchResult.NavVo&gt; navVos = attrs.stream().map(attr -&gt; &#123;</span><br><span class="line">                String[] split = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">                SearchResult.NavVo navVo = <span class="keyword">new</span> SearchResult.NavVo();</span><br><span class="line">                <span class="comment">//6.1 设置属性值</span></span><br><span class="line">                navVo.setNavValue(split[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">//6.2 查询并设置属性名</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    R r = productFeignService.info(Long.parseLong(split[<span class="number">0</span>]));</span><br><span class="line">                    <span class="keyword">if</span> (r.getCode() == <span class="number">0</span>) &#123;</span><br><span class="line">                        AttrResponseVo attrResponseVo = JSON.parseObject(JSON.toJSONString(r.get(<span class="string">&quot;attr&quot;</span>)), <span class="keyword">new</span> TypeReference&lt;AttrResponseVo&gt;() &#123;</span><br><span class="line">                        &#125;);</span><br><span class="line">                        navVo.setNavName(attrResponseVo.getAttrName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;远程调用商品服务查询属性失败&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//6.3 设置面包屑跳转链接</span></span><br><span class="line">                String queryString = searchParam.get_queryString();</span><br><span class="line">                String replace = queryString.replace(<span class="string">&quot;&amp;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr+<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;attrs=&quot;</span> + attr, <span class="string">&quot;&quot;</span>);</span><br><span class="line">                navVo.setLink(<span class="string">&quot;http://search.gulimall.com/search.html&quot;</span> + (replace.isEmpty()?<span class="string">&quot;&quot;</span>:<span class="string">&quot;?&quot;</span>+replace));</span><br><span class="line">                <span class="keyword">return</span> navVo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">            result.setNavs(navVos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SearchRequest <span class="title">buildSearchRequest</span><span class="params">(SearchParam searchParam)</span> </span>&#123;</span><br><span class="line">        SearchSourceBuilder searchSourceBuilder = <span class="keyword">new</span> SearchSourceBuilder();</span><br><span class="line">        <span class="comment">//1. 构建bool query</span></span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = <span class="keyword">new</span> BoolQueryBuilder();</span><br><span class="line">        <span class="comment">//1.1 bool must</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">            boolQueryBuilder.must(QueryBuilders.matchQuery(<span class="string">&quot;skuTitle&quot;</span>, searchParam.getKeyword()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.2 bool filter</span></span><br><span class="line">        <span class="comment">//1.2.1 catalog</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getCatalog3Id() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;catalogId&quot;</span>, searchParam.getCatalog3Id()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.2 brand</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getBrandId() != <span class="keyword">null</span> &amp;&amp; searchParam.getBrandId().size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termsQuery(<span class="string">&quot;brandId&quot;</span>, searchParam.getBrandId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.3 hasStock</span></span><br><span class="line">        <span class="keyword">if</span> (searchParam.getHasStock() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            boolQueryBuilder.filter(QueryBuilders.termQuery(<span class="string">&quot;hasStock&quot;</span>, searchParam.getHasStock() == <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.4 priceRange</span></span><br><span class="line">        RangeQueryBuilder rangeQueryBuilder = QueryBuilders.rangeQuery(<span class="string">&quot;skuPrice&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getSkuPrice())) &#123;</span><br><span class="line">            String[] prices = searchParam.getSkuPrice().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (prices.length == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (searchParam.getSkuPrice().startsWith(<span class="string">&quot;_&quot;</span>)) &#123;</span><br><span class="line">                    rangeQueryBuilder.lte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    rangeQueryBuilder.gte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prices.length == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="comment">//_6000会截取成[&quot;&quot;,&quot;6000&quot;]</span></span><br><span class="line">                <span class="keyword">if</span> (!prices[<span class="number">0</span>].isEmpty()) &#123;</span><br><span class="line">                    rangeQueryBuilder.gte(Integer.parseInt(prices[<span class="number">0</span>]));</span><br><span class="line">                &#125;</span><br><span class="line">                rangeQueryBuilder.lte(Integer.parseInt(prices[<span class="number">1</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            boolQueryBuilder.filter(rangeQueryBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1.2.5 attrs-nested</span></span><br><span class="line">        <span class="comment">//attrs=1_5寸:8寸&amp;2_16G:8G</span></span><br><span class="line">        List&lt;String&gt; attrs = searchParam.getAttrs();</span><br><span class="line">        BoolQueryBuilder queryBuilder = <span class="keyword">new</span> BoolQueryBuilder();</span><br><span class="line">        <span class="keyword">if</span> (attrs != <span class="keyword">null</span> &amp;&amp; attrs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            attrs.forEach(attr -&gt; &#123;</span><br><span class="line">                String[] attrSplit = attr.split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">                queryBuilder.must(QueryBuilders.termQuery(<span class="string">&quot;attrs.attrId&quot;</span>, attrSplit[<span class="number">0</span>]));</span><br><span class="line">                String[] attrValues = attrSplit[<span class="number">1</span>].split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">                queryBuilder.must(QueryBuilders.termsQuery(<span class="string">&quot;attrs.attrValue&quot;</span>, attrValues));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        NestedQueryBuilder nestedQueryBuilder = QueryBuilders.nestedQuery(<span class="string">&quot;attrs&quot;</span>, queryBuilder, ScoreMode.None);</span><br><span class="line">        boolQueryBuilder.filter(nestedQueryBuilder);</span><br><span class="line">        <span class="comment">//1. bool query构建完成</span></span><br><span class="line">        searchSourceBuilder.query(boolQueryBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. sort  eg:sort=saleCount_desc/asc</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getSort())) &#123;</span><br><span class="line">            String[] sortSplit = searchParam.getSort().split(<span class="string">&quot;_&quot;</span>);</span><br><span class="line">            searchSourceBuilder.sort(sortSplit[<span class="number">0</span>], sortSplit[<span class="number">1</span>].equalsIgnoreCase(<span class="string">&quot;asc&quot;</span>) ? SortOrder.ASC : SortOrder.DESC);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 分页</span></span><br><span class="line">        searchSourceBuilder.from((searchParam.getPageNum() - <span class="number">1</span>) * EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line">        searchSourceBuilder.size(EsConstant.PRODUCT_PAGESIZE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 高亮highlight</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(searchParam.getKeyword())) &#123;</span><br><span class="line">            HighlightBuilder highlightBuilder = <span class="keyword">new</span> HighlightBuilder();</span><br><span class="line">            highlightBuilder.field(<span class="string">&quot;skuTitle&quot;</span>);</span><br><span class="line">            highlightBuilder.preTags(<span class="string">&quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;</span>);</span><br><span class="line">            highlightBuilder.postTags(<span class="string">&quot;&lt;/b&gt;&quot;</span>);</span><br><span class="line">            searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 聚合</span></span><br><span class="line">        <span class="comment">//5.1 按照brand聚合</span></span><br><span class="line">        TermsAggregationBuilder brandAgg = AggregationBuilders.terms(<span class="string">&quot;brandAgg&quot;</span>).field(<span class="string">&quot;brandId&quot;</span>);</span><br><span class="line">        TermsAggregationBuilder brandNameAgg = AggregationBuilders.terms(<span class="string">&quot;brandNameAgg&quot;</span>).field(<span class="string">&quot;brandName&quot;</span>);</span><br><span class="line">        TermsAggregationBuilder brandImgAgg = AggregationBuilders.terms(<span class="string">&quot;brandImgAgg&quot;</span>).field(<span class="string">&quot;brandImg&quot;</span>);</span><br><span class="line">        brandAgg.subAggregation(brandNameAgg);</span><br><span class="line">        brandAgg.subAggregation(brandImgAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(brandAgg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.2 按照catalog聚合</span></span><br><span class="line">        TermsAggregationBuilder catalogAgg = AggregationBuilders.terms(<span class="string">&quot;catalogAgg&quot;</span>).field(<span class="string">&quot;catalogId&quot;</span>);</span><br><span class="line">        TermsAggregationBuilder catalogNameAgg = AggregationBuilders.terms(<span class="string">&quot;catalogNameAgg&quot;</span>).field(<span class="string">&quot;catalogName&quot;</span>);</span><br><span class="line">        catalogAgg.subAggregation(catalogNameAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(catalogAgg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5.3 按照attrs聚合</span></span><br><span class="line">        NestedAggregationBuilder nestedAggregationBuilder = <span class="keyword">new</span> NestedAggregationBuilder(<span class="string">&quot;attrs&quot;</span>, <span class="string">&quot;attrs&quot;</span>);</span><br><span class="line">        <span class="comment">//按照attrId聚合</span></span><br><span class="line">        TermsAggregationBuilder attrIdAgg = AggregationBuilders.terms(<span class="string">&quot;attrIdAgg&quot;</span>).field(<span class="string">&quot;attrs.attrId&quot;</span>);</span><br><span class="line">        <span class="comment">//按照attrId聚合之后再按照attrName和attrValue聚合</span></span><br><span class="line">        TermsAggregationBuilder attrNameAgg = AggregationBuilders.terms(<span class="string">&quot;attrNameAgg&quot;</span>).field(<span class="string">&quot;attrs.attrName&quot;</span>);</span><br><span class="line">        TermsAggregationBuilder attrValueAgg = AggregationBuilders.terms(<span class="string">&quot;attrValueAgg&quot;</span>).field(<span class="string">&quot;attrs.attrValue&quot;</span>);</span><br><span class="line">        attrIdAgg.subAggregation(attrNameAgg);</span><br><span class="line">        attrIdAgg.subAggregation(attrValueAgg);</span><br><span class="line"></span><br><span class="line">        nestedAggregationBuilder.subAggregation(attrIdAgg);</span><br><span class="line">        searchSourceBuilder.aggregation(nestedAggregationBuilder);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">&quot;构建的DSL语句 &#123;&#125;&quot;</span>, searchSourceBuilder.toString());</span><br><span class="line"></span><br><span class="line">        SearchRequest request = <span class="keyword">new</span> SearchRequest(<span class="keyword">new</span> String[]&#123;EsConstant.PRODUCT_INDEX&#125;, searchSourceBuilder);</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://yuyun-zhao.github.io">yuyun zhao</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://yuyun-zhao.github.io/2021/12/11/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/">http://yuyun-zhao.github.io/2021/12/11/%E3%80%90ElasticSearch%E3%80%91ElasticSearch/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/ElasticSearch/">ElasticSearch</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/12/14/%E3%80%90%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%91%E5%A0%86/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">【数据结构】堆</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/12/09/%E3%80%90Java%E3%80%91JSR303%E6%95%B0%E6%8D%AE%E6%A0%A1%E9%AA%8C/"><span class="paginator-prev__text">【Java】JSR 303 数据校验</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">
           简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E"><span class="toc-text">
           全文搜索引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elk"><span class="toc-text">
           ELK</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elasticsearch-%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="toc-text">
           Elasticsearch 应用案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lucene"><span class="toc-text">
           Lucene</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#solr-%E7%AE%80%E4%BB%8B"><span class="toc-text">
           Solr 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#es-%E5%92%8C-solr"><span class="toc-text">
           ES 和 Solr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">
           总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">
           环境搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-text">
           核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E8%AE%BE%E8%AE%A1"><span class="toc-text">
           物理设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1"><span class="toc-text">
           逻辑设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E7%89%87"><span class="toc-text">
           分片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">
           倒排索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-text">
           基础增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3"><span class="toc-text">
           创建文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">
           查询文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E6%96%87%E6%A1%A3"><span class="toc-text">
           修改文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">
           删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bulk-%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="toc-text">
           bulk 批量操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_cat"><span class="toc-text">
           _cat</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2"><span class="toc-text">
           复杂查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D"><span class="toc-text">
           匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">
           复合查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E4%BA%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">
           高亮查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">
           聚合查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nested"><span class="toc-text">
           nested</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E6%98%A0%E5%B0%84"><span class="toc-text">
           类型映射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%98%A0%E5%B0%84"><span class="toc-text">
           创建映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E7%B4%A2%E5%BC%95%E9%97%B4%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="toc-text">
           不同索引间的数据迁移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#java-high-level-rest-client"><span class="toc-text">
           Java High Level REST Client</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-text">
           配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E7%B4%A2%E5%BC%95"><span class="toc-text">
           操作索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3"><span class="toc-text">
           操作文档</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%AF%8D"><span class="toc-text">
           分词</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-ik-%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">
           安装 ik 分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="toc-text">
           自定义词库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-text">
           实战案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="toc-text">
           数据模型设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E7%B4%A2-dsl-%E8%AF%AD%E5%8F%A5"><span class="toc-text">
           检索 DSL 语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BB%A3%E7%A0%81"><span class="toc-text">
           业务代码</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/author.png" alt="avatar"></div><p class="sidebar-ov-author__text">no code no life</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/YUYUN-ZHAO" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="zyy18749810683" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="1024462136" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:im.yuyunzhao@gmail.com" target="_blank" rel="noopener" data-popover="social.Gmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gmail</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">144</div><div class="sidebar-ov-state-item__name">文章</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">39</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">39</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>yuyun zhao</span><span class="footer__devider">|</span><span>沪ICP备2022000458号</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>