<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/Q%E7%89%88%E5%A4%B4%E5%83%8F32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="本文将逐一介绍Spring Boot中的原理 常用的自动配置类xxxAutoConfiguration：  AopAutoConfiguration：AOP自动配置类 DispatcherServletAutoConfiguration：DispatcherServlet自动配置类 WebMvcAutoConfiguration：WebMVC相关自动配置类 ServletWebServerFact">
<meta property="og:type" content="article">
<meta property="og:title" content="【Spring Boot】Spring Boot2 源码分析">
<meta property="og:url" content="http://yuyun-zhao.github.io/2021/07/12/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="yuyun zhao&#39;s blog">
<meta property="og:description" content="本文将逐一介绍Spring Boot中的原理 常用的自动配置类xxxAutoConfiguration：  AopAutoConfiguration：AOP自动配置类 DispatcherServletAutoConfiguration：DispatcherServlet自动配置类 WebMvcAutoConfiguration：WebMVC相关自动配置类 ServletWebServerFact">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210809210934337.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711201544965.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202049677.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202306425.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203848177.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202745443.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203253301.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203525691.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203725837.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203855246.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711211618512.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210804150325041.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711213124840.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711213412654.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723132157765.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723132356529.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723161237562.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723164630095.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720095314175.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723171723749.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723171856063.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723192029596.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715100050957.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807111225531.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807112649353.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807142357270.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807143433400.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807144851940.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807145011358.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807155031104.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807160226619.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807155131164.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155426532.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155701782.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155917510.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818160118910.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818161738903.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731205850800.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163040938.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715162521522.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715162814683.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163548801.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163935578.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715164354367.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803202035420.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803203720388.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803204836013.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803212019087.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801203151706.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801203234072.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801204553429.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801204739367.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801205746126.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801210620885.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801214140507.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720135457338.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720094927124.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720095314175-1627472434897.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101836077.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720105316770.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720141752006.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720141620095.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210728215546942.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720144223605.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153751013.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725215637180.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161349706.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153751013.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725215637180.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725171847138.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161223870.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163554136.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212435861.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725163947016.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212341993.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163420298-1627527227460.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724165301621.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724152930296.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153442677.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725153449237.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725153121790.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212958379.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801213316328.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801214140507.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715151056836.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163554136-1627531852946.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165354073.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165951720.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165001942.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725164443575.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165951720.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725210434816.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725210610893.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725211316411.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725221333706.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725220853504.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725223637931.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726140103808.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725171847138.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726142110761.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726143359134.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724154755603.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726142110761.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725193659805.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726160912631.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726162256930.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210729210852492.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164955683.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100112607.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164303895.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100940697.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727094454018.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727101036395.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727101559706.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164955683.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726190152432.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726190609377.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726191949357.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727145909685.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727150016279.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730101533304.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730103255329.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100940697.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730104019859.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730103149685.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727141446187.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727142409445.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727193857347.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731203910807.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731205850800.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725201730427.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731210317048.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212421271.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731210848419.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731211417134.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731211605005.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212028693.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212427561.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725202336384.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802215420259.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802164252572.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802190349481.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205927018.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802191937364.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802213620722.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802192305382.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802185022754.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802191120478.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802201853375.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802212022373.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802202538535.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802204759380.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802211043922.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802212022373.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205006071.png">
<meta property="og:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205927018.png">
<meta property="article:published_time" content="2021-07-12T08:13:45.000Z">
<meta property="article:modified_time" content="2021-09-14T06:31:30.164Z">
<meta property="article:author" content="yuyun zhao">
<meta property="article:tag" content="Spring">
<meta property="article:tag" content="源码分析">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yuyun-zhao.github.io/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210809210934337.png"><title>【Spring Boot】Spring Boot2 源码分析 | yuyun zhao's blog</title><link ref="canonical" href="http://yuyun-zhao.github.io/2021/07/12/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">文章</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/about/"><span class="header-nav-menu-item__icon"><i class="fas fa-fingerprint"></i></span><span class="header-nav-menu-item__text">关于</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">yuyun zhao's blog</div><div class="header-banner-info__subtitle">no code no life</div></div><div class="header-banner-arrow"><div class="header-banner-arrow__icon"><i class="fas fa-angle-down"></i></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><div class="sticky-top" data-popover="置顶文章" data-popover-pos="up"><span class="sticky-top__icon"><i class="fas fa-thumbtack"></i></span></div><h1 class="post-title">【Spring Boot】Spring Boot2 源码分析</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-07-12</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-09-14</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">18.8k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">128分</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body"><p>本文将逐一介绍Spring Boot中的原理</p>
<p>常用的自动配置类<strong>xxxAutoConfiguration</strong>：</p>
<ul>
<li><strong>AopAutoConfiguration</strong>：AOP自动配置类</li>
<li><strong>DispatcherServletAutoConfiguration</strong>：DispatcherServlet自动配置类</li>
<li><strong>WebMvcAutoConfiguration</strong>：WebMVC相关自动配置类</li>
<li><strong>ServletWebServerFactoryAutoConfiguration</strong>：ServletWebServerFactory自动配置类</li>
<li><strong>MultipartAutoConfiguration</strong>：文件上传自动配置类</li>
<li><strong>ErrorMvcAutoConfiguration</strong>：异常处理自动配置类</li>
<li><strong>DataSourceAutoConfiguration</strong>：数据源自动配置类</li>
<li><strong>MybatisAutoConfiguration</strong>：MyBatis自动配置类（第三方）</li>
<li><strong>RedisAutoConfiguration：Redis</strong>自动配置类</li>
</ul>
<p>Spring里用到的设计模式：工厂模式，动态代理模式，责任链模式，</p>
<p>策略模式？</p>
<span id="more"></span>
<p>初始化时调用ServletContextListener的contextInitialization 用来创建IOC</p>
<p>里面createWebapplicationContext -&gt; ioc</p>
<p>spring web项目 启动流程 先listener 再 servlet</p>

        <h2 id="自动配置原理"   >
          <a href="#自动配置原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自动配置原理"></a> 自动配置原理</h2>
      

        <h3 id="依赖管理"   >
          <a href="#依赖管理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#依赖管理"></a> 依赖管理</h3>
      
<p>当前新建的Spring Boot项目的父项目：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>其父项目又依赖<code>spring-boot-dependencies.pom</code>：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>该文件中声明了开发中常用的jar包版本，因此其子项目中不需要给依赖写上版本号，会自动导入父项目里版本的jar包。该特性被称为<strong>版本仲裁</strong>。</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activemq.version</span>&gt;</span>5.15.13<span class="tag">&lt;/<span class="name">activemq.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">antlr2.version</span>&gt;</span>2.7.7<span class="tag">&lt;/<span class="name">antlr2.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">appengine-sdk.version</span>&gt;</span>1.9.82<span class="tag">&lt;/<span class="name">appengine-sdk.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artemis.version</span>&gt;</span>2.12.0<span class="tag">&lt;/<span class="name">artemis.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">aspectj.version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">aspectj.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">assertj.version</span>&gt;</span>3.16.1<span class="tag">&lt;/<span class="name">assertj.version</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

        <h4 id="自定义依赖版本"   >
          <a href="#自定义依赖版本" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自定义依赖版本"></a> 自定义依赖版本</h4>
      
<p>若想自定义修改依赖的版本，则只需要在当前项目里指定配置版本号，其会覆盖父项目中的默认版本号。</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.43<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

        <h4 id="场景启动器"   >
          <a href="#场景启动器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#场景启动器"></a> 场景启动器</h4>
      
<p><code>spring-boot-starter-*</code> 代表某种场景，只要引入了该starter，这个场景的所有依赖都会自动引入。第三方提供的简化开发的场景启动器命名格式：<code>*-spring-boot-starter</code>。<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters" >官方所有支持的Starter</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>所有场景启动器最底层的依赖，<strong>SpringBoot自动配置的核心依赖</strong>：<strong>spring-boot-starter</strong></p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>该starter场景将导入Spring Boot提供的127种自动配置类<strong>xxxAutoConfiguration</strong>，这些自动配置类将导入许多常用的组件用于简化开发（例如<code>DispatcherServlet</code>等），无需开发人员手动添加这些组件。</p>
<p><code>spring-boot-starter.pom</code>的主要内容：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- This module was also published with a richer model, Gradle metadata,  --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- which should be used instead. Do not delete the following line which  --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- is to indicate to Gradle or any Gradle module metadata file consumer  --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- that they should prefer consuming it instead. --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- do_not_remove: published-with-gradle-metadata --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Core starter, including auto-configuration support, logging and YAML<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jakarta.annotation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jakarta.annotation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.3.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="场景启动器starter工作原理"   >
          <a href="#场景启动器starter工作原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#场景启动器starter工作原理"></a> 场景启动器starter工作原理</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210809210934337.png" alt="image-20210809210934337" /></p>
<p>场景启动器工作原理的本质：调用的<code>xxx-starter</code>项目导入的所有<code>xxx-autoconfigure</code>项目中编写了许多自动配置类<code>xxxAutoConfiguration</code>，这些自动配置类将在Spring Boot启动时被注册到容器中，从而将其内编写的组件按照条件注册到容器中，因此开发人员可以在自己的项目中调用到这些组件。</p>

        <h3 id="自动配置原理-2"   >
          <a href="#自动配置原理-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自动配置原理-2"></a> 自动配置原理</h3>
      
<p>SpringBoot的主程序类（标有 <strong>@SpringBootApplication</strong>注解的类）<strong>所在包及其下面的所有子包</strong>里面的组件都会被默认扫描进来，这些组件不再需要额外指定扫描路径。而若想要扫描其他路径下的组件，则可以在主程序类上添加：</p>
<ul>
<li><code>@SpringBootApplication(scanBasePackages=&quot;com.zhao.xxx&quot;)</code></li>
<li><code>@ComponentScan(&quot;com.zhao.xxx&quot;)</code></li>
</ul>
<p><code>@SpringBootApplication</code>是一个合成注解，其效果等同于下面三个注解的组合。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.zhao.xxx&quot;)</span></span><br></pre></td></tr></table></div></figure>
<p>Spring Boot的各种配置都拥有默认值。这些默认配置最终都是映射到某个类上，如：<code>MultipartProperties</code>。配置文件的值最终会绑定在某个类上，这个类会在容器中创建对象。</p>
<p>Spring Boot所有的<strong>自动配置功能</strong>都在 <code>spring-boot-autoconfigure</code> 包里面（第三方的starter场景也有相应的<code>xxx-autoconfigure</code>包）。</p>
<p><strong>@SpringBootApplication</strong>是一个合成注解，其效果等同于下面三个注解的组合：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(</span></span><br><span class="line"><span class="meta">    excludeFilters = &#123;@Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;TypeExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">), @Filter(</span></span><br><span class="line"><span class="meta">    type = FilterType.CUSTOM,</span></span><br><span class="line"><span class="meta">    classes = &#123;AutoConfigurationExcludeFilter.class&#125;</span></span><br><span class="line"><span class="meta">)&#125;</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication </span><br></pre></td></tr></table></div></figure>
<p>下面逐一分析上述三者的作用</p>

        <h3 id="1-springbootconfiguration"   >
          <a href="#1-springbootconfiguration" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#1-springbootconfiguration"></a> 1、@SpringBootConfiguration</h3>
      
<p>表明被 <strong>@SpringBootApplication</strong> 修饰的类本质上也是一个 <strong>@Configuration</strong> 配置类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration</span><br></pre></td></tr></table></div></figure>

        <h3 id="2-componentscan"   >
          <a href="#2-componentscan" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#2-componentscan"></a> 2、@ComponentScan</h3>
      
<p>指定要扫描的组件（按照<code>@Filter</code>里设置的类型过滤一些组件）</p>

        <h3 id="3-enableautoconfiguration"   >
          <a href="#3-enableautoconfiguration" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#3-enableautoconfiguration"></a> 3、@EnableAutoConfiguration</h3>
      
<p>重点，自动配置是通过该注解实现的。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration</span><br></pre></td></tr></table></div></figure>
<p><strong>3.1、@AutoConfigurationPackage：自动配置包，将MainApplication主程序类所在包下的所有组件注册到容器中</strong></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Import(&#123;Registrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage</span><br></pre></td></tr></table></div></figure>
<p>该注解通过<code>@Import</code>注解向容器中导入了一个<strong>Registrar</strong>组件，该组件实现了<code>ImportBeanDefinitionRegistrar</code>接口（<a href="https://yuyun-zhao.github.io/2021/06/28/%E3%80%90Spring%E3%80%91Spring5-%E6%BA%90%E7%A0%81%E4%B8%AD%E5%B8%B8%E7%94%A8%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">【Spring】Spring5 源码中常用接口的底层原理</a>），其作用是<strong>将MainApplication主程序类所在包下的所有组件都注册到容器中</strong>。这也解释了默认的扫描包路径为<code>MainApplication</code>所在包的路径。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711201544965.png" alt="image-20210711201544965" /></p>
<p>其中传入的参数<code>AnnotationMetadata metadata</code>是指SpringBoot主程序类<code>MainApplication</code>的注解元信息，用于获取其所在的包路径，从而将该包下的所有子包下的类都注册到容器中。</p>
<p><strong>3.2、@Import({AutoConfigurationImportSelector.class})：向容器中注册自动配置类</strong></p>
<p><strong>第一步：引导加载自动配置类</strong></p>
<p>该注解向容器中注册了<strong>AutoConfigurationImportSelector</strong>类型的组件，该类的重要方法  <strong>selectImports()</strong> 中利用 <strong>getAutoConfigurationEntry(annotationMetadata)</strong>  方法向容器中导入一些<strong>自动配置类</strong>组件（先获取所有的自动配置类，再根据实际情况筛选出符合条件的自动配置类注册到容器中）。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202049677.png" alt="image-20210711202049677" /></p>
<p>进入<code>getAutoConfigurationEntry(annotationMetadata)</code>方法后，首先调用<code>getCandidateConfigurations()</code>方法获取所有<strong>候选</strong>的自动配置类组件（AutoConfiguration），共有127个。并在后续进行删选后<strong>按需开启</strong>自动配置项（即用不到的自动配置类无需开启）。</p>
<p>获取这些<code>AutoConfiguration</code>的具体过程：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202306425.png" alt="image-20210711202306425" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203848177.png" alt="image-20210711203848177" /></p>
<p>在<code>getCandidateConfigurations()</code>方法内通过<code>SpringFactoriesLoader</code>工厂加载器加载一些组件。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711202745443.png" alt="image-20210711202745443" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203253301.png" alt="image-20210711203253301" /></p>
<p>在该方法内使用类加载器读取<code>&quot;META-INF/spring.factories&quot;</code>位置处的资源文件。有些包下有这个文件，比如最关键的<code>spring-boot-autoconfigure-2.3.4.RELEASE.jar</code>包（导入的其他第三方包中也可以会含有<code>&quot;META-INF/spring.factories&quot;</code>文件，例如MyBatis的<code>mybatis-spring-boot-autoconfigure-2.1.4.jar</code>包也会有该文件，Spring Boot启动时也会加载该包下的<code>xxxAutoConfiguration</code>类）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203525691.png" alt="image-20210711203525691" /></p>
<p>该文件内配置了Spring Boot启动时就要向容器中加载的所有自动配置类（<strong>xxxAutoConfiguration</strong>）（共127个，正好对应上文中的127个自动配置类组件）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203725837.png" alt="image-20210711203725837" /></p>
<p>上文中注册到容器中的127个自动配置类组件<code>configurations</code>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711203855246.png" alt="image-20210711203855246" /></p>
<p>但这127个自动配置类并不会都注册到容器中，而会按需开启。</p>
<p><strong>第二步：按需开启自动配置项</strong></p>
<p>虽然上述127个自动配置类在启动的时候会默认全部加载，但每个<code>xxxAutoConfiguration</code>会按照条件装配规则（<strong>@Conditional</strong>）<strong>按需配置</strong>。</p>
<p>以<code>BatchAutoConfiguration</code>类为例，该类因<code>@ConditionalOnClass(&#123;JobLauncher.class, DataSource.class&#125;)</code>的存在，若想被注册到容器中，需要满足当前项目中有<code>JobLauncher</code>类的存在，但若开发人员没有导入该类相关的maven依赖，则无法找到该类，因此该自动配置类将不会被注册到容器中。因此上述127个自动配置类会按照实际容器中配置组件的情况按需注册到容器中，不需要的配置类将不会被注册。</p>
<p>同时这些自动配置类里的配置属性通过 <strong>@EnableConfigurationProperties</strong> 注解从<strong>xxxProperties</strong>组件中获取（<code>xxxProperties</code>组件和相应的配置文件绑定在了一起）</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711211618512.png" alt="image-20210711211618512" /></p>
<p>以AOP自动配置器<strong>AopAutoConfiguration</strong>为例：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210804150325041.png" alt="image-20210804150325041" /></p>
<hr />
<p>举例：上文描述了如何向容器中注册常用的自动配置类，下面以web开发必须的自动配置类<strong>DispatcherServletAutoConfiguration</strong>为例：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711213124840.png" alt="image-20210711213124840" /></p>
<p>该自动配置类满足<code>@Conditional</code>的条件，因此会在程序加载时被注册到容器中。同时该自动配置类中会向容器中注册<strong>DispatcherServlet</strong>组件，这正是Spring MVC开发时需要的转发器组件。</p>
<p>也就是说Spring Boot在启动时，会将传统SSM中开发人员配置在xml中的必备组件自动地注册到容器中，无需开发人员再手动注册。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210711213412654.png" alt="image-20210711213412654" /></p>
<hr />
<p><strong>第三步：修改默认配置</strong></p>
<p>以自动配置类<strong>DispatcherServletAutoConfiguration</strong>中的<strong>MultipartResolver</strong>组件为例，该组件为Spring MVC中的文件上传组件，其会被<code>DispatcherServletAutoConfiguration</code>注册到容器中。</p>
<p>其依赖于<strong>MultipartResolver</strong>组件（该组件默认存在于容器中，但开发人员可以再手动注册一个），同时判断该组件的名称是否为指定的<code>MULTIPART_RESOLVER_BEAN_NAME = multipartResolver</code>。</p>
<p>若不是，可能的情况为开发人员自己手动注册了一个，但名称不符合规范。此时容器通过调用<code>multipartResolver()</code>方法注册了该组件，同时注册的组件名就是方法名<strong>multipartResolver</strong>，因此起到<strong>组件名规范化</strong>的效果。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(MultipartResolver.class)</span>  <span class="comment">// 容器中默认有这个类型组件</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = DispatcherServlet.MULTIPART_RESOLVER_BEAN_NAME)</span> <span class="comment">//容器中没有这个名字 multipartResolver 的组件</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MultipartResolver <span class="title">multipartResolver</span><span class="params">(MultipartResolver resolver)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//给@Bean标注的方法传入了对象参数，这个参数的值就会从容器中找。</span></span><br><span class="line">    <span class="comment">//SpringMVC multipartResolver。防止有些用户配置的文件上传解析器不符合规范</span></span><br><span class="line">    <span class="comment">// Detect if the user has created a MultipartResolver but named it incorrectly</span></span><br><span class="line">    <span class="keyword">return</span> resolver;</span><br></pre></td></tr></table></div></figure>
<p>SpringBoot默认会在底层配好所有的组件。但是如果用户自己配置了以用户的优先：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CharacterEncodingFilter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="总结"   >
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
      
<ul>
<li>Spring Boot首先加载所有的自动配置类 <strong>xxxxxAutoConfiguration</strong>（127个）</li>
<li>每个自动配置类按照条件判断进行生效，默认都会绑定配置文件指定的值。（从<strong>xxxxProperties</strong>组件里面读取，<strong>xxxProperties</strong>组件和配置文件进行了绑定）</li>
<li>生效的配置类就会向容器中注册响应的组件</li>
</ul>
<p>定制化配置：</p>
<ul>
<li>开发人员手动使用<code>@Bean</code>替换容器中默认注册的组件；</li>
<li>在配置文件中修改相应配置属性以修改默认组件的属性值</li>
</ul>
<p><strong>xxxxxAutoConfiguration <strong>—&gt; 注册组件 —&gt; 组件属性通过</strong>xxxxProperties</strong>从配置文件<strong>application.properties</strong>中取值</p>
<p>常用的自动配置类<strong>xxxAutoConfiguration</strong>：</p>
<ul>
<li><strong>AopAutoConfiguration</strong>：AOP自动配置类</li>
<li><strong>DispatcherServletAutoConfiguration</strong>：<code>DispatcherServlet</code>自动配置类</li>
<li><strong>WebMvcAutoConfiguration</strong>：<code>WebMVC</code>相关自动配置类</li>
<li><strong>ServletWebServerFactoryAutoConfiguration</strong>：<code>ServletWebServerFactory</code>自动配置类</li>
<li><strong>MultipartAutoConfiguration</strong>：文件上传自动配置类</li>
<li><strong>ErrorMvcAutoConfiguration</strong>：异常处理自动配置类</li>
<li><strong>DataSourceAutoConfiguration</strong>：数据源自动配置类</li>
<li><strong>MybatisAutoConfiguration</strong>：MyBatis自动配置类（第三方）</li>
</ul>

        <h2 id="静态资源原理"   >
          <a href="#静态资源原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#静态资源原理"></a> 静态资源原理</h2>
      
<p>SpringBoot在启动时会默认加载许多<strong>xxxAutoConfiguration</strong>自动配置类，其中包括SpringMVC功能的自动配置类：<strong>WebMvcAutoConfiguration</strong>。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723132157765.png" alt="image-20210723132157765" /></p>
<p>该配置类向容器中添加了许多组件，例如<strong>WebMvcAutoConfigurationAdapter</strong>。</p>

        <h3 id="webmvcautoconfigurationadapter"   >
          <a href="#webmvcautoconfigurationadapter" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#webmvcautoconfigurationadapter"></a> WebMvcAutoConfigurationAdapter</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723132356529.png" alt="image-20210723132356529" /></p>
<p>该类用于解析配置文件中与<strong>mvc</strong>和<strong>resources</strong>相关的配置信息。其中<strong>WebMvcProperties</strong>配置类与<strong>spring.mvc</strong>属性绑定，<strong>ResourceProperties</strong>配置类与<strong>spring.resources</strong>属性绑定。</p>
<p>同时<strong>WebMvcAutoConfigurationAdapter只有一个有参构造器</strong>，该构造器中的所有参数值都将从容器中获取，因此将获取到配置文件中与<strong>mvc</strong>和<strong>resources</strong>相关的配置信息：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723161237562.png" alt="image-20210723161237562" /></p>
<p>其参数有以下几种，都是从容器中获取：</p>
<ul>
<li><strong>ResourceProperties</strong>：获取和<code>spring.resources</code>绑定的所有的值的对象</li>
<li><strong>WebMvcProperties</strong>：获取和<code>spring.mvc</code>绑定的所有的值的对象</li>
<li><strong>ListableBeanFactory</strong>：获取Spring的<code>beanFactory</code></li>
<li><strong>HttpMessageConverters</strong>：找到所有的<code>HttpMessageConverters</code></li>
<li><strong>ResourceHandlerRegistrationCustomizer</strong>：找到资源处理器的自定义器。</li>
<li><strong>DispatcherServletPath</strong></li>
<li><strong>ServletRegistrationBean</strong>：给应用注册Servlet、Filter等组件</li>
</ul>

        <h3 id="资源路径映射原理"   >
          <a href="#资源路径映射原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#资源路径映射原理"></a> 资源路径映射原理</h3>
      
<p><strong>WebMvcAutoConfigurationAdapter</strong>配置类里的<strong>addResourceHandlers</strong>方法完成<strong>静态资源路径映射</strong>的功能：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723164630095.png" alt="image-20210723164630095" /></p>
<p><strong>红色框</strong>：通过配置<code>add-mappings</code>属性可以禁止所有静态资源规则（红色框）。</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">add-mappings:</span> <span class="literal">false</span>   <span class="comment">#禁用所有静态资源规则</span></span><br></pre></td></tr></table></div></figure>
<p><strong>黄色框</strong>：设置<code>webjars</code>的路径映射规则，即从<code>&quot;/webjars/**&quot;</code> 映射成 <code>&quot;classpath:/META-INF/resources/webjars/&quot;</code>，浏览器收到的满足规则的请求都会映射到指定的路径下。</p>
<p><strong>橙色框</strong>：设置静态资源的路径映射规则，即从<strong>staticPathPattern</strong> 映射成 <strong>.getStaticLocations()</strong> 的值，浏览器收到的满足规则的请求都会映射到指定的路径下。</p>
<p>其中<strong>staticPathPattern</strong>值为配置文件中指定的静态资源路径访问前缀（默认为<code>/**</code>）：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/myPath/**</span></span><br></pre></td></tr></table></div></figure>
<p><strong>this.resourceProperties.getStaticLocations()</strong> 的值为配置文件中指定的静态资源路径（默认为<code>/static</code> or<code>/public</code> or<code>/resources</code> or <code>/META-INF/resources</code>）：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">static-locations:</span> [<span class="string">classpath:/static/</span>]</span><br></pre></td></tr></table></div></figure>

        <h3 id="欢迎页的处理规则"   >
          <a href="#欢迎页的处理规则" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#欢迎页的处理规则"></a> 欢迎页的处理规则</h3>
      
<p>Spring MVC中的<strong>handlerMapping</strong>：处理器映射器，其内保存了每一个处理器能处理哪些方法的映射信息。</p>
<p><strong>WelcomePageHandlerMapping</strong>是SpringBoot中自动注册到容器中的一个处理器映射器。在浏览器传来的url为<code>&quot;/&quot;</code>，且其他已存在的<code>HandlerMapping</code>无法处理该请求时，其会将该请求转发到欢迎页面。下图中展示了Spring Boot在启动时容器中存在的五个<code>HandlerMapping</code>，可以看到<code>WelcomePageHandlerMapping</code>排在最后，即其只会在其他四个处理器映射器都无法处理请求时工作。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720095314175.png" alt="image-20210720095314175" /></p>
<p>其在转发到欢迎页面前会先判断<code>mvcProperties</code>中的<code>staticPathPattern</code>属性值是否为<code>/**</code>，若是，则转发到欢迎页<code>index.html</code></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723171723749.png" alt="image-20210723171723749" /></p>
<p>默认情况下<code>static-path-pattern = /**</code>，但若开发人员在配置文件中配置了自定义的<code>static-path-pattern</code>，则<code>WelcomePageHandlerMapping</code>无法工作，欢迎页面和小图标将失效。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723171856063.png" alt="image-20210723171856063" /></p>

        <h2 id="rest-映射实现原理"   >
          <a href="#rest-映射实现原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#rest-映射实现原理"></a> Rest 映射实现原理</h2>
      
<p>实现Rest风格支持的核心Filter：<strong>HiddenHttpMethodFilter</strong>。其本质是一个过滤器，因此会在所有请求响应前进行拦截过滤，将<code>DELETE</code>请求和<code>PUT</code>请求进行包装后放行到后续过滤器。</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">hiddenmethod:</span></span><br><span class="line">      <span class="attr">filter:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span>   <span class="comment">#开启页面表单的Rest功能</span></span><br></pre></td></tr></table></div></figure>
<p>开启<strong>HiddenHttpMethodFilter</strong>后，若想发送<code>DELETE</code>或<code>PUT</code>请求，则需要创建一个表单，在表单项中携带一个<code>_method</code>参数，这个参数的值可以设置为<code>DELETE</code>或<code>PUT</code>。</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;get&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-GET提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-POST提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;DELETE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-DELETE 提交&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/user&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;_method&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;PUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&quot;REST-PUT提交&quot;</span><span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.GET)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;GET-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">saveUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;POST-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PutMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.PUT)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">putUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;PUT-张三&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="comment">//@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.DELETE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;DELETE-张三&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>容器在启动时，自动配置类<strong>WebMvcAutoConfiguration</strong>会向容器中注册一个继承了<strong>HiddenHttpMethodFilter</strong>的过滤器组件<strong>OrderedHiddenHttpMethodFilter</strong>，其本质上是一个过滤器，因此会在所有请求响应前进行拦截过滤，将<code>DELETE</code>请求和<code>PUT</code>请求进行包装后放行到后续过滤器。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210723192029596.png" alt="image-20210723192029596" /></p>

        <h3 id="hiddenhttpmethodfilter源码分析"   >
          <a href="#hiddenhttpmethodfilter源码分析" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#hiddenhttpmethodfilter源码分析"></a> HiddenHttpMethodFilter源码分析</h3>
      
<p><code>HiddenHttpMethodFilter</code>类里的拦截方法具体如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 首先获取传入参数 methodParam = _method 里的值，也就是DELETE</span></span><br><span class="line">    String paramValue = request.getParameter(<span class="keyword">this</span>.methodParam);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断当前表单是否是POST提交</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;POST&quot;</span>.equals(request.getMethod()) &amp;&amp; StringUtils.hasLength(paramValue)) &#123;</span><br><span class="line">        <span class="comment">// DELETE变成大写</span></span><br><span class="line">        String method = paramValue.toUpperCase(Locale.ENGLISH);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建包装后的Request类型对象wrapper，该对象的getMethod()方法被重写了，调用时将返回DELETE</span></span><br><span class="line">        HttpServletRequest wrapper = <span class="keyword">new</span> HiddenHttpMethodFilter.HttpMethodRequestWrapper(request, method);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将包装后的Request传递给了拦截器链，后续调用getMethod()获取到的都是DELETE</span></span><br><span class="line">        filterChain.doFilter(wrapper, response);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>wrapper对象被重写的<code>getMethod()</code>方法将直接返回<code>_method</code>里的值<code>DELETE</code>。并且包装后的wrapper对象被传递到了拦截器链中，从而后续的拦截器在调用此wrapper对象的<code>getMethod()</code>时将获取到<code>DELETE</code>，因此实现了Rest风格的映射。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715100050957.png" alt="image-20210715100050957" /></p>

        <h2 id="内嵌-servlet-容器工作原理"   >
          <a href="#内嵌-servlet-容器工作原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内嵌-servlet-容器工作原理"></a> 内嵌 Servlet 容器工作原理</h2>
      
<p>内嵌服务器工作原理：手动调用要启动的服务器的 <strong>start()</strong> 方法开启服务。</p>
<p>在Spring Boot启动时，发现当前项目是Web应用（因为引入了Web场景包和Tomcat场景包），则将创建一个Web版的IoC容器：<strong>ServletWebServerApplicationContext</strong>。在该容器启动时，通过<strong>TomcatServletWebServerFactory</strong>创建出一个Tomcat服务器<strong>tomcatWebServer</strong>并调用其 <strong>start()</strong> 方法启动了Tomcat服务。</p>
<p><strong>ServletWebServerApplicationContext</strong>实现了<strong>ApplicationContext</strong>接口，本质上也是一个IoC容器。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807111225531.png" alt="image-20210807111225531" /></p>
<p><strong>ServletWebServerApplicationContext</strong>将在启动时搜索<strong>ServletWebServerFactory</strong>（ServletWeb服务器工厂，用于生产ServletWeb服务器）</p>
<p>Spring Boot底层默认有很多的<strong>ServletWebServerFactory</strong>：</p>
<ul>
<li><code>TomcatServletWebServerFactory</code></li>
<li><code>JettyServletWebServerFactory</code></li>
<li><code>UndertowServletWebServerFactory</code></li>
</ul>
<p>这些工厂由<strong>ServletWebServerFactoryAutoConfiguration</strong>导入的<strong>ServletWebServerFactoryConfiguration</strong>（ServletWeb服务器工厂配置类）自动注册到容器中：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807112649353.png" alt="image-20210807112649353" /></p>
<p>因此，在<strong>ServletWebServerApplicationContext</strong>启动时：</p>
<ul>
<li>注册<strong>ServletWebServerFactoryAutoConfiguration</strong>自动配置类；</li>
<li>该自动配置类将导入<strong>ServletWebServerFactoryConfiguration</strong>工厂配置类；</li>
<li>该工厂配置类根据动态判断系统中到底导入了哪个Web服务器的包（默认导入Tomcat的包），注册相应的<strong>WebServlet服务器</strong>：
<ul>
<li><code>TomcatServletWebServerFactory</code></li>
<li><code>JettyServletWebServerFactory</code></li>
<li><code>UndertowServletWebServerFactory</code></li>
</ul>
</li>
<li>使用默认导入的<strong>TomcatServletWebServerFactory</strong>创建出Tomcat服务器并启动。</li>
</ul>
<p><strong>ServletWebServerApplicationContext</strong>在启动时，将调用其重写的 <strong>onRefresh()</strong> 方法，用于创建Web服务器<strong>webServer</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807142357270.png" alt="image-20210807142357270" /></p>
<p>创建<strong>webServer</strong>的流程：</p>
<ul>
<li>获取当前场景支持的Web服务器工厂，默认为<strong>TomcatServletWebServerFactory</strong></li>
<li>使用该工厂创建Tomcat的Web服务器对象<strong>webServer</strong>，并在该对象构造器中调用 <strong>start()</strong> 方法开启Tomcat服务</li>
</ul>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807143433400.png" alt="image-20210807143433400" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807144851940.png" alt="image-20210807144851940" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807145011358.png" alt="image-20210807145011358" /></p>
<p>内嵌服务器工作原理：手动调用要启动的服务器的 <strong>start()</strong> 方法开启服务。</p>

        <h3 id="切换servlet容器"   >
          <a href="#切换servlet容器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#切换servlet容器"></a> 切换Servlet容器</h3>
      
<p>要想切换服务器，则导入相应的starter场景即可：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>

        <h3 id="定制servlet容器"   >
          <a href="#定制servlet容器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#定制servlet容器"></a> 定制Servlet容器</h3>
      
<ul>
<li>修改配置文件中的 <code>server.xxx</code> 属性（最方便）</li>
<li>自定义<strong>ConfigurableServletWebServerFactory</strong>代替<strong>TomcatServletWebServerFactory</strong>，并将其注册到容器中</li>
<li>实现  <code>WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt;</code> ，把配置文件的值和<strong>ServletWebServerFactory</strong>进行绑定（<strong>xxxCustomizer</strong>：定制化器，可以改变xxx的默认规则）：</li>
</ul>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTomcatWebServerFactoryCustomizer</span> <span class="keyword">implements</span> <span class="title">WebServerFactoryCustomizer</span>&lt;<span class="title">TomcatServletWebServerFactory</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">customize</span><span class="params">(TomcatServletWebServerFactory server)</span> </span>&#123;</span><br><span class="line">        server.addConnectorCustomizers((connector) -&gt; connector.setAsyncTimeout(Duration.ofSeconds(<span class="number">20</span>).toMillis()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="定制化原理"   >
          <a href="#定制化原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#定制化原理"></a> 定制化原理</h2>
      

        <h3 id="spring-boot定制化的四种方式"   >
          <a href="#spring-boot定制化的四种方式" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#spring-boot定制化的四种方式"></a> Spring Boot定制化的四种方式</h3>
      
<ol>
<li>修改配置文件中的属性值以定制化；</li>
<li>编写自定义的配置类 <strong>xxxConfiguration</strong>，通过使用 <strong>@Bean</strong> 注解向容器中添加自定义的组件（例如视图解析器等）；</li>
<li>编写 <strong>xxxCustomizer</strong>，重写其方法以实现定制化；</li>
<li><strong>常用：编写一个实现了WebMvcConfigurer某些接口的配置类，并添加@Configuration注解</strong>。在该配置类中添加各种功能（例如添加拦截器，消息转换器，内容协商策略等）。注意这时不能标注 <strong>@EnableWebMvc</strong> 注解（若开启，则变成全面接管Spring MVC，就需要把所有Spring MVC配置好的规则全部自定义实现）</li>
</ol>
<p>方式4使用示例：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">myConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加自定义的拦截器</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> LoginInterceptor())</span><br><span class="line">            .addPathPatterns(<span class="string">&quot;/**&quot;</span>)   <span class="comment">// 写 /** 时所有请求都会被拦截，包括静态资源</span></span><br><span class="line">            .excludePathPatterns(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;/login&quot;</span>,<span class="string">&quot;/css/**&quot;</span>,<span class="string">&quot;/fonts/**&quot;</span>,<span class="string">&quot;/images/**&quot;</span>,<span class="string">&quot;/js/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加自定义的Converter，用于根据url中传入的字符串解析POJO内容</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFormatters</span><span class="params">(FormatterRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addConverter(<span class="keyword">new</span> Converter&lt;String, Person&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Person <span class="title">convert</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">                Person person = <span class="keyword">new</span> Person();</span><br><span class="line">                <span class="comment">// 定制化的解析方法...</span></span><br><span class="line">                <span class="keyword">return</span> person;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加自定义的消息转换器，用于转换自定义的媒体格式</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">        converters.add(<span class="keyword">new</span> MyMessageConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 指定三种媒体类型映射关系</span></span><br><span class="line">        Map&lt;String, MediaType&gt; mediaTypes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        mediaTypes.put(<span class="string">&quot;json&quot;</span>, MediaType.APPLICATION_JSON);</span><br><span class="line">        mediaTypes.put(<span class="string">&quot;xml&quot;</span>, MediaType.APPLICATION_XML);</span><br><span class="line">        mediaTypes.put(<span class="string">&quot;myFormat&quot;</span>, MediaType.parseMediaType(<span class="string">&quot;application/x-zhao&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于请求参数的内容协商策略：支持解析哪些参数对应哪些媒体类型</span></span><br><span class="line">        ParameterContentNegotiationStrategy parameterStrategy =</span><br><span class="line">            <span class="keyword">new</span> ParameterContentNegotiationStrategy(mediaTypes);</span><br><span class="line">        <span class="comment">// parameterStrategy.setParameterName(&quot;format&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于请求头的内容协商策略</span></span><br><span class="line">        HeaderContentNegotiationStrategy headerStrategy = <span class="keyword">new</span> HeaderContentNegotiationStrategy();</span><br><span class="line"></span><br><span class="line">        configurer.strategies(Arrays.asList(parameterStrategy, headerStrategy));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="定制化原理-2"   >
          <a href="#定制化原理-2" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#定制化原理-2"></a> 定制化原理</h3>
      
<p><strong>@EnableWebMvc</strong> 注解会向容器中导入一个<strong>DelegatingWebMvcConfiguration</strong>，其作用是：</p>
<ol>
<li>向容器中添加一些<strong>最基础</strong>的组件，例如映射器等</li>
<li>添加系统中所有的<strong>WebMvcConfigurer</strong>（包括自定义的），令这些定制的功能都生效</li>
</ol>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807155031104.png" alt="image-20210807155031104" /></p>
<p><strong>DelegatingWebMvcConfiguration</strong>继承自<strong>WebMvcConfigurationSupport</strong>，用于添加所有的<strong>WebMvcConfigurer</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807160226619.png" alt="image-20210807160226619" /></p>
<p><strong>DelegatingWebMvcConfiguration</strong>只能向容器中添加比较基础的组件（只保证最基础的应用，静态资源映射解析等功能均无法实现）。</p>
<p><mark>即开启了 <strong>@EnableWebMvc</strong> 注解，将向容器中添加<strong>DelegatingWebMvcConfiguration</strong>，其只能实现<strong>最基础</strong>的应用（以及开发人员自己添加的应用），无法实现Spring Boot中默认配置的许多高级功能（例如静态资源映射解析等）</mark></p>
<p>而这些更高级的功能，都由<strong>WebMvcAutoConfiguration</strong>完成注册：</p>
<p><strong>WebMvcAutoConfiguration</strong>是Spring Boot中默认的Spring MVC自动配置类：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210807155131164.png" alt="image-20210807155131164" /></p>
<p>其向容器中注册了许多Spring MVC相关的<strong>高级功能组件</strong>：例如Rest风格过滤器，消息转换器等。其若想生效，需要满足 <strong>@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</strong> ，即容器中不能存在<strong>WebMvcConfigurationSupport</strong>类型的组件。</p>
<p>而<strong>DelegatingWebMvcConfiguration</strong>类正是继承自<strong>WebMvcConfigurationSupport</strong>。因此若使用了 <strong>@EnableWebMvc</strong> 注解，则其 <strong>@Import</strong> 导入的<strong>DelegatingWebMvcConfiguration</strong>将使得功能更加完善的<strong>WebMvcAutoConfiguration</strong>失效，从而导致许多高级功能（如静态资源映射解析）无法生效。</p>
<p><mark>因此使用了 <strong>@EnableWebMvc</strong> 注解就无法再开启<strong>WebMvcAutoConfiguration</strong>中的功能，就需要开发人员<strong>全面接管</strong>Spring MVC。</mark></p>
<p>总结：若想定制化功能，则编写一个实现了<strong>WebMvcConfigurer</strong>某些接口的配置类，并添加 <strong>@Configuration</strong> 注解。注意这时不能标注 <strong>@EnableWebMvc</strong> 注解。</p>

        <h2 id="spring-boot-启动原理"   >
          <a href="#spring-boot-启动原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#spring-boot-启动原理"></a> Spring Boot 启动原理</h2>
      
<p>Spring Boot程序从主程序配置类的main方法开始执行：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155426532.png" alt="image-20210818155426532" /></p>
<p>调用<code>SpringApplication</code>类的静态方法<code>run()</code>，将Spring Boot主程序配置类传入：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155701782.png" alt="image-20210818155701782" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818155917510.png" alt="image-20210818155917510" /></p>
<p>Spring Boot整个启动过程分为两个阶段：</p>
<ul>
<li>创建<strong>SpringApplication</strong></li>
<li>运行<strong>SpringApplication.run()</strong></li>
</ul>

        <h3 id="创建-springapplication"   >
          <a href="#创建-springapplication" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#创建-springapplication"></a> 创建 SpringApplication</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818160118910.png" alt="image-20210818160118910" /></p>
<p>调用有参构造器初始化<code>SpringApplication</code>，从<code>spring.factories</code>文件中读取：</p>
<ul>
<li><strong>bootstrappers</strong>：初始化启动引导器</li>
<li><strong>ApplicationContextInitializer</strong>：应用容器初始化器</li>
<li><strong>ApplicationListener</strong>：应用容器监听器</li>
</ul>
<p>这些组件会在后续的<code>run()</code>方法中使用，用于向IoC容器中配置相应的环境</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210818161738903.png" alt="image-20210818161738903" /></p>
<p>上述<code>getSpringFactoriesInstances()</code>方法用于从<code>spring.factories</code>中读取配置属性。<code>spring.factories</code>：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"># Application Context Initializers</span><br><span class="line">org.springframework.context.ApplicationContextInitializer&#x3D;\</span><br><span class="line">org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.ContextIdApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.rsocket.context.RSocketPortInfoApplicationContextInitializer,\</span><br><span class="line">org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer</span><br><span class="line"></span><br><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener&#x3D;\</span><br><span class="line">org.springframework.boot.ClearCachesApplicationListener,\</span><br><span class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</span><br><span class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</span><br><span class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</span><br><span class="line">org.springframework.boot.context.logging.LoggingApplicationListener,\</span><br><span class="line">org.springframework.boot.env.EnvironmentPostProcessorApplicationListener,\</span><br><span class="line">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></div></figure>

        <h3 id="运行springapplicationrun"   >
          <a href="#运行springapplicationrun" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#运行springapplicationrun"></a> 运行SpringApplication.run()</h3>
      
<p>在<strong>SpringApplication</strong>创建完毕后，将调用其<code>run()</code>方法以启动<strong>SpringApplication</strong>。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch(); <span class="comment">// 创建计时器</span></span><br><span class="line">        stopWatch.start(); <span class="comment">// 开始计时，记录应用的启动时间</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.创建引导上下文bootstrapContext（Context环境）</span></span><br><span class="line">        <span class="comment">// 获取到所有bootstrappers逐个执行intitialize()来完成对引导启动器上下文环境的设置</span></span><br><span class="line">        <span class="comment">// bootstrappers在SpringApplication创建时从spring.factories里读取到</span></span><br><span class="line">        DefaultBootstrapContext bootstrapContext = createBootstrapContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.到run()方法最终执行完毕会返回一个ConfigurableApplicationContext，其就是Spring IoC容器</span></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.让当前应用进入headless模式（Headless模式是系统的一种配置模式。在该模式下，系统缺少了显示设备、键盘或鼠标）</span></span><br><span class="line">        configureHeadlessProperty();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4.获取所有RunListener（运行监听器），为了方便所有Listener进行事件感知</span></span><br><span class="line">        SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.遍历SpringApplicationRunListener调用starting()方法；</span></span><br><span class="line">        <span class="comment">// 相当于通知所有感兴趣系统正在启动过程的人，项目正在starting。</span></span><br><span class="line">        listeners.starting(bootstrapContext, <span class="keyword">this</span>.mainApplicationClass);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 6.保存命令行参数 ApplicationArguments</span></span><br><span class="line">            ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7.准备配置环境</span></span><br><span class="line">            ConfigurableEnvironment environment = prepareEnvironment(listeners, bootstrapContext, applicationArguments);</span><br><span class="line">            configureIgnoreBeanInfo(environment);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*打印标志</span></span><br><span class="line"><span class="comment">              .   ____          _            __ _ _</span></span><br><span class="line"><span class="comment">             /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="comment">            ( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span></span><br><span class="line"><span class="comment">             \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span></span><br><span class="line"><span class="comment">              &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="comment">             =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="comment">             :: Spring Boot ::                (v2.4.2)</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            Banner printedBanner = printBanner(environment);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建IoC容器：createApplicationContext（）</span></span><br><span class="line">            <span class="comment">// 根据项目类型webApplicationType（NONE,SERVLET,REACTIVE）创建容器，</span></span><br><span class="line">            <span class="comment">// 当前会创建 AnnotationConfigServletWebServerApplicationContext</span></span><br><span class="line">            context = createApplicationContext();</span><br><span class="line">            context.setApplicationStartup(<span class="keyword">this</span>.applicationStartup);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 8.准备ApplicationContext IoC容器的基本信息</span></span><br><span class="line">            prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 9.刷新IOC容器,创建容器中的所有组件，这部分属于Spring IoC启动原理内容</span></span><br><span class="line">            refreshContext(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 该方法没内容，大概为将来填入</span></span><br><span class="line">            afterRefresh(context, applicationArguments);</span><br><span class="line">            stopWatch.stop(); <span class="comment">// 停止计时</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123; <span class="comment">// this.logStartupInfo默认是true</span></span><br><span class="line">                <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 10.通知所有的监听器started()</span></span><br><span class="line">            listeners.started(context);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 11.调用所有runners</span></span><br><span class="line">            callRunners(context, applicationArguments);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// 处理运行失败错误，调用Listener的failed()</span></span><br><span class="line">            handleRunFailure(context, ex, listeners);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 12. 通知所有的监听器running()</span></span><br><span class="line">            listeners.running(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">// 13. 处理运行失败错误，调用Listener的failed()</span></span><br><span class="line">            handleRunFailure(context, ex, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.创建引导上下文bootstrapContext（Context环境）并逐一调用初始化方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DefaultBootstrapContext <span class="title">createBootstrapContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultBootstrapContext bootstrapContext = <span class="keyword">new</span> DefaultBootstrapContext();</span><br><span class="line">        <span class="keyword">this</span>.bootstrappers.forEach((initializer) -&gt; initializer.intitialize(bootstrapContext));</span><br><span class="line">        <span class="keyword">return</span> bootstrapContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3.让当前应用进入headless模式（Headless模式是系统的一种配置模式。在该模式下，系统缺少了显示设备、键盘或鼠标）</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureHeadlessProperty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//this.headless默认为true</span></span><br><span class="line">        System.setProperty(SYSTEM_PROPERTY_JAVA_AWT_HEADLESS,</span><br><span class="line">                           System.getProperty(SYSTEM_PROPERTY_JAVA_AWT_HEADLESS, Boolean.toString(<span class="keyword">this</span>.headless)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SYSTEM_PROPERTY_JAVA_AWT_HEADLESS = <span class="string">&quot;java.awt.headless&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4.获取所有RunListener（运行监听器），为了方便所有Listener进行事件感知</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt;[] types = <span class="keyword">new</span> Class&lt;?&gt;[] &#123; SpringApplication.class, String[].class &#125;;</span><br><span class="line">        <span class="comment">//getSpringFactoriesInstances 去 spring.factories 找 SpringApplicationRunListener</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger,</span><br><span class="line">                                                 getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="keyword">this</span>, args),</span><br><span class="line">                                                 <span class="keyword">this</span>.applicationStartup);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7.准备配置环境</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                       DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Create and configure the environment</span></span><br><span class="line">        <span class="comment">//返回或者创建基础环境信息对象，如：StandardServletEnvironment, StandardReactiveWebEnvironment</span></span><br><span class="line">        ConfigurableEnvironment environment = getOrCreateEnvironment();</span><br><span class="line">        <span class="comment">//配置环境信息对象,读取所有的配置源的配置属性值。</span></span><br><span class="line">        configureEnvironment(environment, applicationArguments.getSourceArgs());</span><br><span class="line">        <span class="comment">//绑定环境信息</span></span><br><span class="line">        ConfigurationPropertySources.attach(environment);</span><br><span class="line">        <span class="comment">// 7.1 通知所有的监听器当前环境准备完成</span></span><br><span class="line">        listeners.environmentPrepared(bootstrapContext, environment);</span><br><span class="line">        DefaultPropertiesPropertySource.moveToEnd(environment);</span><br><span class="line">        configureAdditionalProfiles(environment);</span><br><span class="line">        bindToSpringApplication(environment);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">            environment = <span class="keyword">new</span> EnvironmentConverter(getClassLoader()).convertEnvironmentIfNecessary(environment,</span><br><span class="line">                                                                                                   deduceEnvironmentClass());</span><br><span class="line">        &#125;</span><br><span class="line">        ConfigurationPropertySources.attach(environment);</span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.准备ApplicationContext IoC容器的基本信息</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(DefaultBootstrapContext bootstrapContext, ConfigurableApplicationContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">                                ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">                                ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 保存环境信息</span></span><br><span class="line">        context.setEnvironment(environment);</span><br><span class="line">        <span class="comment">// IOC容器的后置处理流程</span></span><br><span class="line">        postProcessApplicationContext(context);</span><br><span class="line">        <span class="comment">// 应用初始化器</span></span><br><span class="line">        applyInitializers(context);</span><br><span class="line">        <span class="comment">// 8.1 遍历所有的 listener 调用 contextPrepared。</span></span><br><span class="line">        <span class="comment">// EventPublishRunListenr通知所有的监听器contextPrepared</span></span><br><span class="line">        listeners.contextPrepared(context);</span><br><span class="line">        bootstrapContext.close(context);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">            logStartupProfileInfo(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">        <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">            beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">            ((DefaultListableBeanFactory) beanFactory)</span><br><span class="line">            .setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.lazyInitialization) &#123;</span><br><span class="line">            context.addBeanFactoryPostProcessor(<span class="keyword">new</span> LazyInitializationBeanFactoryPostProcessor());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Load the sources</span></span><br><span class="line">        Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">        Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">        load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">        <span class="comment">// 8.2 监听器加载上下文</span></span><br><span class="line">        listeners.contextLoaded(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 11.调用所有runners</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callRunners</span><span class="params">(ApplicationContext context, ApplicationArguments args)</span> </span>&#123;</span><br><span class="line">        List&lt;Object&gt; runners = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取容器中的ApplicationRunner</span></span><br><span class="line">        runners.addAll(context.getBeansOfType(ApplicationRunner.class).values());</span><br><span class="line">        <span class="comment">// 获取容器中的CommandLineRunner</span></span><br><span class="line">        runners.addAll(context.getBeansOfType(CommandLineRunner.class).values());</span><br><span class="line">        <span class="comment">// 合并所有runner并且按照@Order进行排序</span></span><br><span class="line">        AnnotationAwareOrderComparator.sort(runners);</span><br><span class="line">        <span class="comment">// 遍历所有的runner，调用run方法</span></span><br><span class="line">        <span class="keyword">for</span> (Object runner : <span class="keyword">new</span> LinkedHashSet&lt;&gt;(runners)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> ApplicationRunner) &#123;</span><br><span class="line">                callRunner((ApplicationRunner) runner, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runner <span class="keyword">instanceof</span> CommandLineRunner) &#123;</span><br><span class="line">                callRunner((CommandLineRunner) runner, args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 13.处理运行失败错误，调用Listener的failed()</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleRunFailure</span><span class="params">(ConfigurableApplicationContext context, Throwable exception,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  SpringApplicationRunListeners listeners)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                handleExitCode(context, exception);</span><br><span class="line">                <span class="keyword">if</span> (listeners != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//14.</span></span><br><span class="line">                    listeners.failed(context, exception);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                reportFailure(getExceptionReporters(context), exception);</span><br><span class="line">                <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    context.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;Unable to close ApplicationContext&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        ReflectionUtils.rethrowRuntimeException(exception);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>SpringApplication(primarySources).run(args)</code> 最后返回的IoC容器<code>context</code>：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigurableApplicationContext</span> <span class="keyword">extends</span> <span class="title">ApplicationContext</span>, <span class="title">Lifecycle</span>, <span class="title">Closeable</span> </span>&#123;</span><br><span class="line">    String CONFIG_LOCATION_DELIMITERS = <span class="string">&quot;,; \t\n&quot;</span>;</span><br><span class="line">    String CONVERSION_SERVICE_BEAN_NAME = <span class="string">&quot;conversionService&quot;</span>;</span><br><span class="line">    String LOAD_TIME_WEAVER_BEAN_NAME = <span class="string">&quot;loadTimeWeaver&quot;</span>;</span><br><span class="line">    String ENVIRONMENT_BEAN_NAME = <span class="string">&quot;environment&quot;</span>;</span><br><span class="line">    String SYSTEM_PROPERTIES_BEAN_NAME = <span class="string">&quot;systemProperties&quot;</span>;</span><br><span class="line">    String SYSTEM_ENVIRONMENT_BEAN_NAME = <span class="string">&quot;systemEnvironment&quot;</span>;</span><br><span class="line">    String APPLICATION_STARTUP_BEAN_NAME = <span class="string">&quot;applicationStartup&quot;</span>;</span><br><span class="line">    String SHUTDOWN_HOOK_THREAD_NAME = <span class="string">&quot;SpringContextShutdownHook&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setId</span><span class="params">(String var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setParent</span><span class="params">(<span class="meta">@Nullable</span> ApplicationContext var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(ConfigurableEnvironment var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ConfigurableEnvironment <span class="title">getEnvironment</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setApplicationStartup</span><span class="params">(ApplicationStartup var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ApplicationStartup <span class="title">getApplicationStartup</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addBeanFactoryPostProcessor</span><span class="params">(BeanFactoryPostProcessor var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClassLoader</span><span class="params">(ClassLoader var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addProtocolResolver</span><span class="params">(ProtocolResolver var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerShutdownHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">ConfigurableListableBeanFactory <span class="title">getBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>上文源码中的<strong>SpringApplicationRunListeners</strong>运行监听器需要配置在<code>spring.factories</code>文件里，例如<strong>EventPublishingRunListener</strong>事件发布运行监听器：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener&#x3D;\</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></div></figure>
<p><strong>SpringApplicationRunListeners</strong>运行监听器：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringApplicationRunListeners</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log log;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SpringApplicationRunListener&gt; listeners;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApplicationStartup applicationStartup;</span><br><span class="line"></span><br><span class="line">    SpringApplicationRunListeners(Log log, Collection&lt;? extends SpringApplicationRunListener&gt; listeners,</span><br><span class="line">                                  ApplicationStartup applicationStartup) &#123;</span><br><span class="line">        <span class="keyword">this</span>.log = log;</span><br><span class="line">        <span class="keyword">this</span>.listeners = <span class="keyword">new</span> ArrayList&lt;&gt;(listeners);</span><br><span class="line">        <span class="keyword">this</span>.applicationStartup = applicationStartup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5.遍历 SpringApplicationRunListener 调用starting()方法；</span></span><br><span class="line">    <span class="comment">// 相当于通知所有感兴趣系统正在启动过程的人，项目正在starting。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, Class&lt;?&gt; mainApplicationClass)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.starting&quot;</span>, (listener) -&gt; listener.starting(bootstrapContext),</span><br><span class="line">                        (step) -&gt; &#123;</span><br><span class="line">                            <span class="keyword">if</span> (mainApplicationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                step.tag(<span class="string">&quot;mainApplicationClass&quot;</span>, mainApplicationClass.getName());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7.1</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.environment-prepared&quot;</span>,</span><br><span class="line">                        (listener) -&gt; listener.environmentPrepared(bootstrapContext, environment));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.1</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.context-prepared&quot;</span>, (listener) -&gt; listener.contextPrepared(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.2</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.context-loaded&quot;</span>, (listener) -&gt; listener.contextLoaded(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">started</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.started&quot;</span>, (listener) -&gt; listener.started(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 12.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.running&quot;</span>, (listener) -&gt; listener.running(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 14.</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> </span>&#123;</span><br><span class="line">        doWithListeners(<span class="string">&quot;spring.boot.application.failed&quot;</span>,</span><br><span class="line">                        (listener) -&gt; callFailedListener(listener, context, exception), (step) -&gt; &#123;</span><br><span class="line">                            step.tag(<span class="string">&quot;exception&quot;</span>, exception.getClass().toString());</span><br><span class="line">                            step.tag(<span class="string">&quot;message&quot;</span>, exception.getMessage());</span><br><span class="line">                        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 Consumer&lt;StartupStep&gt; stepAction)</span> </span>&#123;</span><br><span class="line">        StartupStep step = <span class="keyword">this</span>.applicationStartup.start(stepName);</span><br><span class="line">        <span class="keyword">this</span>.listeners.forEach(listenerAction);</span><br><span class="line">        <span class="keyword">if</span> (stepAction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stepAction.accept(step);</span><br><span class="line">        &#125;</span><br><span class="line">        step.end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="自定义事件监听组件"   >
          <a href="#自定义事件监听组件" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自定义事件监听组件"></a> 自定义事件监听组件</h3>
      
<p><code>MyApplicationContextInitializer.java</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextInitializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationContextInitializer</span> <span class="keyword">implements</span> <span class="title">ApplicationContextInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyApplicationContextInitializer ....initialize.... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>MyApplicationListener.java</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyApplicationListener.....onApplicationEvent...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>MyApplicationRunner.java</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="meta">@Component</span><span class="comment">//放入容器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationRunner</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyApplicationRunner...run...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>MyCommandLineRunner.java</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用启动做一个一次性事情</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Order(2)</span></span><br><span class="line"><span class="meta">@Component</span><span class="comment">//放入容器</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCommandLineRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MyCommandLineRunner....run....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>MySpringApplicationRunListener.java</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.ConfigurableBootstrapContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplicationRunListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ConfigurableApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.env.ConfigurableEnvironment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySpringApplicationRunListener</span> <span class="keyword">implements</span> <span class="title">SpringApplicationRunListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SpringApplication application;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MySpringApplicationRunListener</span><span class="params">(SpringApplication application, String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.application = application;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....starting....&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....environmentPrepared....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextPrepared</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....contextPrepared....&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoaded</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....contextLoaded....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">started</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....started....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">running</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....running....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(ConfigurableApplicationContext context, Throwable exception)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySpringApplicationRunListener....failed....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>注册<code>MyApplicationContextInitializer</code>，<code>MyApplicationListener</code>，<code>MySpringApplicationRunListener</code>到当前项目的<code>resources / META-INF / spring.factories</code>中：</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextInitializer&#x3D;\</span><br><span class="line">  com.lun.boot.listener.MyApplicationContextInitializer</span><br><span class="line"></span><br><span class="line">org.springframework.context.ApplicationListener&#x3D;\</span><br><span class="line">  com.lun.boot.listener.MyApplicationListener</span><br><span class="line"></span><br><span class="line">org.springframework.boot.SpringApplicationRunListener&#x3D;\</span><br><span class="line">  com.lun.boot.listener.MySpringApplicationRunListener</span><br></pre></td></tr></table></div></figure>

        <h2 id="spring-mvc-执行流程"   >
          <a href="#spring-mvc-执行流程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#spring-mvc-执行流程"></a> Spring MVC 执行流程</h2>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png" alt="image-20210715165846578" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png" alt="image-20210719204334058" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731205850800.png" alt="image-20210731205850800" /></p>
<p><mark>超链接</mark></p>
<p><mark>重新截图带上拦截器里面的所有整合</mark></p>
<p>截图时带上异常处理的内容</p>
<p>下面将详细分析Spring MVC的执行流程，分别分析<strong>请求映射原理</strong>、<strong>参数解析原理</strong>、<strong>内容协商原理</strong>、<strong>视图解析原理</strong>等。并在其中穿插Spring MVC执行过程中的<mark>n</mark>大主线：</p>
<ul>
<li>主线1. 获取请求处理器：<strong>this.getHandler()</strong></li>
<li>主线2. 获取目标处理器的适配器：<strong>this.getHandlerAdapter()</strong></li>
<li>主线3. 使用适配器执行目标方法：<strong>ha.handle()</strong></li>
<li>主线4. 使用ModelAndView进行视图解析：<strong>processDispatchResult()</strong></li>
</ul>

        <h2 id="dispatcherservlet"   >
          <a href="#dispatcherservlet" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#dispatcherservlet"></a> DispatcherServlet</h2>
      
<p><strong>DispatcherServlet</strong>类继承自<strong>FrameworkServlet</strong>类，该类最终继承自<strong>HttpServlet</strong>类。<mark><strong>其本质上也是一个Servlet，也需要注册到Tomcat中才能响应到客户端传来的请求。</strong></mark></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163040938.png" alt="image-20210715163040938" /></p>
<p><strong>FrameworkServlet</strong>类中有多个处理请求的方法（<code>doGet/doPost/doPut/doDelete</code>），他们都调用了同一个方法<code>this.processRequest(request, response)</code>。（<strong>DispatcherServlet</strong>类中并没有重写这些<code>doXxx</code>方法和<code>processRequest()</code>方法，因此调用的是<strong>FrameworkServlet</strong>类里的这些方法）</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715162521522.png" alt="image-20210715162521522" /></p>
<p><code>processRequest(request, response)</code>方法中最关键的一步为调用<code>this.doService(request, response)</code>方法。但该方法在<strong>FrameworkServlet</strong>类中为抽象方法，需要子类实现，因此调用的是<strong>DispatcherServlet</strong>类里的 <strong>this.doService(request, response)</strong> 方法。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715162814683.png" alt="image-20210715162814683" /></p>
<p><strong>FrameworkServlet</strong>类重写的 <strong>doService()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163548801.png" alt="image-20210715163548801" /></p>
<p>该方法调用了<strong>FrameworkServlet</strong>中的 <strong>doDispatch(request, response)</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715163935578.png" alt="image-20210715163935578" /></p>
<p>因此分析清楚 <strong>doDispatch(request, response)</strong> 方法即可理解Spring MVC的原理。上述关系树见下图：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715164354367.png" alt="image-20210715164354367" /></p>

        <h3 id="在tomcat中注册dispatcherservlet"   >
          <a href="#在tomcat中注册dispatcherservlet" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#在tomcat中注册dispatcherservlet"></a> 在Tomcat中注册DispatcherServlet</h3>
      
<p>Spring Boot中有一个自动配置类：<strong>DispatcherServletAutoConfiguration</strong>。其用于进行<strong>DispatcherServlet</strong>的自动注册和配置。</p>
<p><strong>DispatcherServlet</strong>将在Spring Boot启动时添加到容器中，该组件绑定了<strong>WebMvcProperties</strong>配置类，其对应的配置文件前缀为 <strong>“spring.mvc”</strong> ，修改该前缀下的属性即可自定义功能。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803202035420.png" alt="image-20210803202035420" /></p>
<p>但仅仅将<strong>DispatcherServlet</strong>注册到容器中还不够，<strong>此时该组件尚未与Tomcat服务器产生联系，Tomcat服务器并不能使用该Servlet进行请求映射</strong>（即此时客户端发来的请求 <strong>“/”</strong> 并不能被<strong>DispatcherServlet</strong>获取到，而会有Tomcat中存在的其他Servlet获取进行请求映射）。因此需要将<strong>DispatcherServlet</strong>注册到Tomcat中才能响应到客户端传来的请求。</p>
<p>使用<strong>DispatcherServletRegistrationBean</strong>将<strong>DispatcherServlet</strong>注册到Tomcat中：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803203720388.png" alt="image-20210803203720388" /></p>
<p><strong>DispatcherServletRegistrationBean</strong>用于向Tomcat服务器中注册配置<strong>DispatcherServlet</strong>，并为其指定映射路径<strong>webMvcProperties.getServlet().getPath()</strong>，该值默认为 <strong>“/”</strong> ，开发人员也可以自定义该路径：</p>
<figure class="highlight properties"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.mvc.servlet.path</span>=<span class="string">&quot;/my/&quot;</span></span><br></pre></td></tr></table></div></figure>
<p><strong>DispatcherServletRegistrationBean</strong>继承自 <strong><code>ServletRegistrationBean&lt;DispatcherServlet&gt;</code></strong> ，其是一种<strong>Servlet注册组件</strong>，用于向Tomcat服务器中注册配置Web原生<strong>Servlet</strong>组件，此时的泛型为<strong>DispatcherServlet</strong>类型，因此会向Tomcat服务器中注册配置<strong>DispatcherServlet</strong>。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803204836013.png" alt="image-20210803204836013" /></p>
<p><mark><strong>总结</strong></mark>：使用<strong>DispatcherServletRegistrationBean</strong>向Tomcat中注册了<strong>DispatcherServlet</strong>后，Tomcat即可将符合 <strong>“/”</strong> 的请求映射到<strong>DispatcherServlet</strong>。之后客户端发来符合要求的请求时，即可执行<strong>DispatcherServlet</strong>的 <strong>doDispatch()</strong> 方法，从而进行后续的请求映射、参数解析、数据响应和视图解析等步骤（见下文分析）。</p>
<hr />
<p>补充：Tomcat路径的优先精确匹配原则</p>
<p>在Tomcat中若配置了多个Servlet，则将优先匹配更精确的路径，例如<strong>DispatcherServlet</strong>的匹配路径为<code>&quot;/&quot;</code>，自定义的其他Servlet的匹配路径为<code>&quot;/my/&quot;</code>，则Tomcat将优先匹配到更精确的Servlet，而不会匹配到<strong>DispatcherServlet</strong>。此时该请求将不再被容器中配置的拦截器所拦截，也不能使用<strong>DispatcherServlet</strong>的页面转发等功能，只能使用原生的Servlet方法。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210803212019087.png" alt="image-20210803212019087" /></p>
<hr />

        <h2 id="文件上传原理"   >
          <a href="#文件上传原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#文件上传原理"></a> 文件上传原理</h2>
      
<p>标准文件上传解析器<strong>StandardServletMultipartResolver</strong>由<strong>MultipartAutoConfiguration</strong>注册到容器中：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801203151706.png" alt="image-20210801203151706" /></p>
<p>其绑定了<strong>MultipartProperties</strong>属性：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801203234072.png" alt="image-20210801203234072" /></p>

        <h3 id="包装原始请求thischeckmultipartrequest"   >
          <a href="#包装原始请求thischeckmultipartrequest" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#包装原始请求thischeckmultipartrequest"></a> 包装原始请求：this.checkMultipart(request)</h3>
      
<p><mark>此处开始分析 <strong>doDispatch()</strong> 方法</mark>：</p>
<p>进入 <strong>doDispatch()</strong> 方法后，首先进行<strong>文件上传请求包装</strong>： <strong>this.checkMultipart(request)</strong></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png" alt="image-20210715165846578" /></p>
<p>进入<strong>this.checkMultipart(request)</strong> 方法后，将调用唯一的一个参数解析器<strong>StandardServletMultipartResolver</strong>判断当前请求是否是文件上传请求：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801204553429.png" alt="image-20210801204553429" /></p>
<p>参数解析器<strong>StandardServletMultipartResolver</strong>判断的方式 **isMultipart() **为：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801204739367.png" alt="image-20210801204739367" /></p>
<p>如果当前请求是文件上传请求，则将当前请求封装成一个<strong>StandardMultipartHttpServletRequest</strong>类型的请求：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801205746126.png" alt="image-20210801205746126" /></p>
<p>后续分析使用的请求就是这个已经被封装后的<strong>StandardMultipartHttpServletRequest</strong>请求。</p>

        <h3 id="解析文件内容"   >
          <a href="#解析文件内容" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#解析文件内容"></a> 解析文件内容</h3>
      
<p>获得包装后的请求后，该请求中包含的文件内容将在 <strong>ha.handle()</strong> 方法中进行解析：</p>
<p>在所有的参数解析器中有一个请求文件参数解析器<strong>RequestPartMethodArgumentResolver</strong>，Spring MVC将使用该解析器将请求中的文件内容封装成一个<strong>MultipartFile</strong>对象。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801210620885.png" alt="image-20210801210620885" /></p>
<p>解析得到的文件类型<strong>MultipartFile</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801214140507.png" alt="image-20210801214140507" /></p>
<p>关于文件上传参数解析器的具体细节见<a href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8">文件上传参数解析器</a></p>

        <h2 id="请求映射原理"   >
          <a href="#请求映射原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#请求映射原理"></a> 请求映射原理</h2>
      
<p>经过文件上传的封装后，即开始进行请求映射：</p>

        <h3 id="主线1-获取请求处理器thisgethandler"   >
          <a href="#主线1-获取请求处理器thisgethandler" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主线1-获取请求处理器thisgethandler"></a> 主线1. 获取请求处理器：this.getHandler()</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715165846578.png" alt="image-20210715165846578" /></p>
<p><strong>this.getHandler()</strong>：根据当前的<strong>url请求地址</strong><code>（&quot;/hello&quot;）</code>判断哪个<strong>控制器</strong>（<code>@Controller</code>）里的<strong>目标方法</strong>（<code>@RequestMapping(&quot;/hello&quot;)</code>）与之对应：</p>
<p><strong>url：&quot;/hello&quot; ——&gt; HelloController#handle01() 方法</strong></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720135457338.png" alt="image-20210720135457338" /></p>
<p><strong>this.getHandler()</strong> 方法返回的<strong>mappedHandler</strong>对象的类型为<strong>HandlerExecutionChain</strong>，即<strong>目标方法处理器的执行链</strong>，其内保存了与当前请求地址<code>&quot;/hello&quot;</code>匹配的目标方法<strong>HelloController#handle01()</strong> （这个请求信息在容器启动时就添加到了<strong>RequestMappingHandlerMapping</strong>中，因此可以在后续匹配到）:</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720094927124.png" alt="image-20210720094927124" /></p>
<p><strong>this.getHandler() 方法内部细节</strong>：</p>
<hr />
<p><strong>this.getHandler()</strong> 方法传入了<code>HttpServletRequest</code>类型的请求对象，其内包含了响应的url等信息：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png" alt="image-20210720101645865" /></p>
<p><mark><strong>this.handlerMappings</strong>：<strong>处理器映射器</strong></mark>，其内保存了每一个处理器能处理映射的方法信息。（以下为Spring Boot中存在的映射器，纯Spring MVC工程中只有两个<code>handlerMapping</code>，分别为基于xml方式的<strong>BeanNameUrlHandlerMapping</strong>和基于注解方式的<strong>RequestMappingHandlerMapping</strong>）</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720095314175-1627472434897.png" alt="image-20210720095314175" /></p>
<p><mark><strong>RequestMappingHandlerMapping</strong>里保存了所有 <strong>@RequestMapping</strong> 与 <strong>handler</strong> 的映射规则</mark>，为<strong>基于注解方式</strong>的处理器映射器，其内包含了所有开发人员自定义的<code>@RequestMapping</code>方法，<strong>mappingRegistry</strong>属性保存了所有的映射信息：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101836077.png" alt="image-20210720101836077" /></p>
<p>IoC容器在启动创建<code>@Controller</code>对象时扫描每个控制器的方法能响应什么请求，并保存在<strong>RequestMappingHandlerMapping</strong>对象的<strong>mappingRegistry</strong>属性中（该属性中保存了所有开发人员自定义的基于注解的控制器信息）。下一次请求过来，判断<code>handlerMapping</code>中有无存在匹配的映射关系。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png" alt="image-20210720101645865" /></p>
<p>在<strong>getHandler()</strong> 方法中，依次遍历所有的<strong>handlerMapping</strong>对象，其会解析当前传入的<code>request</code>对象，判断哪个<strong>handlerMapping</strong>对象符合当前的url请求信息，将符合信息的返回一个<strong>HandlerExecutionChain</strong>对象。下图为匹配到的<code>handler</code>，该<code>handler</code>内保存了该url请求对应的目标 <strong>HelloController#handle01()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720105316770.png" alt="image-20210720105316770" /></p>
<hr />
<p><strong>this.getHandler() 总结</strong></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720101645865.png" alt="image-20210720101645865" /></p>
<p>在<strong>this.getHandler()</strong> 方法内遍历每个<strong>HandlerMapping</strong>，判断哪个<strong>HandlerMapping</strong>能处理当前的请求地址（开发人员自定义的方法将由<strong>RequestMappingHandlerMapping</strong>处理），并返回一个<strong>HandlerExecutionChain</strong>对象。</p>
<p>其中IoC容器在启动时就会向<strong>HandlerMapping</strong>内保存每个<code>@RequestMapping(&quot;xxx&quot;)</code>信息，以在后续收到浏览器的url请求时能够匹配到对应的<strong>RequestMappingHandlerMapping</strong>处理器信息。</p>

        <h3 id="主线2-获取目标处理器的适配器thisgethandleradapter"   >
          <a href="#主线2-获取目标处理器的适配器thisgethandleradapter" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主线2-获取目标处理器的适配器thisgethandleradapter"></a> 主线2. 获取目标处理器的适配器：this.getHandlerAdapter()</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png" alt="image-20210719204334058" /></p>
<p>将上一步得到的<strong>请求映射处理器mappedHandler</strong>传入到 <strong>this.getHandlerAdapter()</strong> 方法中，返回该处理器所对应的<strong>适配器adapter</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720141752006.png" alt="image-20210720141752006" /></p>
<p>共有四种类型的适配器：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720141620095.png" alt="image-20210720141620095" /></p>
<p>其中<strong>RequestMappingHandlerAdapter</strong>是基于<strong>注解</strong>方式的适配器，对应于<strong>RequestMappingHandlerMapping</strong>。后续步骤将使用该适配器执行目标方法（基于反射机制）。</p>
<p>至此，分析了<strong>请求映射</strong>原理，即根据请求url的不同映射得到相应的请求处理器与适配器，接着使用该适配器 <strong>ha.handle()</strong> 执行目标方法（基于反射机制）。</p>

        <h3 id="拦截器"   >
          <a href="#拦截器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#拦截器"></a> 拦截器</h3>
      
<p><mark>补充拦截器原理</mark></p>

        <h3 id="主线3-使用适配器执行目标方法hahandle"   >
          <a href="#主线3-使用适配器执行目标方法hahandle" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主线3-使用适配器执行目标方法hahandle"></a> 主线3. 使用适配器执行目标方法：ha.handle()</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210719204334058.png" alt="image-20210719204334058" /></p>
<p>在主线2中得到<strong>处理器适配器HandlerAdapter</strong>后，调用其 <strong>ha.handler()</strong> 方法执行目标方法。</p>
<p><strong>ha.handler()</strong> 方法最终返回的<strong>ModelAndView</strong>对象<code>mv</code>，其中既包括了要转发的目标页面视图名，又包括了目标方法保存在<code>Model/Map</code>中的数据：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210728215546942.png" alt="image-20210728215546942" /></p>
<p>进入 <strong>ha.handler()</strong> 方法后，将通过调用 <strong>this.invokeHandlerMethod()</strong> 执行目标方法，得到的<code>mav</code>即为 <strong>ha.handler()</strong> 方法返回的<strong>ModelAndView</strong>对象<code>mv</code>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210720144223605.png" alt="image-20210720144223605" /></p>
<p><strong>this.invokeHandlerMethod()</strong> 方法内部细节：</p>
<hr />
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153751013.png" alt="image-20210724153751013" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725215637180.png" alt="image-20210725215637180" /></p>
<p><mark>上述方法运行完后invocableMethod内的信息</mark>：截图带上getModelAndVIew</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161349706.png" alt="image-20210724161349706" /></p>
<p><mark>全部分析完后修改，重新截图带上文件上传</mark>流程图</p>
<p>大致流程如下：</p>
<p><strong>准备工作</strong>：</p>
<ul>
<li>首先将传入的目标方法处理器<strong>handlerMethod</strong>（其内保存了<strong>HelloController#handle01()</strong> 的信息）封装成一个可执行的处理器方法<strong>invocableMethod</strong>，后续使用该对象执行目标方法；</li>
<li>为<strong>invocableMethod</strong>设置<strong>参数解析器argumentResolvers</strong>，用于解析目标方法传来的所有参数值；为<strong>invocableMethod</strong>设置<strong>返回值处理器returnValueHandlers</strong>，用于定义方法的返回值支持的类型；为<strong>invocableMethod</strong>设置其他信息；</li>
</ul>
<p><strong>准备工作完成后</strong>，即可调用该对象的 <strong>invokeAndHandle()</strong> 方法，利用反射机制真正执行目标方法：</p>
<ul>
<li>目标方法执行前，先<mark>使用<strong>参数解析器argumentResolver</strong>解析目标方法传入的所有参数</mark>，得到<code>Object[] args</code>，其内保存了所有解析后的参数对象信息，例如解析完毕后已赋值的POJO以及内容尚且为空的<code>Model/Map</code>对象。【详细分析见<a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><strong>参数解析原理</strong></a>章节】
<ul>
<li><code>Model/Map</code>均为接口，程序运行时实际上是通过多态性质创建的是唯一的一个<strong>BindingAwareModelMap</strong>类型的对象；</li>
<li>该对象此时内容为空，因为还未给其赋值，将在目标方法执行时为其赋值。</li>
</ul>
</li>
<li>得到参数后，基于<strong>反射机制</strong>执行目标方法 <strong>HelloController#handle01()</strong> 。【详细分析见<a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><strong>参数解析原理</strong></a>章节】
<ul>
<li>目标方法使用参数解析器解析出的<code>args[]</code>执行业务逻辑代码；</li>
<li>经过目标方法的执行，<strong>BindingAwareModelMap</strong>中保存的内容将被保存到<strong>ModelAndViewContainer</strong>类型的对象<code>mavContainer</code>中，同时目标方法参数中的POJO（从请求参数中确定值）也会被保存到<code>mavContainer</code>中；</li>
<li><code>mavContainer</code>中保存的<code>Model/Map</code>数据将在 <strong>getModelAndView()</strong> 方法执行后保存到<strong>ModelAndView</strong>类型对象<code>mv</code>中，并作为返回值返回给上一侧 <strong>ha.handle()</strong> ；</li>
<li>在主线4里使用该<strong>ModelAndView</strong>类型对象进行<strong>视图解析</strong>等操作。其内容最终都会<strong>被保存到request域中</strong>。【详细分析见<a href="#%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><strong>视图解析原理</strong></a>章节】</li>
</ul>
</li>
<li>目标方法执行完毕后，<mark>使用<strong>返回值处理器returnValueHandlers</strong>处理目标方法的返回值</mark>，此时根据返回值类型的不同分为多种情况【详细分析见<a href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86"><strong>数据响应与内容协商原理</strong></a>章节】：
<ul>
<li>若目标方法使用 <strong>@ResoponseBody</strong> 注解，即要返回JSON等格式的数据，则进行<strong>内容协商</strong>，使用<strong>转换器Converters</strong>将POJO数据内容转换为指定格式（如JSON、XML等）</li>
<li>若返回值为要跳转的页面视图名，则将返回值<code>&quot;/sucess&quot;</code>作为视图名<strong>viewName</strong>保存到<strong>ModelAndView</strong>对象<code>mv</code>中，主线4将使用该对象进行页面转发</li>
</ul>
</li>
<li>处理完返回值后，将执行 <strong>getModelAndView()</strong> 方法将<code>mavContainer</code>对象转换成<strong>ModelAndView</strong>对象<code>mv</code>，返回给 <strong>ha.handle()</strong> 方法，用于后续的视图解析。</li>
</ul>
<hr />
<p>下文将详细分析上述流程。</p>

        <h2 id="参数解析原理"   >
          <a href="#参数解析原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#参数解析原理"></a> 参数解析原理</h2>
      
<p>在<strong>this.invokeHandlerMethod()</strong> 方法内，首先将传入的目标方法处理器<strong>handlerMethod</strong>（其内保存了<strong>HelloController#handle01()</strong> 的信息）封装成一个可执行的处理器方法<strong>invocableMethod</strong>，后续使用该对象执行目标方法；</p>
<p>接着为<strong>invocableMethod</strong>设置<strong>参数解析器argumentResolvers</strong>，用于解析目标方法传来的所有参数值（橙色框）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153751013.png" alt="image-20210724153751013" /></p>
<p>为<strong>invocableMethod</strong>设置完参数解析器和返回值处理器后，将调用其 <strong>invokeAndHandle()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725215637180.png" alt="image-20210725215637180" /></p>
<p>该方法将先后完成<strong>解析目标方法参数</strong>、<strong>基于反射机制执行目标方法</strong>、<strong>处理目标方法返回值</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725171847138.png" alt="image-20210725171847138" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png" alt="image-20210724161138834" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161223870.png" alt="image-20210724161223870" /></p>
<p><strong>invocableMethod.invokeAndHandle()</strong> 方法内逻辑：</p>
<ul>
<li><strong>invokeForRequest()</strong>：解析参数并执行目标方法
<ol>
<li><strong>Object[] args = getMethodArgumentValues()</strong> ：解析获取目标方法的所有参数值(例如<a href="#POJO%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8">解析POJO内容</a>，<a href="#%E5%8E%9F%E7%94%9FServlet-API%E8%A7%A3%E6%9E%90%E5%99%A8">解析原生Servlet API</a>，<a href="#Model/Map%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8">解析Model/Map</a>)</li>
<li><strong>doInvoke(args)</strong> ：利用反射机制执行目标方法（该方法返回<code>mavContainer</code>对象，其中保存<code>Model/Map</code>中的内容、目标方法参数中的POJO内容（从请求参数中确定值）以及要跳转的视图名<code>viewName</code>）</li>
</ol>
</li>
<li><strong>returnValueHandlers.handleReturnValue()</strong>：处理目标方法返回值，分两种情况【详细分析见<a href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86"><strong>数据响应与内容协商原理</strong></a>章节】：
<ol>
<li>若目标方法使用 <strong>@ResoponseBody</strong> 注解，即要返回JSON等格式的数据，则进行<strong>内容协商</strong>，使用<strong>转换器Converters</strong>将POJO数据内容转换为指定格式（如JSON、XML等）</li>
<li>若返回值为要跳转的页面视图名，则将返回值<code>&quot;/sucess&quot;</code>作为视图名<strong>viewName</strong>保存到<strong>ModelAndView</strong>对象<code>mv</code>中，<mark>主线4</mark>将使用该对象进行页面转发</li>
</ol>
</li>
</ul>
<p>本章节将分析 <strong>invokeForRequest()</strong> 方法内的细节：</p>

        <h3 id="解析参数getmethodargumentvalues"   >
          <a href="#解析参数getmethodargumentvalues" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#解析参数getmethodargumentvalues"></a> 解析参数：getMethodArgumentValues()</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png" alt="image-20210724161138834" /></p>
<p><strong>getMethodArgumentValues()</strong> 方法（上图黄色框）用于进行目标方法的参数解析，将参数解析完毕后，返回的<code>args[]</code>中存储了所有参数信息（<code>Model/Map</code>里的内容还都为空，因为此时还未执行目标方法），之后调用 <strong>doInvoke(args)</strong> 执行目标方法，将<code>Model/Map</code>中的内容保存到<code>mavContainer</code>对象中。 <strong>getMethodArgumentValues()</strong> 方法内的逻辑如下：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163554136.png" alt="image-20210724163554136" /></p>
<p>首先获取所有参数<strong>parameters</strong>，然后逐一遍历每一个参数，寻找能解析该参数的<a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8%EF%BC%9AargumentResolvers">参数解析器</a>。其中最关键的两处 <strong>this.resolvers.supportsParameter()</strong> 和 <strong>this.resolvers.resolveArgument()</strong> (黄色框和绿色框)：</p>
<ul>
<li><strong>this.resolvers.supportsParameter()</strong> ：遍历每个参数解析器，判断参数解析器是否支持当前参数</li>
<li><strong>this.resolvers.resolveArgument()</strong> ：若支持当前参数，则使用该解析器解析参数，返回解析得到的参数<code>args[i]</code></li>
</ul>
<p><strong>this.resolvers.supportsParameter()</strong> ：遍历每个参数解析器，判断参数解析器是否支持当前参数，若找不到符合的参数解析器，则抛出异常：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212435861.png" alt="image-20210801212435861" /></p>
<p>其中，传入的<code>parameter</code>为目标方法中的每一个参数：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725163947016.png" alt="image-20210725163947016" /></p>
<p><strong>this.resolvers.resolveArgument()</strong> ：在该方法内首先调用 <strong>getArgumentResolver()</strong> 方法获取到匹配的参数解析器（遍历每一个参数解析器，寻找到符合的），再调用匹配到的参数解析器的 <strong>resolveArgument()</strong> 方法解析当前参数：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212341993.png" alt="image-20210801212341993" /></p>
<p><strong>getArgumentResolver()</strong> 方法内遍历每一个参数解析器，寻找到匹配的参数解析器：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163420298-1627527227460.png" alt="image-20210724163420298" /></p>
<p>若支持当前参数，则使用该解析器解析参数，返回解析得到的参数<code>args[i]</code>。示例：获取要解析的参数名，并使用servlet原生API解析该值：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724165301621.png" alt="image-20210724165301621" /></p>
<p>遍历所有参数并解析后，得到<code>Object[] args</code>，接着调用 <strong>doInvoke(args)</strong> 执行目标方法，该方法返回<code>mavContainer</code>对象，其中保存<code>Model/Map</code>中的内容以及要跳转的视图名<code>viewName</code>，供后续返回值处理使用。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724161138834.png" alt="image-20210724161138834" /></p>
<p>至此目标方法执行完毕，得到了<code>mavContainer</code>对象用于后续的返回值处理操作【详细分析见<a href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86"><strong>数据响应与内容协商原理</strong></a>章节】</p>

        <h3 id="参数解析器argumentresolvers"   >
          <a href="#参数解析器argumentresolvers" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#参数解析器argumentresolvers"></a> 参数解析器：argumentResolvers</h3>
      
<p><strong>argumentResolvers</strong>内存储了所有Spring MVC支持的参数解析器，每个参数注解都对应了一个参数解析器，如 <strong>@RequestParam</strong> 注解对应<strong>RequestParamMethodArgumentResolver</strong>解析器：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724152930296.png" alt="image-20210724152930296" /></p>
<p>这些参数解析器都实现了<strong>HandlerMethodArgumentResolver</strong>接口，将首先调用<strong>supportsParameter()</strong> 方法判断是否能够解析传入的参数类型，若可以则执行<strong>参数解析方法resolveArgument()</strong> 解析参数：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724153442677.png" alt="image-20210724153442677" /></p>

        <h3 id="常用参数解析器"   >
          <a href="#常用参数解析器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#常用参数解析器"></a> 常用参数解析器</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725153449237.png" alt="image-20210725153449237" /></p>

        <h4 id="原生servlet-api解析器"   >
          <a href="#原生servlet-api解析器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#原生servlet-api解析器"></a> 原生Servlet-API解析器</h4>
      
<p><strong>ServletRequestMethodArgumentResolver</strong>用于解析原生的Servlet API，例如<strong>ServletRequest、HttpSession</strong>等：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725153121790.png" alt="image-20210725153121790" /></p>

        <h4 id="文件上传参数解析器"   >
          <a href="#文件上传参数解析器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#文件上传参数解析器"></a> 文件上传参数解析器</h4>
      
<p>文件上传参数解析器为<strong>RequestPartMethodArgumentResolver</strong>，该解析器重写的 <strong>supportParameter()</strong> 方法（其会判断当前参数是否标有 <strong>@RequestPart</strong> 注解）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801212958379.png" alt="image-20210801212958379" /></p>
<p>该解析器重写的 <strong>resolveArgument()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801213316328.png" alt="image-20210801213316328" /></p>
<p>返回的 <strong>Object mpArg</strong> 即为解析得到的<strong>MultipartFile</strong>类型的对象或数组：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210801214140507.png" alt="image-20210801214140507" /></p>
<p>解析参数时，将标注有 <strong>@RequestPart</strong> 注解的参数都存放到了一个 <strong>MultiValueMap&lt;String, MultipartFile&gt;</strong> 中，之后获取值的时候直接从该map中 <strong>get(name)</strong> 即可。</p>

        <h4 id="modelmap参数解析器"   >
          <a href="#modelmap参数解析器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#modelmap参数解析器"></a> Model/Map参数解析器</h4>
      
<p><code>Model</code>和<code>Map</code>的参数解析器在解析完毕后都会返回<strong>同一个BindingAwareModelMap</strong>对象，但此对象中还没有保存内容（<code>size=0</code>），因为此时目标方法还未执行，还没有向<code>Model/Map</code>中存放内容。在目标方法执行时才为其赋值，并保存到<strong>ModelAndViewContainer</strong>对象<code>mavContainer</code>中，其内容最终都会<strong>被保存到request域中</strong>。示例：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testMap&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">testMapParam</span><span class="params">(Map&lt;String, Object&gt; map,</span></span></span><br><span class="line"><span class="function"><span class="params">                           Model model,</span></span></span><br><span class="line"><span class="function"><span class="params">                           HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                           HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    map.put(<span class="string">&quot;map&quot;</span>, <span class="string">&quot;this is map&quot;</span>);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;model&quot;</span>, <span class="string">&quot;this is model&quot;</span>);</span><br><span class="line">    request.setAttribute(<span class="string">&quot;request&quot;</span>, <span class="string">&quot;this is request&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">&quot;cookie&quot;</span>, <span class="string">&quot;cookie&quot;</span>);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;forward:/success&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/success&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map <span class="title">success</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    Object mapValue = request.getAttribute(<span class="string">&quot;map&quot;</span>);</span><br><span class="line">    Object modelValue = request.getAttribute(<span class="string">&quot;model&quot;</span>);</span><br><span class="line">    Object requestValue = request.getAttribute(<span class="string">&quot;request&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;map&quot;</span>, mapValue);</span><br><span class="line">    map.put(<span class="string">&quot;model&quot;</span>, modelValue);</span><br><span class="line">    map.put(<span class="string">&quot;request&quot;</span>, requestValue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<hr />
<p>补充：使用<code>Map</code>，<code>Model</code>和<code>ModelMap</code>本质上是使用了Spring的<strong>BindingAwareModelMap</strong>在工作，相当于在<code>BindingAwareModelMap</code>中保存的数据<strong>都会放到请求域中</strong>。Spring MVC在运行时拥有唯一的一个<code>BindingAwareModelMap</code>对象，各个方法中获取到的<code>Map/ModelMap</code>都会被转换成同一个该对象，从而可以做到多个方法中的数据共享。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210715151056836.png" alt="image-20210715151056836" /></p>
<ol>
<li>Map解析器：<strong>MapMethodProcessor</strong></li>
</ol>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724163554136-1627531852946.png" alt="image-20210724163554136" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165354073.png" alt="image-20210725165354073" /></p>
<p>该解析器会从<strong>ModelAndViewContatiner</strong>对象中获取到<strong>BindingAwareModelMap</strong>对象。注意此时解析方法返回的<strong>BindingAwareModelMap</strong>对象中还没有保存内容（<code>size=0</code>），因为此时目标方法还未执行，还没有向<code>map</code>中存放属性值，将在后续赋值并将内容存放到<code>request</code>域中。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165951720.png" alt="image-20210725165951720" /></p>
<p><strong>ModelAndViewContatiner</strong>对象中的<strong>BindingAwareModelMap</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165001942.png" alt="image-20210725165001942" /></p>
<ol start="2">
<li>Model解析器：<strong>ModelMethodProcessor</strong></li>
</ol>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725164443575.png" alt="image-20210725164443575" /></p>
<p>该解析器逻辑与<code>Map</code>解析器相同，会返回同一个<strong>BindingAwareModelMap</strong>对象。</p>
<p>经过<code>Map</code>和<code>Model</code>解析器后，返回的两个<strong>BindingAwareModelMap</strong>对象是<strong>同一个对象</strong>，说明Spring MVC在运行时拥有<strong>唯一</strong>的一个<code>BindingAwareModelMap</code>对象，各个方法中获取到的<code>Model/Map/ModelMap</code>内容都会转换成同一个<code>BindingAwareModelMap</code>对象中，其内容最终都会被保存到<code>request</code>域中。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725165951720.png" alt="image-20210725165951720" /></p>

        <h4 id="pojo参数解析器"   >
          <a href="#pojo参数解析器" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#pojo参数解析器"></a> POJO参数解析器</h4>
      
<p>自定义类型参数使用<strong>ServletModelAttributeMethodProcessor</strong>参数解析器解析。其会先判断传入的参数是否是简单类型，自定义类型不是简单类型，因此黄色框整体返回true，该解析器将进行解析：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725210434816.png" alt="image-20210725210434816" /></p>
<p>简单类型如下：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725210610893.png" alt="image-20210725210610893" /></p>
<p>在解析时首先创建一个空的POJO组件（其内属性值都为Null），之后再将<code>request</code>域中的数据和POJO封装成一个<strong>WebDataBinder数据绑定器</strong>。该绑定器内有许多<strong>转换器Converters</strong>（见下文），用于将HTTP协议中的数据进行转换解析（例如将<code>String</code>转换成<code>Integer</code>）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725211316411.png" alt="image-20210725211316411" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725221333706.png" alt="image-20210725221333706" /></p>
<ul>
<li><strong>binderFactory.createBinder()</strong> 方法将<code>request</code>域中的值保存到POJO中，并封装返回了一个<strong>WebDataBinder</strong>类型变量，即<strong>web数据绑定器</strong>。该绑定器内不仅有POJO的所有属性，也有许多<strong>conversionService</strong>转换服务器（其内有许多<strong>converters</strong>转换器），<mark>用于将HTTP请求传来的数据进行解析转换（例如将String转换成Integer）</mark>。</li>
<li><strong>bindRequestParameters(binder, webRequest)</strong> 方法将解析转换后的值绑定到POJO的属性中。</li>
</ul>
<p><mark>即<strong>WebDataBinder</strong>利用它里面的<strong>converters</strong>将请求数据转换成指定的数据类型，并绑定到POJO属性中，从而完成了POJO的创建</mark></p>
<p><code>binder</code>中的内容：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725220853504.png" alt="image-20210725220853504" /></p>
<p>在绑定每一个属性值时，遍历所有的<code>Converter</code>转换当前属性，并将其绑定到POJO的属性上。解析完毕后返回该参数对象加入到<code>args[]</code>中，开发人员可以自定义<code>Converter</code>接口的实现类，实现自定义的参数解析功能：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725223637931.png" alt="image-20210725223637931" /></p>
<hr />
<p>补充：自定义<code>Converter</code>解析请求中的参数：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726140103808.png" alt="image-20210726140103808" /></p>
<hr />

        <h2 id="数据响应与内容协商原理"   >
          <a href="#数据响应与内容协商原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#数据响应与内容协商原理"></a> 数据响应与内容协商原理</h2>
      
<p>上一章<a href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><strong>参数解析原理</strong></a>分析了<strong>参数解析</strong>和<strong>目标方法执行</strong>的细节（下图中黄色框），本章将分析后续的数据响应与内容协商原理（处理目标方法返回值，下图中橙色框）：<strong>returnValueHandlers.handleReturnValue()</strong></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725171847138.png" alt="image-20210725171847138" /></p>
<p>在上一章节分析的目标方法执行完毕后，获得了<strong>ModelAndViewContainer</strong>类型的对象<code>mavContainer</code>，其内保存了要跳转的视图页面<code>viewName</code>和<code>Model/Map</code>中的内容。将该参数和返回值、<code>webRequest</code>参数传入到 <strong>returnValueHandlers.handleReturnValue()</strong> 方法中，下面详细分析该方法内的细节：</p>

        <h3 id="处理返回值handlereturnvalue"   >
          <a href="#处理返回值handlereturnvalue" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#处理返回值handlereturnvalue"></a> 处理返回值：handleReturnValue()</h3>
      
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726142110761.png" alt="image-20210726142110761" /></p>
<p>进入该方法后，首先调用<strong>selectHandler()</strong> 方法：遍历所有的<strong>返回值处理器returnValueHandlers</strong>判断哪个处理器能处理目标方法的返回值（使用 <strong>supportsReturnType()</strong> 方法）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726143359134.png" alt="image-20210726143359134" /></p>
<hr />

        <h4 id="返回值处理器returnvaluehandlers"   >
          <a href="#返回值处理器returnvaluehandlers" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#返回值处理器returnvaluehandlers"></a> 返回值处理器：returnValueHandlers</h4>
      
<p><strong>returnValueHandlers</strong>的作用为处理目标方法的返回值，不同的处理器用于处理不同类型的目标方法返回值</p>
<p>Spring MVC支持的返回值类型：</p>
<ul>
<li>ModelAndView</li>
<li>Model</li>
<li>View</li>
<li>ResponseEntity</li>
<li>ResponseBodyEmitter</li>
<li>StreamingResponseBody</li>
<li>HttpEntity</li>
<li>HttpHeaders</li>
<li>Callable</li>
<li>DeferredResult</li>
<li>ListenableFuture</li>
<li>CompletionStage</li>
<li>WebAsyncTask</li>
<li>标注了**@ModelAttribute**注解且为对象类型的</li>
<li>标注了**@ResponseBody<strong>注解，对应</strong>RequestResponseBodyMethodProcessor**</li>
</ul>
<p>每种类型都对应着一个返回值处理器<strong>returnValueHandler</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210724154755603.png" alt="image-20210724154755603" /></p>
<hr />
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726142110761.png" alt="image-20210726142110761" /></p>
<p>如果找到支持的返回值处理器，则执行其 <strong>handler.handleReturnValue()</strong> 方法。其中，<strong>handleReturnValue()</strong> 方法会根据返回值处理器<strong>handler</strong>类型的不同而执行不                                                                                                                                                                                                              同的重写方法：</p>
<ul>
<li>如果目标方法返回<code>String</code>类型对象，代表要跳转到某个页面</li>
<li>如果目标方法标注了 <strong>@ResponseBody</strong> 注解，则代表默认要返回JSON类型数据（也可以自定义其他类型</li>
</ul>
<p>下面逐一分析两种情况的细节。</p>

        <h3 id="1-目标方法返回string类型对象"   >
          <a href="#1-目标方法返回string类型对象" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#1-目标方法返回string类型对象"></a> 1. 目标方法返回String类型对象</h3>
      
<p>如果目标方法返回<code>String</code>类型对象，代表要跳转到某个页面。此时的返回值处理器类型为：<strong>ViewNameMethodReturnValueHandler</strong>。</p>
<p>此时返回值类型是字符串序列，则<code>handleReturnValue()</code>方法将要跳转的视图名<code>viewName</code>保存到了<strong>ModelAndViewContainer</strong>对象<code>mavContainer</code>中，此时其内既保存了<code>Model/Map</code>中的数据，又保存了要跳转的视图名<code>viewName</code>，之后会将该对象转换成一个<strong>ModelAndView</strong>对象，并利用其进行页面转发（见<mark>视图解析原理</mark>）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725193659805.png" alt="" /></p>

        <h3 id="2-目标方法标注了responsebody注解"   >
          <a href="#2-目标方法标注了responsebody注解" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#2-目标方法标注了responsebody注解"></a> 2. 目标方法标注了@ResponseBody注解</h3>
      
<p>如果目标方法标注了 <strong>@ResponseBody</strong> 注解，则代表默认要返回JSON类型数据（也可以自定义其他媒体类型）。此时返回值处理器为：<strong>RequestResponseBodyMethodProcessor</strong>。</p>
<p>该处理器将遍历所有的 <mark><strong>消息转换器MessageConverters</strong></mark>，使用匹配的消息转换器将数据转换成 <mark><strong>客户端指定的媒体类型格式</strong></mark> （如JSON/XML）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726160912631.png" alt="image-20210726160912631" /></p>
<p><strong>writeWithMessageConverters()</strong> ：使用消息转换器<strong>MessageConverters</strong>将返回值对象写成指定的媒体类型数据，此处以JSON举例（也可以自定义媒体类型）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726162256930.png" alt="image-20210726162256930" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210729210852492.png" alt="image-20210729210852492" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164955683.png" alt="image-20210727164955683" /></p>
<p>此情况大致执行流程：</p>
<ul>
<li>获取目标方法返回值对象</li>
<li>判断当前请求头（或者请求参数format属性值）是否已经有确定的<strong>媒体类型MediaType</strong></li>
<li><mark>获取客户端（包括浏览器，Postman）支持的媒体类型<strong>acceptableTypes</strong></mark>：获取客户端发来请求中请求头<code>Request Headers</code>里的<strong>Accept</strong>字段）：默认使用<strong>基于请求头</strong>的<strong>内容协商策略</strong>，从<code>Request Headers</code>中获取Accept里的内容，也可以自定义添加其他内容协商策略。具体细节见<a href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86">内容协商原理</a>和<a href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E7%AD%96%E7%95%A5">内容协商策略</a></li>
<li>根据返回值对象类型得到服务器端可生产的媒体类型<strong>produciableTypes</strong>：遍历所有的<strong>消息转换器HttpMessageConverter</strong>，<mark>判断当前的返回值对象类型能转换成什么类型的媒体类型<strong>produciableTypes</strong></mark></li>
<li><strong>双重循环</strong>，判断哪两个<strong>acceptableTypes</strong>和<strong>produciableTypes</strong>能最佳匹配，<mark>即寻找<strong>服务器端能提供的媒体类型</strong>和<strong>客户端能接收的媒体类型</strong>之间的最佳匹配</mark>，匹配到的<code>MediaType</code>即为返回值需要转换成的媒体类型【此过程即为<strong>内容协商</strong>，具体细节见<a href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86">内容协商原理</a>】</li>
<li>再次遍历所有的<strong>消息转换器HttpMessageConverter</strong>，判断哪个转换器能将当前的返回值类型转换成上文中<strong>匹配到的最佳媒体类型MediaType</strong>（如JSON/XML），在找到符合的转换器后，将其转换成指定的媒体类型。具体细节见<a href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%8E%9F%E7%90%86">消息转换原理</a></li>
</ul>

        <h3 id="内容协商原理"   >
          <a href="#内容协商原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容协商原理"></a> 内容协商原理</h3>
      
<p>内容协商：将<strong>客户端能接收的媒体数据类型</strong>和<strong>服务器能转换的媒体数据类型</strong>协商到二者能最佳匹配统一。从而<strong>根据客户端接收能力的不同</strong>，返回不同<strong>媒体类型MediaType</strong>的数据（例如JSON，XML，自定义类型等）。借助此原理，可以实现将不同客户端平台发来的数据转换成不同的媒体类型数据（例如PC端转换成JSON，手机端转换成XML，或转换成自定义类型等）。大致流程：</p>
<ul>
<li>判断当前响应头<code>Request Headers</code>（或者url请求参数<code>format</code>属性值）中是否已经有确定的<strong>媒体类型MediaType</strong>（如JSON/XML）</li>
<li>获取客户端（浏览器，Postman）支持的媒体类型<strong>acceptableTypes</strong>（获取客户端发来请求中<code>Request Headers</code>里的<strong>Accept</strong>字段）：默认使用<strong>基于请求头</strong>的<strong>内容协商策略</strong>，从<code>Request Headers</code>中获取<code>Accept</code>里的内容，也可以自定义添加其他内容协商策略。</li>
<li>遍历循环所有当前<strong>消息转换器HttpMessageConverters</strong>，看哪个支持转换当前返回值对象类型（<code>Person</code>），返回服务器端可以支持将返回值类型转换成的媒体类型<strong>producibleTypes</strong></li>
</ul>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100112607.png" alt="image-20210727100112607" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164303895.png" alt="image-20210727164303895" /></p>
<p>浏览器支持的媒体类型（在浏览器请求头信息里。默认XML类型权重更大）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100940697.png" alt="image-20210727100940697" /></p>
<p>这些媒体类型携带在浏览器的请求头信息里。<strong>请求头Request Headers</strong>告诉服务器，客户端具有接收什么类型数据的能力（<code>Accept</code>），其中XML媒体类型权重更大：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727094454018.png" alt="image-20210727094454018" /></p>
<blockquote>
<p>在使用Postman改变请求头中的<code>Accpet</code>字段后(Http协议中规定的字段)，服务器可以得知客户端可以接收的数据类型，就能根据客户端能够接收的媒体类型返回不同的数据格式。</p>
</blockquote>
<p>服务端针对当前类型<code>Person</code>能处理的媒体类型（默认只处理JSON媒体类型，开发人员也可以添加XML类型和自定义类型，具体分析见后文）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727101036395.png" alt="image-20210727101036395" /></p>
<p>之后进行内容协商：遍历<strong>acceptableTypes</strong>和<strong>producibleTypes</strong>，看哪两个能最佳匹配：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727101559706.png" alt="image-20210727101559706" /></p>
<p>在匹配到合适的转换器<code>Converter</code>后，就继续向下执行：</p>

        <h3 id="消息转换原理"   >
          <a href="#消息转换原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#消息转换原理"></a> 消息转换原理</h3>
      
<p>经过内容协商后，选出了客户端能接收的媒体类型<strong>selectedMediaType</strong>，之后根据该媒体类型和返回值对象类型遍历所有<strong>消息转换器HttpMessageConverter</strong>，判断哪个转换器<strong>能写canWrite()</strong> 当前对象，并使用其将返回值对象转换成指定的媒体类型<strong>selectedMediaType</strong>（例如JSON/XML）。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727164955683.png" alt="image-20210727164955683" /></p>
<p>注意：<strong>HttpMessageConverter</strong>先后使用了两次，第一次遍历所有的Converters，找到能处理客户端响应的最佳匹配媒体类型（此过程为内容协商），此时即知道了客户端能接收哪种媒体类型；第二次遍历所有的<code>Converters</code>，根据已经得知的媒体类型，判断哪个<code>Converter</code>能将目标方法返回值对象（Person）转换成该媒体类型，从而进行转换。</p>
<p>其中不同的<code>Converter</code>有不同的 <strong>write()</strong> 方法：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Person person, MediaType contentType, HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">    <span class="comment">// 数据的写出协议，不通过的Converter不同</span></span><br><span class="line">    String data = person.getName() + <span class="string">&quot;;&quot;</span> + person.getAge() + <span class="string">&quot;;&quot;</span> + person.getBirth();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将数据写出到浏览器中</span></span><br><span class="line">    OutputStream body = outputMessage.getBody();</span><br><span class="line">    body.write(data.getBytes());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="消息转换器httpmessageconverter"   >
          <a href="#消息转换器httpmessageconverter" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#消息转换器httpmessageconverter"></a> 消息转换器：HttpMessageConverter</h3>
      
<p><strong>消息转换器HttpMessageConverter</strong>：判断是否支持转换某类型的对象，并将其转成<strong>媒体类型MediaType</strong>类型的数据，例如将<code>Person</code>对象转换成JSON格式；或者将JSON格式转换成<code>Person</code>对象。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726190152432.png" alt="image-20210726190152432" /></p>
<p>容器中默认存在10个消息转换器，每个消息转换器都有自己支持的<strong>媒体类型MediaType</strong>，用来转换不同类型的返回值对象（此时容器中没有）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726190609377.png" alt="image-20210726190609377" /></p>
<ul>
<li>0 - 支持<code>Byte</code>类型</li>
<li>1 - 支持<code>String</code>类型</li>
<li>3 - 支持<code>Resource</code>类型</li>
<li>…</li>
<li>7 - 直接返回true，说明它可以处理任何类型的对象（用于将任意对象转换成JSON格式）</li>
</ul>
<p><strong>MappingJackson2HttpMessageConverter</strong>消息转换器放在最后使用，其 <strong>canWrite()</strong> 方法直接返回true，代表其<strong>可以处理任何类型</strong>的对象。该转换器可以将任意的引用类型对象转换成JSON类型（利用底层<code>jackson</code>的<strong>objectMapper</strong>转换）。其中<code>hb</code>属性中保存了转换后的JSON内容。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210726191949357.png" alt="image-20210726191949357" /></p>

        <h4 id="自定义httpmessageconverter"   >
          <a href="#自定义httpmessageconverter" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#自定义httpmessageconverter"></a> 自定义HttpMessageConverter</h4>
      
<p>所有的<strong>HttpMessageConverter</strong>合起来可以支持各种媒体类型的操作（读和写），开发人员可以自定义消息处理器：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageConverter</span> <span class="keyword">implements</span> <span class="title">HttpMessageConverter</span>&lt;<span class="title">Person</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canRead</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canWrite</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clazz.isAssignableFrom(Person.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务器需要统计所有MessageConverter都能写哪些类型；自定义的消息转换器支持解析 &quot;x-zhao&quot; 类型的内容</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MediaType.parseMediaTypes(<span class="string">&quot;application/x-zhao&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Person <span class="title">read</span><span class="params">(Class&lt;? extends Person&gt; clazz, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Person person, MediaType contentType, HttpOutputMessage outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">        <span class="comment">// 自定义协议数据的写出</span></span><br><span class="line">        String data = person.getName() + <span class="string">&quot;;&quot;</span> + person.getAge() + <span class="string">&quot;;&quot;</span> + person.getBirth();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将数据写出</span></span><br><span class="line">        OutputStream body = outputMessage.getBody();</span><br><span class="line">        body.write(data.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration()</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">webMvcConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="comment">// 在容器中添加自定义的消息转换器，用于转换自定义的媒体格式</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">extendMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class="line">                converters.add(<span class="keyword">new</span> MyMessageConverter());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h3 id="xml转换器mappingjackson2xmlhttpmessageconverter"   >
          <a href="#xml转换器mappingjackson2xmlhttpmessageconverter" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#xml转换器mappingjackson2xmlhttpmessageconverter"></a> XML转换器：MappingJackson2XmlHttpMessageConverter</h3>
      
<p>服务器端默认只能将客户端传来的数据转换成JSON媒体类型，若开发人员希望能够转换成其他类型的媒体数据（如XML或自定义类型数据），则可以向容器中添加相应的消息转换器。例如向容器中添加XML消息转换器：<strong>MappingJackson2XmlHttpMessageConverter</strong>，只需在<code>pom.xml</code>中添加依赖：</p>
<figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>此时XML消息转换器就会自动注入到容器中：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727145909685.png" alt="image-20210727145909685" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727150016279.png" alt="image-20210727150016279" /></p>
<p>在导入了XML消息转换器后，再次使用浏览器发送请求访问服务器端，此时服务器端可支持转换的媒体类型<strong>producibleTypes</strong>增加了XML类型和自定义类型（浏览器端可接收的媒体类型仍然不变）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730101533304.png" alt="image-20210730101533304" /></p>
<p>这是因为此时容器中有了XML消息转换器，即下图中的9和10（11为自定义的消息转换器）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730103255329.png" alt="image-20210730103255329" /></p>
<p>浏览器支持的媒体类型<strong>acceptableTypes</strong>（在浏览器请求头信息里。默认xml类型权重更大）：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727100940697.png" alt="image-20210727100940697" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730104019859.png" alt="image-20210730104019859" /></p>
<p>此时经过双重循环匹配<strong>acceptableTypes</strong>和<strong>producibleTypes</strong>后，得到的<strong>mediaTypesToUse</strong>集合的内容为：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210730103149685.png" alt="image-20210730103149685" /></p>
<p>此时已经将优先级权重体现了出来，橙色框内的XML类型优先级高于黄色框内的JSON类型，因此在后续寻找最佳匹配时，<strong>会匹配到XML类型的消息转换器</strong>。</p>
<p>接着第二次遍历消息转换器，遍历到XML消息转换器后，将目标方法返回值转换成XML类型。</p>
<p><strong>总结</strong>：如果在<code>pom.xml</code>中添加了XML转换器的依赖，则会将目标方法返回值解析成XML类型，因为浏览器发来的请求头信息中XML的权重更大；如果没有导入该依赖，则还是默认使用JSON转换器将返回值转换成JSON格式。</p>

        <h3 id="内容协商策略"   >
          <a href="#内容协商策略" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#内容协商策略"></a> 内容协商策略</h3>
      
<p>Spring MVC支持多种内容协商策略，例如：</p>
<ul>
<li>基于<strong>请求头Request Headers</strong>方式的内容协商策略</li>
<li>基于<strong>请求参数</strong>方式的内容协商策略</li>
</ul>
<p>上文中分析的内容协商策略均为基于<strong>请求头Request Headers</strong>方式的内容协商策略，此种策略下<strong>acceptableTypes</strong>是从客户端发来请求的<strong>请求头Request Headers</strong>信息获取到的。开发人员也可以选择基于<strong>请求参数</strong>方式的内容协商策略，这种策略下，<strong>acceptableTypes</strong>将从<strong>请求参数</strong>中的<strong>format</strong>属性中获取到。</p>
<p>开启基于请求参数的内容协商策略：</p>
<figure class="highlight yaml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">contentnegotiation:</span></span><br><span class="line">      <span class="attr">favor-parameter:</span> <span class="literal">true</span></span><br></pre></td></tr></table></div></figure>
<p>开启该注解后，即会在容器中创建<strong>基于请求参数</strong>方式的请求协商策略<strong>ParameterContentNegotiationStrategy</strong>，该策略会解析请求参数中的<strong>format</strong>属性值，判断是JSON还是XML，并据此进行内容协商。</p>
<blockquote>
<p>此时在浏览器中发送请求：<span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:8080/test/person?format=json" >http://localhost:8080/test/person?format=json</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> 或 <span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="http://localhost:8080/test/person?format=xml" >http://localhost:8080/test/person?format=xml</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
</blockquote>
<p><strong>getAcceptableMediaTypes()</strong> 方法内将使用内容协商管理器<strong>contentNegotiationManager</strong>解析媒体类型：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727141446187.png" alt="image-20210727141446187" /></p>
<p>若开启了<strong>基于请求参数</strong>方式的内容协商策略，则该管理器中将存在<strong>ParameterContentNegotiationStrategy</strong>策略，用于解析请求参数中的<code>format</code>属性值，该策略优先于默认的请求头协商策略<strong>HeaderContentNegotiationStrategy</strong>，即不再使用默认的解析请求头的方式。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727142409445.png" alt="image-20210727142409445" /></p>
<ul>
<li>0 - <strong>ParameterContentNegotiationStrategy</strong>：基于<strong>请求头Request Headers</strong>方式的内容协商策略</li>
<li>1 - <strong>HeaderContentNegotiationStrategy</strong>：基于<strong>请求参数</strong>方式的内容协商策略</li>
</ul>
<p><strong>注意，此策略只支持JSON和XML</strong>，如果想自定义新的格式，需要：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration()</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebMvcConfigurer <span class="title">webMvcConfigurer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WebMvcConfigurer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureContentNegotiation</span><span class="params">(ContentNegotiationConfigurer configurer)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 指定三种媒体类型映射关系</span></span><br><span class="line">                Map&lt;String, MediaType&gt; mediaTypes = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                mediaTypes.put(<span class="string">&quot;json&quot;</span>, MediaType.APPLICATION_JSON);</span><br><span class="line">                mediaTypes.put(<span class="string">&quot;xml&quot;</span>, MediaType.APPLICATION_XML);</span><br><span class="line">                mediaTypes.put(<span class="string">&quot;myFormat&quot;</span>, MediaType.parseMediaType(<span class="string">&quot;application/x-zhao&quot;</span>));</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 基于请求参数的内容协商策略：支持解析哪些参数对应哪些媒体类型</span></span><br><span class="line">                ParameterContentNegotiationStrategy parameterStrategy =</span><br><span class="line">                    <span class="keyword">new</span> ParameterContentNegotiationStrategy(mediaTypes);</span><br><span class="line">                <span class="comment">// 可以自定义请求参数的属性名</span></span><br><span class="line">                <span class="comment">// parameterStrategy.setParameterName(&quot;format&quot;);</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 基于请求头的内容协商策略</span></span><br><span class="line">                HeaderContentNegotiationStrategy headerStrategy = <span class="keyword">new</span> HeaderContentNegotiationStrategy();</span><br><span class="line"></span><br><span class="line">                configurer.strategies(Arrays.asList(parameterStrategy, headerStrategy));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h2 id="视图解析原理"   >
          <a href="#视图解析原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#视图解析原理"></a> 视图解析原理</h2>
      

        <h3 id="获取modelandview对象getmodelandview"   >
          <a href="#获取modelandview对象getmodelandview" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#获取modelandview对象getmodelandview"></a> 获取ModelAndView对象：getModelAndView()</h3>
      
<p><mark><strong>注意</strong>：此时的方法栈仍然处于<strong>主线3：ha.handle()</strong> 方法中</mark>。<strong>getModelAndView() <strong>方法为其内的最后一个方法，将返回</strong>ModelAndView</strong>对象<code>mv</code>用于后续的视图解析。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210727193857347.png" alt="image-20210727193857347" /></p>
<p><strong>getModelAndView()</strong> 方法内：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731203910807.png" alt="image-20210731203910807" /></p>
<p>之后该<strong>ModelAndView</strong>对象<code>mv</code>将作为 <strong>ha.handle()</strong> 方法的返回值，用于后续的视图解析。</p>
<p><mark>至此， <strong>主线3：ha.handle()</strong> 方法执行完毕。</mark></p>

        <h3 id="主线4-转发页面thisprocessdispatchresult"   >
          <a href="#主线4-转发页面thisprocessdispatchresult" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#主线4-转发页面thisprocessdispatchresult"></a> 主线4. 转发页面：this.processDispatchResult()</h3>
      
<p><strong>this.processDispatchResult()</strong>：根据目标方法最终执行完成后封装的<code>ModelAndView</code>对象内的信息转发到相应的页面（页面信息保存在<code>viewName</code>里），并且可以从请求域中取出<code>ModelAndView</code>中保存的数据。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731205850800.png" alt="image-20210731205850800" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725201730427.png" alt="image-20210725201730427" /></p>
<p>该方法内调用 <strong>render()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731210317048.png" alt="image-20210731210317048" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212421271.png" alt="image-20210731212421271" /></p>
<p>该方法调用 <strong>resolveViewName()</strong> 方法解析出该视图名对应的<strong>View</strong>类型对象，其定义了页面的渲染逻辑。之后将调用 <strong>view.render()</strong> 方法渲染页面。</p>
<p><strong>resolveViewName()</strong> 方法内遍历了所有的视图解析器，依次判断哪个能解析当前返回值，并使用匹配的解析器解析出<strong>View</strong>类型对象：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731210848419.png" alt="image-20210731210848419" /></p>
<p>共有5种视图解析器，其中<strong>ContentNegotiatingViewResovler内容协商视图解析器</strong>中包含了其他四种解析器：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731211417134.png" alt="image-20210731211417134" /></p>
<p><strong>ContentNegotiatingViewResovler内容协商视图解析器</strong>解析视图名的方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731211605005.png" alt="image-20210731211605005" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212028693.png" alt="image-20210731212028693" /></p>
<p>可以看出该方法内本质上还是依次遍历了其他四种视图解析器，判断哪个能解析当前视图名。</p>
<p>在遍历得到匹配的视图解析器后，将解析出对应的<strong>View</strong>类型对象，不同类型的返回值对应了不同的<strong>View</strong>类型对象：</p>
<ul>
<li><strong>&quot;redirect:xxx&quot;</strong> 对应 <strong>RedirectView</strong></li>
<li><strong>&quot;forward:xxx&quot;</strong> 对应 <strong>InternalResourceView</strong></li>
<li><strong>&quot;/xxx&quot;</strong>  对应 <strong>ThymeleafView</strong></li>
</ul>
<p>最后调用 <strong>view.render()</strong> 方法渲染页面。不同的View类型对应了不同的渲染方法。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210731212427561.png" alt="image-20210731212427561" /></p>
<p><strong>RedirectView</strong>类型渲染逻辑：</p>
<ul>
<li>获取要重定向的url地址，调用 <strong>response.sendRedirect(encodedURL)</strong> 方法进行重定向。</li>
</ul>
<p><strong>InternalResourceView</strong>类型渲染逻辑：</p>
<ul>
<li><strong>request.getRequestDispatcher(path).forward(request, response)</strong></li>
</ul>
<hr />
<p>补充：经过许多层调用后，在 <strong>exposeModelAsRequestAttributes()</strong> 方法内将前面<strong>ModelAndView</strong>里存放的值放到请求域中：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210725202336384.png" alt="image-20210725202336384" /></p>
<hr />
<p>至此，主线4分析完毕，完成了视图的解析与跳转。</p>

        <h2 id="异常处理原理"   >
          <a href="#异常处理原理" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#异常处理原理"></a> 异常处理原理</h2>
      
<p>异常处理自动配置类<strong>ErrorMvcAutoConfiguration</strong>。其会在Spring Boot启动时被加载，该配置类会向容器中注册一些异常处理相关的组件：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802215420259.png" alt="image-20210802215420259" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802164252572.png" alt="image-20210802164252572" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802190349481.png" alt="image-20210802190349481" /></p>
<p>该配置类向容器中注册的异常处理相关组件：</p>
<ul>
<li><strong>DefaultErrorAttributes</strong>：在request域中保存异常信息，定义错误页面里能包含哪些内容。实现了<strong>ErrorAttributes</strong>接口和<strong>HandlerExceptionResolver</strong>接口（也是一种处理器异常解析器，用于将错误信息保存到request域中，安达市多撒）。其内保存了错误的状态信息。【该类用于自定义错误页面包含哪些信息】</li>
<li><strong>BasicErrorController</strong>：处理异常错误消息的控制器，标注了 <strong>@Controller</strong> 注解。【该类用于进行异常错误消息的请求映射】
<ul>
<li>其用于处理默认的异常请求 <code>@RequestMapping(/error)</code>。</li>
<li>若是发浏览器端发来的<code>&quot;text/html&quot;</code>类型请求后，则返回一个 <code>new ModelAndView(&quot;error&quot;, model)</code></li>
<li>否则返回JSON类型的错误信息<code>ResponseEntity(body, status)</code></li>
</ul>
</li>
<li><strong>StaticView<code>(id=&quot;error&quot;)</code></strong>：错误页面视图，实现了<strong>View</strong>接口。其 <strong>render()</strong> 方法定义了页面渲染的逻辑（渲染出<strong>白页</strong>错误信息页面）【该类用于渲染出<strong>白页</strong>错误信息页面】</li>
<li><strong>BeanNameViewResolver</strong>：组件名称视图解析器，是视图解析器的一种。按照目标方法返回的视图名作为组件的id去容器中查找View对象。其用于按照组件名<code>&quot;error&quot;</code>去容器中查找到上述错误页面视图<strong>StaticView</strong>组件。【该类用于按照组件名称查找View对象】</li>
<li><strong>DefaultErrorViewResolver</strong>：错误视图解析器，是视图解析器的一种。如果浏览器发送的url请求出现错误，则会以HTTP的状态码<code>status.series()</code>作为视图页地址<code>viewName</code>，返回一个<strong>ModelAndView</strong>对象。去找<code>error/</code>目录下对应的<code>404.html</code> 或 <code>5xx.html</code> 资源。【该类用于自定义指定错误视图的跳转规则】</li>
</ul>
<p>白页是谁解析的</p>
<p>下面介绍这些组件的细节：</p>

        <h3 id="defaulterrorattributes"   >
          <a href="#defaulterrorattributes" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#defaulterrorattributes"></a> DefaultErrorAttributes</h3>
      
<p><strong>DefaultErrorAttributes</strong>：在request域中保存异常信息，定义错误页面里能包含哪些内容。实现了<strong>ErrorAttributes</strong>接口和<strong>HandlerExceptionResolver</strong>接口。</p>
<p>其内保存了错误的状态信息，并会在解析异常时调用 <strong>resolveException()</strong> 方法，<mark>将异常信息存储在request域中</mark>，并返回一个<code>null</code>的<strong>ModelAndView</strong>（此处分析见【异常处理执行流程】）。</p>
<p><mark><strong>该类最关键的作用</strong></mark>：在每个异常请求进来时首先使用该类进行解析，将异常信息保存在request域中，从而告诉服务器当前请求有异常，需要再次派发一个 <strong><code>&quot;/error&quot;</code></strong> 请求给<strong>DispatchServlet</strong>，该请求中保存了所有的异常信息，因此响应这个 <strong><code>&quot;/error&quot;</code></strong> 请求时就可以获取到了完整的异常信息，交给<strong>DefaultErrorViewResolver</strong>解析该异常请求。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205927018.png" alt="image-20210802205927018" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802191937364.png" alt="image-20210802191937364" /></p>

        <h3 id="basicerrorcontroller"   >
          <a href="#basicerrorcontroller" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#basicerrorcontroller"></a> BasicErrorController</h3>
      
<p><strong>BasicErrorController</strong>：处理异常消息的控制器，标注了 <strong>@Controller</strong> 注解。</p>
<p>当服务器端收到错误的url请求时==，将触==发<code>&quot;/error&quot;</code>，此时Spring MVC会将此请求映射到控制器<strong>BasicErrorController</strong>的 <strong>errorHtml()</strong> 方法或 <strong>error()</strong> 方法。</p>
<p><strong>情况一</strong>：若此请求的媒体类型为<code>&quot;text/html&quot;</code>，则将执行 <strong>errorHtml()</strong> 方法，该方法将返回一个 <code>viewName=&quot;error&quot;</code> 的<strong>ModelAndView</strong>。之后在视图解析步骤中将使用<strong>BeanNameViewResolver</strong>（组件名称视图解析器）去容器中查找<code>viewName</code>为<code>&quot;error&quot;</code>的<strong>View</strong>，并调用其<strong>render()</strong> 渲染出<strong>白页</strong>错误信息页面。（此种情况就解释了为什么在浏览器端访问了错误的url后会显示“白页”） DefaultViewErrorResolver还是 beanname</p>
<p><strong>情况二</strong>：若请求来自于非浏览器的其他机器，则将返回JSON类型的错误信息。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802213620722.png" alt="image-20210802213620722" /></p>

        <h3 id="staticview"   >
          <a href="#staticview" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#staticview"></a> StaticView</h3>
      
<p><strong>StaticView</strong>实现了<strong>View</strong>接口，也是一种视图。其 <strong>render()</strong> 方法将渲染出<strong>白页</strong>错误信息页面：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802192305382.png" alt="image-20210802192305382" /></p>

        <h3 id="beannameviewresolver"   >
          <a href="#beannameviewresolver" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#beannameviewresolver"></a> BeanNameViewResolver</h3>
      
<p><strong>BeanNameViewResolver</strong>：组件名称视图解析器，是视图解析器的一种。其会按照目标方法返回的视图名作为组件的id去容器中查找View对象。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802185022754.png" alt="image-20210802185022754" /></p>
<p><strong>BasicErrorController.errorHtml()</strong> 方法返回了<code>viewName=&quot;error&quot;</code>的视图<strong>StaticView</strong>。该解析器会按照组件名<code>&quot;error&quot;</code>去容器中查找到该<code>StaticView</code>组件，找到该组件后调用其 <strong>render()</strong> 方法渲染出<strong>白页</strong>错误信息页面</p>

        <h3 id="defaulterrorviewresolver"   >
          <a href="#defaulterrorviewresolver" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#defaulterrorviewresolver"></a> DefaultErrorViewResolver</h3>
      
<p><strong>DefaultErrorViewResolver</strong>：错误视图解析器，是视图解析器的一种。如果浏览器发送的url请求出现错误，则会以HTTP的状态码<code>status.series()</code>作为视图页地址<code>viewName</code>，返回一个<strong>ModelAndView</strong>对象。去找<code>error/</code>目录下对应的<code>404.html</code> 或 <code>5xx.html</code> 资源。</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802191120478.png" alt="image-20210802191120478" /></p>

        <h3 id="异常处理执行流程"   >
          <a href="#异常处理执行流程" class="heading-link"><i class="fas fa-link"></i></a><a class="markdownIt-Anchor" href="#异常处理执行流程"></a> 异常处理执行流程</h3>
      
<p>在 <strong>doDispatch(request, response)</strong> 方法中，目标方法的执行过程中出现的任何异常，都会被<strong>dispatchException</strong>捕获到：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802201853375.png" alt="image-20210802201853375" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802212022373.png" alt="image-20210802212022373" /></p>
<p>之后进入视图解析 <strong>processDispatchResult()</strong> ：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802202538535.png" alt="image-20210802202538535" /></p>
<p>关键分析 <strong>processHandlerException()</strong> 方法，该方法内处理了异常消息，并返回了一个<strong>ModelAndView</strong>对象。该方法内遍历了容器中存在的所有<strong>处理器异常解析器HandlerExceptionResolver</strong>，判断哪一个能处理当前异常：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802204759380.png" alt="image-20210802204759380" /></p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802211043922.png" alt="image-20210802211043922" /></p>
<p>循环过程中，直到某个解析器解析异常后返回的<strong>exMv</strong>不为<code>null</code>，才跳出循环，默认没有任何解析器能够解析出exMv，异常将被抛出回 <strong>processDispatchResult()</strong> 所在的方法栈。该异常被catch后，将倒序执行<strong>mappedHandler</strong>中所有已执行过的拦截器的 <strong>afterCompletion()</strong> 方法：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802212022373.png" alt="image-20210802212022373" /></p>
<p>此时，当前带有异常的请求的执行流程分析完毕，此时并没有进行页面跳转等操作。接着，Spring MVC的底层将发送一个url为<code>&quot;/error&quot;</code>的请求，该请求将由<strong>BasicErrorController</strong>处理（见上文分析）</p>
<hr />
<p>容器中默认存在的处理器异常解析器有：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205006071.png" alt="image-20210802205006071" /></p>
<p>其中0 - <strong>DefaultErrorAttributes</strong> 即为之前分析过的<strong>默认错误解析器</strong>：</p>
<p><strong>DefaultErrorAttributes</strong>：定义错误页面里能包含哪些内容。实现了<strong>ErrorAttributes</strong>接口和<strong>HandlerExceptionResolver</strong>接口。</p>
<p>其内保存了错误的状态信息，并会在解析异常时调用 <strong>resolveException()</strong> 方法，<mark>将异常信息存储在request域中</mark>，并返回一个<code>null</code>的<strong>ModelAndView</strong>：</p>
<p><img src="/images/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/image-20210802205927018.png" alt="image-20210802205927018" /></p>
<hr />
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://yuyun-zhao.github.io">yuyun zhao</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://yuyun-zhao.github.io/2021/07/12/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">http://yuyun-zhao.github.io/2021/07/12/%E3%80%90SpringBoot%E3%80%91SpringBoot2-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/Spring/">Spring</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://yuyun-zhao.github.io/tags/Spring-Boot/">Spring Boot</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2021/07/13/%E3%80%90SpringMVC%E3%80%91SpringMVC-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">【Spring MVC】Spring MVC 源码分析</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2021/07/05/%E3%80%90Spring%E3%80%91Spring5-%E4%BA%8B%E5%8A%A1%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><span class="paginator-prev__text">【Spring】Spring5 事务源码分析</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86"><span class="toc-text">
           自动配置原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86"><span class="toc-text">
           依赖管理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC"><span class="toc-text">
           自定义依赖版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%90%AF%E5%8A%A8%E5%99%A8"><span class="toc-text">
           场景启动器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E5%90%AF%E5%8A%A8%E5%99%A8starter%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">
           场景启动器starter工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E5%8E%9F%E7%90%86-2"><span class="toc-text">
           自动配置原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-springbootconfiguration"><span class="toc-text">
           1、@SpringBootConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-componentscan"><span class="toc-text">
           2、@ComponentScan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-enableautoconfiguration"><span class="toc-text">
           3、@EnableAutoConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">
           总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%8E%9F%E7%90%86"><span class="toc-text">
           静态资源原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#webmvcautoconfigurationadapter"><span class="toc-text">
           WebMvcAutoConfigurationAdapter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E8%B7%AF%E5%BE%84%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86"><span class="toc-text">
           资源路径映射原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AC%A2%E8%BF%8E%E9%A1%B5%E7%9A%84%E5%A4%84%E7%90%86%E8%A7%84%E5%88%99"><span class="toc-text">
           欢迎页的处理规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rest-%E6%98%A0%E5%B0%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">
           Rest 映射实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hiddenhttpmethodfilter%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">
           HiddenHttpMethodFilter源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%B5%8C-servlet-%E5%AE%B9%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">
           内嵌 Servlet 容器工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E6%8D%A2servlet%E5%AE%B9%E5%99%A8"><span class="toc-text">
           切换Servlet容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6servlet%E5%AE%B9%E5%99%A8"><span class="toc-text">
           定制Servlet容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E5%8E%9F%E7%90%86"><span class="toc-text">
           定制化原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#spring-boot%E5%AE%9A%E5%88%B6%E5%8C%96%E7%9A%84%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F"><span class="toc-text">
           Spring Boot定制化的四种方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%8C%96%E5%8E%9F%E7%90%86-2"><span class="toc-text">
           定制化原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-boot-%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-text">
           Spring Boot 启动原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA-springapplication"><span class="toc-text">
           创建 SpringApplication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8Cspringapplicationrun"><span class="toc-text">
           运行SpringApplication.run()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E7%BB%84%E4%BB%B6"><span class="toc-text">
           自定义事件监听组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#spring-mvc-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">
           Spring MVC 执行流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dispatcherservlet"><span class="toc-text">
           DispatcherServlet</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8tomcat%E4%B8%AD%E6%B3%A8%E5%86%8Cdispatcherservlet"><span class="toc-text">
           在Tomcat中注册DispatcherServlet</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8E%9F%E7%90%86"><span class="toc-text">
           文件上传原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%85%E8%A3%85%E5%8E%9F%E5%A7%8B%E8%AF%B7%E6%B1%82thischeckmultipartrequest"><span class="toc-text">
           包装原始请求：this.checkMultipart(request)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9"><span class="toc-text">
           解析文件内容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%98%A0%E5%B0%84%E5%8E%9F%E7%90%86"><span class="toc-text">
           请求映射原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF1-%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%A4%84%E7%90%86%E5%99%A8thisgethandler"><span class="toc-text">
           主线1. 获取请求处理器：this.getHandler()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF2-%E8%8E%B7%E5%8F%96%E7%9B%AE%E6%A0%87%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E9%80%82%E9%85%8D%E5%99%A8thisgethandleradapter"><span class="toc-text">
           主线2. 获取目标处理器的适配器：this.getHandlerAdapter()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">
           拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF3-%E4%BD%BF%E7%94%A8%E9%80%82%E9%85%8D%E5%99%A8%E6%89%A7%E8%A1%8C%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95hahandle"><span class="toc-text">
           主线3. 使用适配器执行目标方法：ha.handle()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><span class="toc-text">
           参数解析原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E5%8F%82%E6%95%B0getmethodargumentvalues"><span class="toc-text">
           解析参数：getMethodArgumentValues()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8argumentresolvers"><span class="toc-text">
           参数解析器：argumentResolvers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">
           常用参数解析器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%94%9Fservlet-api%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">
           原生Servlet-API解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">
           文件上传参数解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#modelmap%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">
           Model&#x2F;Map参数解析器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pojo%E5%8F%82%E6%95%B0%E8%A7%A3%E6%9E%90%E5%99%A8"><span class="toc-text">
           POJO参数解析器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E4%B8%8E%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86"><span class="toc-text">
           数据响应与内容协商原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E8%BF%94%E5%9B%9E%E5%80%BChandlereturnvalue"><span class="toc-text">
           处理返回值：handleReturnValue()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC%E5%A4%84%E7%90%86%E5%99%A8returnvaluehandlers"><span class="toc-text">
           返回值处理器：returnValueHandlers</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E8%BF%94%E5%9B%9Estring%E7%B1%BB%E5%9E%8B%E5%AF%B9%E8%B1%A1"><span class="toc-text">
           1. 目标方法返回String类型对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%9B%AE%E6%A0%87%E6%96%B9%E6%B3%95%E6%A0%87%E6%B3%A8%E4%BA%86responsebody%E6%B3%A8%E8%A7%A3"><span class="toc-text">
           2. 目标方法标注了@ResponseBody注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E5%8E%9F%E7%90%86"><span class="toc-text">
           内容协商原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%8E%9F%E7%90%86"><span class="toc-text">
           消息转换原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E8%BD%AC%E6%8D%A2%E5%99%A8httpmessageconverter"><span class="toc-text">
           消息转换器：HttpMessageConverter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89httpmessageconverter"><span class="toc-text">
           自定义HttpMessageConverter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xml%E8%BD%AC%E6%8D%A2%E5%99%A8mappingjackson2xmlhttpmessageconverter"><span class="toc-text">
           XML转换器：MappingJackson2XmlHttpMessageConverter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%8D%8F%E5%95%86%E7%AD%96%E7%95%A5"><span class="toc-text">
           内容协商策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%86%E5%9B%BE%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86"><span class="toc-text">
           视图解析原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96modelandview%E5%AF%B9%E8%B1%A1getmodelandview"><span class="toc-text">
           获取ModelAndView对象：getModelAndView()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E7%BA%BF4-%E8%BD%AC%E5%8F%91%E9%A1%B5%E9%9D%A2thisprocessdispatchresult"><span class="toc-text">
           主线4. 转发页面：this.processDispatchResult()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%8E%9F%E7%90%86"><span class="toc-text">
           异常处理原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#defaulterrorattributes"><span class="toc-text">
           DefaultErrorAttributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basicerrorcontroller"><span class="toc-text">
           BasicErrorController</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#staticview"><span class="toc-text">
           StaticView</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#beannameviewresolver"><span class="toc-text">
           BeanNameViewResolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defaulterrorviewresolver"><span class="toc-text">
           DefaultErrorViewResolver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-text">
           异常处理执行流程</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/author.png" alt="avatar"></div><p class="sidebar-ov-author__text">no code no life</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/YUYUN-ZHAO" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a><a class="sidebar-ov-social-item" href="zyy1024462136" target="_blank" rel="noopener" data-popover="微信" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-weixin"></i></span></a><a class="sidebar-ov-social-item" href="1024462136" target="_blank" rel="noopener" data-popover="QQ" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-qq"></i></span></a><a class="sidebar-ov-social-item" href="mailto:im.yuyunzhao@gmail.com" target="_blank" rel="noopener" data-popover="social.Gmail" data-popover-pos="up"><span class="sidebar-ov-social-item__icon">Gmail</span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">102</div><div class="sidebar-ov-state-item__name">文章</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">35</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">35</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>yuyun zhao</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.xml';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" rel="stylesheet" type="text/css"><link href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.css" rel="stylesheet" type="text/css"><script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/copy-tex.min.js"></script><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.xml"></script></body></html>